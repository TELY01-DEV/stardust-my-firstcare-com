<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="version" content="{{ range(1, 1000) | random }}" />
    <title>Opera-GodEye Panel - Kati Transaction Monitor</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='PRIMARY_MFC_LOGO_EN.svg') }}">
    <link rel="alternate icon" href="{{ url_for('static', filename='PRIMARY_MFC_LOGO_EN.svg') }}">
    
    <!-- CSS files -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css?v={{ range(1, 1000) | random }}" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons@2.40.0/iconfont/tabler-icons.min.css?v={{ range(1, 1000) | random }}" rel="stylesheet"/>
    
    <!-- Socket.IO client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js?v={{ range(1, 1000) | random }}"></script>
    
    <style>
        /* MFC Theme Palette */
        :root {
            --mfc-blue: #024F96;
            --mfc-light-blue: #00A1E8;
            --mfc-accent-blue: #92E3FF;
            --mfc-red: #EC1C24;
            --mfc-dark-red: #981F15;
            --mfc-gray: #D0D2D3;
            --mfc-white: #fff;
        }
        
        /* Mobile-First Responsive Design */
        @media (max-width: 768px) {
            .container-xl {
                padding-left: 10px;
                padding-right: 10px;
            }
            
            .page-header {
                padding: 1rem 0;
            }
            
            .page-title {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }
            
            .btn-list {
                flex-direction: column;
                gap: 0.5rem;
                width: 100%;
            }
            
            .btn-list .btn {
                width: 100%;
                margin-bottom: 0.25rem;
            }
            
            .btn-group {
                width: 100%;
            }
            
            .btn-group .btn {
                flex: 1;
                font-size: 0.8rem;
                padding: 0.5rem 0.25rem;
            }
            
            .stats-cards .col-sm-6 {
                margin-bottom: 1rem;
            }
            
            .stat-card {
                padding: 1.5rem 1rem;
            }
            
            .stat-number {
                font-size: 1.8rem;
            }
            
            .stat-label {
                font-size: 0.8rem;
            }
            
            .table-responsive {
                font-size: 0.8rem;
            }
            
            .table th,
            .table td {
                padding: 0.5rem 0.25rem;
                font-size: 0.75rem;
            }
            
            .navbar-brand {
                font-size: 1.2rem;
            }
            
            .navbar-nav .nav-link {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
            
            .emergency-stat-card {
                min-height: 200px;
            }
            
            .emergency-content-wrapper {
                padding: 1.5rem 1rem 1rem;
            }
            
            .emergency-number {
                font-size: 2.5rem;
            }
            
            .emergency-number-shadow {
                font-size: 2.5rem;
            }
            
            .emergency-breakdown {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .breakdown-item {
                justify-content: center;
            }
            
            .emergency-details {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }
            
            .emergency-status,
            .emergency-trend {
                width: 100%;
                text-align: center;
            }
        }
        
        @media (max-width: 576px) {
            .page-header .col-auto {
                width: 100%;
                margin-top: 1rem;
            }
            
            .page-header .row {
                flex-direction: column;
            }
            
            .emergency-stat-card {
                min-height: 180px;
            }
            
            .emergency-content-wrapper {
                padding: 1rem 0.75rem 0.75rem;
            }
            
            .emergency-number {
                font-size: 2rem;
            }
            
            .emergency-number-shadow {
                font-size: 2rem;
            }
            
            .emergency-icon-ring {
                width: 50px;
                height: 50px;
            }
            
            .emergency-icon-ring i {
                font-size: 1.2rem;
            }
            
            .emergency-badge .badge {
                font-size: 0.5rem;
                padding: 0.3rem 0.6rem;
            }
            
            .ribbon-content {
                font-size: 0.7rem;
                gap: 6px;
            }
            
            .emergency-label {
                font-size: 0.8rem;
            }
            
            .breakdown-item {
                padding: 0.75rem;
            }
            
            .breakdown-icon {
                width: 28px;
                height: 28px;
            }
            
            .breakdown-content {
                font-size: 0.8rem;
            }
        }
        
        @media (max-width: 480px) {
            .container-xl {
                padding-left: 5px;
                padding-right: 5px;
            }
            
            .page-title {
                font-size: 1.3rem;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
            
            .emergency-number {
                font-size: 1.8rem;
            }
            
            .emergency-number-shadow {
                font-size: 1.8rem;
            }
            
            .emergency-content-wrapper {
                padding: 0.75rem 0.5rem 0.5rem;
            }
            
            .emergency-icon-ring {
                width: 40px;
                height: 40px;
            }
            
            .emergency-icon-ring i {
                font-size: 1rem;
            }
            
            .emergency-header {
                margin-bottom: 1rem;
            }
            
            .emergency-main {
                margin-bottom: 0.75rem;
            }
            
            .emergency-breakdown {
                padding: 0.75rem;
                margin-top: 0.75rem;
            }
            
            .breakdown-item {
                padding: 0.5rem;
            }
            
            .breakdown-icon {
                width: 24px;
                height: 24px;
            }
            
            .breakdown-content {
                font-size: 0.75rem;
            }
        }
        
        /* Touch-friendly interactions for mobile */
        @media (hover: none) and (pointer: coarse) {
            .card:hover {
                transform: none;
            }
            
            .emergency-stat-card:hover {
                transform: none;
            }
            
            .emergency-stat-card:active {
                transform: scale(0.98);
            }
            
            .btn:active {
                transform: scale(0.95);
            }
            
            .breakdown-item:active {
                transform: scale(0.95);
            }
        }
        
        /* Landscape orientation adjustments */
        @media (max-width: 768px) and (orientation: landscape) {
            .page-header {
                padding: 0.5rem 0;
            }
            
            .stats-cards {
                margin-bottom: 1rem;
            }
            
            .emergency-stat-card {
                min-height: 160px;
            }
            
            .emergency-content-wrapper {
                padding: 1rem 0.75rem 0.75rem;
            }
            
            .emergency-number {
                font-size: 2rem;
            }
            
            .emergency-number-shadow {
                font-size: 2rem;
            }
        }
        
        /* Mobile table enhancements */
        @media (max-width: 768px) {
            .table-responsive {
                border: none;
            }
            
            .table th {
                white-space: nowrap;
                min-width: 80px;
            }
            
            .table td {
                vertical-align: middle;
            }
            
            .data-value {
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            .topic-badge {
                font-size: 0.65rem;
                padding: 0.15rem 0.3rem;
            }
            
            .status-badge {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
            }
            
            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 576px) {
            .table th,
            .table td {
                padding: 0.4rem 0.2rem;
                font-size: 0.7rem;
            }
            
            .data-value {
                max-width: 80px;
                font-size: 0.7rem;
            }
            
            .topic-badge {
                font-size: 0.6rem;
                padding: 0.1rem 0.25rem;
            }
            
            .status-badge {
                font-size: 0.65rem;
                padding: 0.15rem 0.3rem;
            }
            
            .btn-sm {
                padding: 0.2rem 0.4rem;
                font-size: 0.7rem;
            }
        }
        
        /* Mobile modal enhancements */
        @media (max-width: 768px) {
            .modal-dialog {
                margin: 0.5rem;
            }
            
            .modal-body {
                padding: 1rem;
            }
            
            .modal-footer {
                padding: 0.75rem 1rem;
            }
            
            .modal-footer .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
                    .modal-footer .btn:last-child {
            margin-bottom: 0;
        }
    }
    
    /* Sleep Data Analysis Styles */
    .sleep-stat {
        text-align: center;
        padding: 1rem;
        border-radius: 8px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
        border: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .sleep-stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .sleep-stat-label {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
    
    .sleep-stat-percentage {
        font-size: 1.1rem;
        font-weight: 600;
        color: #495057;
    }
    
    .quality-metric {
        text-align: center;
        padding: 1rem;
        border-radius: 8px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
        border: 1px solid rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
    }
    
    .quality-label {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }
    
    .quality-value {
        font-size: 1.3rem;
        font-weight: 700;
        color: #495057;
    }
    
    .sleep-pattern-container {
        overflow-x: auto;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    /* Purple-themed Comprehensive Sleep Pattern Styles */
    .sleep-purple-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .sleep-main-panel {
        background: linear-gradient(135deg, #f8f4ff 0%, #f0e6ff 100%);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 8px 24px rgba(147, 51, 234, 0.1);
        border: 1px solid rgba(147, 51, 234, 0.1);
        display: flex;
        gap: 2rem;
    }
    
    .sleep-quality-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1.5rem;
        min-width: 200px;
    }
    
    .sleep-quality-indicator {
        position: relative;
        width: 120px;
        height: 120px;
    }
    
    .circular-progress {
        position: relative;
        width: 100%;
        height: 100%;
    }
    
    .progress-ring {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 8px solid #e9d5ff;
        position: absolute;
    }
    
    .progress-fill {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 8px solid transparent;
        border-top: 8px solid #9333ea;
        border-right: 8px solid #9333ea;
        position: absolute;
        transform: rotate(calc(var(--progress) * 3.6deg - 90deg));
        transition: transform 1s ease;
    }
    
    .progress-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }
    
    .quality-score {
        font-size: 1.5rem;
        font-weight: 700;
        color: #9333ea;
    }
    
    .sleep-summary {
        text-align: center;
    }
    
    .quality-text {
        font-size: 1.2rem;
        font-weight: 600;
        color: #9333ea;
        margin-bottom: 0.5rem;
    }
    
    .duration-text {
        font-size: 1rem;
        color: #7c3aed;
        font-weight: 500;
    }
    
    .sleep-charts-section {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        flex: 1;
    }
    
    .sleep-stages-chart,
    .sleep-duration-chart {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .chart-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #6b7280;
        margin-bottom: 1rem;
        text-align: center;
    }
    
    .chart-container {
        display: flex;
        align-items: flex-end;
        gap: 0.5rem;
        height: 80px;
        position: relative;
    }
    
    .chart-y-axis {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        font-size: 0.7rem;
        color: #9ca3af;
        margin-right: 0.5rem;
        height: 100%;
    }
    
    .chart-bars {
        display: flex;
        align-items: flex-end;
        gap: 0.25rem;
        flex: 1;
        height: 100%;
    }
    
    .chart-bar {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        height: 100%;
    }
    
    .bar-fill {
        width: 100%;
        background: linear-gradient(180deg, #9333ea 0%, #7c3aed 100%);
        border-radius: 4px 4px 0 0;
        min-height: 4px;
        transition: height 0.5s ease;
    }
    
    .duration-bar {
        background: linear-gradient(180deg, #a855f7 0%, #9333ea 100%);
    }
    
    .white-bar {
        background: linear-gradient(180deg, #ffffff 0%, #f3f4f6 100%);
        border: 1px solid #e5e7eb;
    }
    
    .purple-bar {
        background: linear-gradient(180deg, #9333ea 0%, #7c3aed 100%);
    }
    
    .bar-label {
        font-size: 0.7rem;
        color: #6b7280;
        margin-top: 0.5rem;
        font-weight: 500;
    }
    
    .sleep-side-panels {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .sleep-duration-card,
    .sleep-quality-card {
        background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(124, 58, 237, 0.2);
        color: white;
    }
    
    .card-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    .card-header i {
        color: #c4b5fd;
    }
    
    .card-chart {
        display: flex;
        align-items: flex-end;
        gap: 0.25rem;
        height: 60px;
    }
    
    .card-chart .chart-y-axis {
        color: #c4b5fd;
    }
    
    .sleep-timeline-section {
        grid-column: 1 / -1;
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid #f3f4f6;
    }
    
    .timeline-header {
        margin-bottom: 1.5rem;
    }
    
    .timeline-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1rem;
        font-weight: 600;
        color: #374151;
        margin: 0;
    }
    
    .timeline-title i {
        color: #9333ea;
    }
    
    /* Purple sleep stage colors */
    .sleep-awake-purple {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        border: 1px solid #f59e0b;
    }
    
    .sleep-light-purple {
        background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
        border: 1px solid #9333ea;
    }
    
    .sleep-deep-purple {
        background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        border: 1px solid #6d28d9;
    }
    
    .sleep-unknown-purple {
        background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
        border: 1px solid #6b7280;
    }
    
    .sleep-detailed-breakdown {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid #f3f4f6;
    }
    
    .breakdown-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        background: #f9fafb;
        border-radius: 8px;
        border: 1px solid #f3f4f6;
        transition: all 0.2s ease;
    }
    
    .breakdown-item:hover {
        background: #f3f4f6;
        transform: translateX(2px);
    }
    
    .breakdown-bar {
        width: 60px;
        height: 12px;
        border-radius: 6px;
        position: relative;
        overflow: hidden;
        background: #e5e7eb;
    }
    
    .breakdown-fill {
        height: 100%;
        border-radius: 6px;
        transition: width 0.3s ease;
    }
    
    .sleep-awake-purple .breakdown-fill {
        background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%);
        width: 100%;
    }
    
    .sleep-light-purple .breakdown-fill {
        background: linear-gradient(90deg, #a855f7 0%, #9333ea 100%);
        width: 100%;
    }
    
    .sleep-deep-purple .breakdown-fill {
        background: linear-gradient(90deg, #7c3aed 0%, #6d28d9 100%);
        width: 100%;
    }
    
    /* Legacy modern styles for backward compatibility */
    .sleep-modern-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border: 1px solid #f0f0f0;
    }
    
    .sleep-header {
        margin-bottom: 1.5rem;
    }
    
    .sleep-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
        cursor: pointer;
        transition: color 0.2s ease;
    }
    
    .sleep-title:hover {
        color: var(--mfc-blue);
    }
    
    .sleep-title i:first-child {
        margin-right: 0.5rem;
        color: var(--mfc-blue);
    }
    
    .sleep-title i:last-child {
        color: #bdc3c7;
        font-size: 0.9rem;
    }
    
    .sleep-timeline-modern {
        margin-bottom: 2rem;
    }
    
    .timeline-labels {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
        padding: 0 0.5rem;
    }
    
    .time-label {
        font-size: 0.75rem;
        color: #7f8c8d;
        font-weight: 500;
        text-align: center;
        flex: 1;
    }
    
    .sleep-pattern-modern {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        border: 1px solid #e9ecef;
        position: relative;
    }
    
    .sleep-row {
        display: flex;
        gap: 2px;
        margin-bottom: 2px;
        align-items: center;
        height: 20px;
    }
    
    .sleep-row:last-child {
        margin-bottom: 0;
    }
    
    .sleep-block-modern {
        height: 16px;
        border-radius: 3px;
        transition: all 0.3s ease;
        cursor: pointer;
        flex: 1;
        min-width: 8px;
        position: relative;
    }
    
    .sleep-block-modern:hover {
        transform: scale(1.2);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        z-index: 10;
    }
    
    .sleep-empty-modern {
        background: transparent;
        border: 1px dashed #e9ecef;
        cursor: default;
    }
    
    .sleep-empty-modern:hover {
        transform: none;
        box-shadow: none;
    }
    
    /* Modern sleep stage colors */
    .sleep-awake-modern {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        border: 1px solid #ff5252;
    }
    
    .sleep-light-modern {
        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        border: 1px solid #74b9ff;
    }
    
    .sleep-deep-modern {
        background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
        border: 1px solid #2d3436;
    }
    
    .sleep-unknown-modern {
        background: linear-gradient(135deg, #b2bec3 0%, #95a5a6 100%);
        border: 1px solid #b2bec3;
    }
    
    /* Sleep breakdown section */
    .sleep-breakdown {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .breakdown-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        transition: all 0.2s ease;
    }
    
    .breakdown-item:hover {
        background: #f1f3f4;
        transform: translateX(2px);
    }
    
    .breakdown-bar {
        width: 60px;
        height: 12px;
        border-radius: 6px;
        position: relative;
        overflow: hidden;
        background: #e9ecef;
    }
    
    .breakdown-fill {
        height: 100%;
        border-radius: 6px;
        transition: width 0.3s ease;
    }
    
    .sleep-awake-modern .breakdown-fill {
        background: linear-gradient(90deg, #ff6b6b 0%, #ee5a52 100%);
        width: 100%;
    }
    
    .sleep-light-modern .breakdown-fill {
        background: linear-gradient(90deg, #74b9ff 0%, #0984e3 100%);
        width: 100%;
    }
    
    .sleep-deep-modern .breakdown-fill {
        background: linear-gradient(90deg, #2d3436 0%, #636e72 100%);
        width: 100%;
    }
    
    .sleep-typical {
        background: #e9ecef;
        border: 1px solid #dee2e6;
    }
    
    .sleep-typical .breakdown-fill {
        background: repeating-linear-gradient(
            45deg,
            #bdc3c7,
            #bdc3c7 2px,
            #95a5a6 2px,
            #95a5a6 4px
        );
        width: 100%;
    }
    
    .breakdown-info {
        display: flex;
        flex-direction: column;
        flex: 1;
    }
    
    .breakdown-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.25rem;
    }
    
    .breakdown-percentage {
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--mfc-blue);
        margin-bottom: 0.1rem;
    }
    
    .breakdown-duration {
        font-size: 0.8rem;
        color: #7f8c8d;
    }
    
    /* Legacy styles for backward compatibility */
    .sleep-timeline-container {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .sleep-timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }
    
    .timeline-label {
        font-size: 1.1rem;
        font-weight: 600;
        color: #495057;
    }
    
    .timeline-period {
        font-size: 0.9rem;
        color: #6c757d;
        background: #f8f9fa;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        border: 1px solid #dee2e6;
    }
    
    .sleep-timeline {
        position: relative;
        margin-bottom: 1rem;
    }
    
    .timeline-hours {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        padding: 0 0.5rem;
    }
    
    .hour-marker {
        font-size: 0.75rem;
        color: #6c757d;
        font-weight: 500;
        text-align: center;
        flex: 1;
    }
    
    .sleep-pattern-timeline {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 1rem;
        border: 1px solid #e9ecef;
    }
    
    .hour-row {
        display: flex;
        gap: 1px;
        margin-bottom: 1px;
        align-items: center;
    }
    
    .hour-row:last-child {
        margin-bottom: 0;
    }
    
    .sleep-block {
        width: 12px;
        height: 16px;
        border-radius: 2px;
        transition: all 0.3s ease;
        cursor: pointer;
        flex: 1;
        min-width: 12px;
    }
    
    .sleep-block:hover {
        transform: scale(1.3);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        z-index: 10;
        position: relative;
    }
    
    .sleep-empty {
        background: transparent;
        border: 1px dashed #dee2e6;
        cursor: default;
    }
    
    .sleep-empty:hover {
        transform: none;
        box-shadow: none;
    }
    
    .sleep-legend {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        color: #495057;
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    /* Legacy sleep pattern styles for backward compatibility */
    .sleep-pattern {
        display: flex;
        flex-wrap: wrap;
        gap: 2px;
        min-height: 40px;
        align-items: center;
    }
    
    .sleep-awake {
        background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        border: 1px solid #d39e00;
    }
    
    .sleep-light {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        border: 1px solid #117a8b;
    }
    
    .sleep-deep {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        border: 1px solid #004085;
    }
    
    .sleep-unknown {
        background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
        border: 1px solid #4e555b;
    }
    
    .recommendation-item {
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid;
        background: rgba(255, 255, 255, 0.8);
        margin-bottom: 1rem;
    }
    
    .recommendation-item i {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }
    
    .recommendation-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 1rem;
    }
    
    .recommendation-message {
        font-size: 0.9rem;
        line-height: 1.4;
    }
    
    .data-label {
        font-size: 0.8rem;
        color: #6c757d;
        font-weight: 500;
        margin-bottom: 0.25rem;
    }
    
    .data-value {
        font-size: 1rem;
        font-weight: 600;
        color: #495057;
    }
    
    /* Improved Sleep Pattern Visualization Styles */
    .sleep-improved-container {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #f0f0f0;
    }
    
    /* Sleep Overview Section */
    .sleep-overview-section {
        display: flex;
        align-items: center;
        gap: 2rem;
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
        border-radius: 12px;
        border: 1px solid #e8f0ff;
    }
    
    .sleep-quality-circle {
        flex-shrink: 0;
    }
    
    .quality-circle {
        position: relative;
        width: 120px;
        height: 120px;
        border-radius: 50%;
    }
    
    .circle-background {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: #e9ecef;
        border: 8px solid #f8f9fa;
    }
    
    .circle-progress {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 8px solid transparent;
        border-top: 8px solid #007bff;
        border-right: 8px solid #007bff;
        transform: rotate(calc(var(--progress) * 3.6deg - 90deg));
        transition: transform 1s ease;
    }
    
    .circle-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }
    
    .quality-number {
        font-size: 2rem;
        font-weight: 700;
        color: #007bff;
        line-height: 1;
    }
    
    .quality-label {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .sleep-summary-info {
        display: flex;
        gap: 2rem;
        flex: 1;
    }
    
    .summary-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid #e9ecef;
    }
    
    .summary-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .summary-text {
        display: flex;
        flex-direction: column;
    }
    
    .summary-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: #212529;
        line-height: 1.2;
    }
    
    .summary-label {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    /* Weekly Trends Section */
    .weekly-trends-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 12px;
        border: 1px solid #e9ecef;
    }
    
    .trends-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .trends-header h6 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: #212529;
    }
    
    .trends-legend {
        display: flex;
        gap: 1rem;
    }
    
    .trends-legend .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .trends-legend .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
    }
    
    .quality-color {
        background: #007bff;
    }
    
    .duration-color {
        background: #28a745;
    }
    
    .trends-chart {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
        height: 120px;
    }
    
    .trend-day {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        gap: 0.5rem;
    }
    
    .day-bars {
        display: flex;
        gap: 2px;
        align-items: flex-end;
        height: 80px;
        width: 100%;
    }
    
    .quality-bar {
        width: 50%;
        background: #007bff;
        border-radius: 2px 2px 0 0;
        min-height: 4px;
        transition: height 0.3s ease;
    }
    
    .duration-bar {
        width: 50%;
        background: #28a745;
        border-radius: 2px 2px 0 0;
        min-height: 4px;
        transition: height 0.3s ease;
    }
    
    .day-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: #495057;
    }
    
    .day-values {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.7rem;
        color: #6c757d;
    }
    
    /* Sleep Stages Section */
    .sleep-stages-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 12px;
        border: 1px solid #e9ecef;
    }
    
    .stages-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .stages-header h6 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: #212529;
    }
    
    .stages-legend {
        display: flex;
        gap: 1rem;
    }
    
    .stages-legend .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .stages-legend .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
    }
    
    .awake-color {
        background: #ffc107;
    }
    
    .light-color {
        background: #17a2b8;
    }
    
    .deep-color {
        background: #6f42c1;
    }
    
    .stages-breakdown {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .stage-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid #e9ecef;
    }
    
    .stage-bar {
        height: 20px;
        border-radius: 10px;
        min-width: 60px;
        transition: width 0.3s ease;
    }
    
    .stage-info {
        display: flex;
        flex-direction: column;
        flex: 1;
    }
    
    .stage-name {
        font-size: 0.9rem;
        font-weight: 600;
        color: #212529;
        margin-bottom: 0.25rem;
    }
    
    .stage-details {
        display: flex;
        gap: 1rem;
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .stage-percentage {
        font-weight: 600;
        color: #495057;
    }
    
    /* Timeline Section */
    .sleep-timeline-section {
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 12px;
        border: 1px solid #e9ecef;
    }
    
    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .timeline-header h6 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: #212529;
    }
    
    .timeline-info {
        display: flex;
        gap: 1rem;
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .timeline-container {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        border: 1px solid #e9ecef;
    }
    
    .timeline-hours {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
        padding: 0 0.5rem;
    }
    
    .hour-marker {
        font-size: 0.75rem;
        color: #6c757d;
        font-weight: 500;
        text-align: center;
        flex: 1;
    }
    
    .timeline-visualization {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 1rem;
        border: 1px solid #e9ecef;
    }
    
    .timeline-hour {
        display: flex;
        gap: 1px;
        margin-bottom: 1px;
        align-items: center;
        height: 24px;
    }
    
    .timeline-hour:last-child {
        margin-bottom: 0;
    }
    
    .timeline-block {
        height: 20px;
        border-radius: 3px;
        transition: all 0.3s ease;
        cursor: pointer;
        flex: 1;
        min-width: 8px;
        position: relative;
    }
    
    .timeline-block:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        z-index: 10;
    }
    
    .empty-block {
        background: transparent;
        border: 1px dashed #e9ecef;
        cursor: default;
    }
    
    .empty-block:hover {
        transform: none;
        box-shadow: none;
    }
    
    .awake-stage {
        background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);
        border: 1px solid #ffb300;
    }
    
    .light-stage {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        border: 1px solid #138496;
    }
    
    .deep-stage {
        background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
        border: 1px solid #5a32a3;
    }
    
    .unknown-stage {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        border: 1px solid #5a6268;
    }
    
    .timeline-legend {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e9ecef;
    }
    
    .timeline-legend .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        color: #495057;
    }
    
    .timeline-legend .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    /* Mobile responsive sleep data */
    @media (max-width: 768px) {
        .sleep-improved-container {
            padding: 1rem;
        }
        
        .sleep-overview-section {
            flex-direction: column;
            gap: 1.5rem;
            padding: 1rem;
        }
        
        .sleep-summary-info {
            flex-direction: column;
            gap: 1rem;
        }
        
        .summary-item {
            padding: 0.75rem;
        }
        
        .trends-header {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }
        
        .trends-chart {
            height: 100px;
        }
        
        .day-bars {
            height: 60px;
        }
        
        .stages-header {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }
        
        .timeline-header {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }
        
        .timeline-hours {
            font-size: 0.7rem;
        }
        
        .timeline-block {
            height: 16px;
            min-width: 6px;
        }
        
        .timeline-legend {
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
        }
        
        /* Legacy purple container styles */
        .sleep-purple-container {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .sleep-main-panel {
            flex-direction: column;
            padding: 1.5rem;
            gap: 1.5rem;
        }
        
        .sleep-quality-section {
            min-width: auto;
        }
        
        .sleep-quality-indicator {
            width: 100px;
            height: 100px;
        }
        
        .quality-score {
            font-size: 1.3rem;
        }
        
        .quality-text {
            font-size: 1.1rem;
        }
        
        .duration-text {
            font-size: 0.9rem;
        }
        
        .chart-container {
            height: 60px;
        }
        
        .chart-title {
            font-size: 0.8rem;
        }
        
        .chart-y-axis {
            font-size: 0.6rem;
        }
        
        .bar-label {
            font-size: 0.6rem;
        }
        
        .sleep-duration-card,
        .sleep-quality-card {
            padding: 1rem;
        }
        
        .card-header {
            font-size: 0.8rem;
        }
        
        .card-chart {
            height: 50px;
        }
        
        .sleep-timeline-section {
            padding: 1rem;
        }
        
        .timeline-title {
            font-size: 0.9rem;
        }
        
        .timeline-labels {
            font-size: 0.7rem;
        }
        
        .time-label {
            font-size: 0.65rem;
        }
        
        .sleep-pattern-modern {
            padding: 1rem;
        }
        
        .sleep-block-modern {
            height: 12px;
            min-width: 6px;
        }
        
        .breakdown-item {
            padding: 0.5rem;
            gap: 0.75rem;
        }
        
        .breakdown-bar {
            width: 50px;
            height: 10px;
        }
        
        .breakdown-label {
            font-size: 0.85rem;
        }
        
        .breakdown-percentage {
            font-size: 0.8rem;
        }
        
        .breakdown-duration {
            font-size: 0.75rem;
        }
        
        /* Legacy modern styles */
        .sleep-modern-container {
            padding: 1rem;
        }
        
        .sleep-title {
            font-size: 1rem;
        }
        
        /* Legacy timeline styles */
        .sleep-timeline-container {
            padding: 1rem;
        }
        
        .sleep-timeline-header {
            flex-direction: column;
            gap: 0.5rem;
            text-align: center;
        }
        
        .timeline-hours {
            font-size: 0.7rem;
        }
        
        .hour-marker {
            font-size: 0.65rem;
        }
        
        .sleep-pattern-timeline {
            padding: 0.75rem;
        }
        
        .sleep-block {
            width: 8px;
            height: 12px;
            min-width: 8px;
        }
        
        .sleep-legend {
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
        }
        
        .legend-item {
            font-size: 0.8rem;
        }
        
        .sleep-pattern {
            gap: 1px;
        }
        
        .sleep-stat-number {
            font-size: 1.2rem;
        }
        
        .quality-value {
            font-size: 1.1rem;
        }
        
        .recommendation-item {
            padding: 0.75rem;
        }
    }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        .connection-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .connection-connected { background-color: #28a745; }
        .connection-connecting { background-color: #ffc107; }
        .connection-disconnected { background-color: #dc3545; }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .btn {
            border-radius: 8px;
            font-weight: 600;
        }
        
        .form-select {
            border-radius: 8px;
        }
        
        .table th {
            border-top: none;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 600;
        }
        .status-success { background-color: #d1e7dd; color: #0f5132; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        .status-warning { background-color: #fff3cd; color: #856404; }
        .status-info { background-color: #d1ecf1; color: #0c5460; }
        .status-emergency { background-color: #f8d7da; color: #721c24; font-weight: bold; }
        
        .topic-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
            border-radius: 0.2rem;
            font-weight: 500;
            background-color: #e9ecef;
            color: #495057;
        }
        
        .data-value {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 0.2rem;
            border: 1px solid #dee2e6;
        }
        
        .refresh-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .table-responsive {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .stats-cards {
            margin-bottom: 2rem;
        }
        
        .stat-card {
            text-align: center;
            padding: 1rem;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--mfc-blue);
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.875rem;
        }
        
        /* Ultra-Enhanced Emergency SOS Card Styles */
        .emergency-stat-card {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 30%, #a71e2a 60%, #8b1a1a 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 0;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 12px 40px rgba(220, 53, 69, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            min-height: 240px;
            backdrop-filter: blur(10px);
        }
        
        .emergency-stat-card:hover {
            transform: translateY(-12px) scale(1.03);
            box-shadow: 
                0 20px 60px rgba(220, 53, 69, 0.7),
                0 0 0 2px rgba(255, 255, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        .emergency-stat-card:active {
            transform: translateY(-6px) scale(1.02);
        }
        
        /* Emergency Ribbon */
        .emergency-ribbon {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(90deg, #ff4757 0%, #ff3742 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            clip-path: polygon(0 0, 100% 0, 95% 100%, 5% 100%);
        }
        
        .ribbon-content {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 0.8rem;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .ribbon-content i {
            animation: emergency-blink 1.5s infinite;
        }
        
        .emergency-content-wrapper {
            padding: 2rem 1.5rem 1.5rem;
            position: relative;
            z-index: 5;
        }
        
        .emergency-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 3;
        }
        
        .emergency-icon-container {
            position: relative;
        }
        
        .emergency-icon-ring {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.1) 70%, transparent 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: icon-pulse 2s infinite;
        }
        
        .emergency-icon-ring i {
            font-size: 1.5rem;
            color: #fff;
            animation: emergency-blink 1.5s infinite;
        }
        
        @keyframes icon-pulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }
        
        @keyframes emergency-blink {
            0%, 50% { opacity: 0.9; }
            51%, 100% { opacity: 0.4; }
        }
        
        .emergency-badge-container {
            position: relative;
        }
        
        .emergency-badge {
            transform: rotate(15deg);
            position: relative;
        }
        
        .emergency-badge .badge {
            font-size: 0.6rem;
            font-weight: 800;
            letter-spacing: 1px;
            padding: 0.4rem 0.8rem;
            border: 2px solid rgba(255, 255, 255, 0.4);
            animation: badge-pulse 2s infinite;
            text-transform: uppercase;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .emergency-badge .badge::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ff4757, #ff3742, #ff4757);
            border-radius: inherit;
            z-index: -1;
            animation: badge-glow 2s infinite;
        }
        
        @keyframes badge-pulse {
            0%, 100% { transform: rotate(15deg) scale(1); }
            50% { transform: rotate(15deg) scale(1.15); }
        }
        
        @keyframes badge-glow {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .emergency-content {
            position: relative;
            z-index: 2;
        }
        
        .emergency-main {
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .emergency-number-container {
            position: relative;
            display: inline-block;
        }
        
        .emergency-number {
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: 0.25rem;
            text-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
            background: linear-gradient(45deg, #fff 0%, #ffe6e6 50%, #ffd700 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 2;
            animation: number-glow 3s infinite;
        }
        
        .emergency-number-shadow {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 3.5rem;
            font-weight: 900;
            color: rgba(0, 0, 0, 0.3);
            z-index: 1;
        }
        
        @keyframes number-glow {
            0%, 100% { filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5)); }
            50% { filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.8)); }
        }
        
        .emergency-label {
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0.95;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .emergency-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 0.75rem;
        }
        
        .emergency-status {
            background: rgba(255, 255, 255, 0.15);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .emergency-trend {
            background: rgba(255, 193, 7, 0.2);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        
        .emergency-breakdown {
            display: flex;
            justify-content: space-around;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.1) 100%);
            border-radius: 16px;
            padding: 1rem;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 1rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .breakdown-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .breakdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .breakdown-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.1) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .breakdown-icon i {
            font-size: 0.9rem;
            color: #fff;
        }
        
        .breakdown-content {
            text-align: left;
        }
        
        .breakdown-label {
            display: block;
            font-size: 0.65rem;
            font-weight: 600;
            opacity: 0.9;
            margin-bottom: 0.2rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .breakdown-value {
            display: block;
            font-size: 1.2rem;
            font-weight: 800;
            color: #ffd700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            animation: value-pulse 2s infinite;
        }
        
        @keyframes value-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .emergency-pulse {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.05) 70%, transparent 100%);
            border-radius: 50%;
            animation: emergency-pulse 3s infinite;
            z-index: 1;
        }
        
        .emergency-pulse::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.15) 0%, transparent 70%);
            border-radius: 50%;
            animation: emergency-pulse-inner 2s infinite;
        }
        
        @keyframes emergency-pulse {
            0% {
                transform: translate(-50%, -50%) scale(0.6);
                opacity: 0.8;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0.4;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.8);
                opacity: 0;
            }
        }
        
        @keyframes emergency-pulse-inner {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0.6;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }
        
        .emergency-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.15) 0%, rgba(200, 35, 51, 0.15) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.4s ease;
            z-index: 15;
            border-radius: 20px;
            backdrop-filter: blur(5px);
        }
        
        .emergency-stat-card:hover .emergency-overlay {
            opacity: 1;
        }
        
        .overlay-content {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.8) 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            transform: translateY(15px) scale(0.9);
            transition: all 0.4s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        
        .emergency-stat-card:hover .overlay-content {
            transform: translateY(0) scale(1);
        }
        
        .overlay-icon {
            font-size: 1.2rem;
            color: #ffd700;
            animation: overlay-icon-pulse 2s infinite;
        }
        
        @keyframes overlay-icon-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* Emergency Sound Indicator */
        .emergency-sound-indicator {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.1) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 10;
            animation: sound-pulse 1.5s infinite;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .emergency-sound-indicator:hover {
            transform: scale(1.1);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.2) 100%);
        }
        
        .emergency-sound-indicator i {
            font-size: 1rem;
            color: #fff;
        }
        
        @keyframes sound-pulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
        }
        
        /* Emergency Details Modal Styles */
        .emergency-details-modal .modal-content {
            border: none;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .emergency-details-modal .modal-header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }
        
        .emergency-details-modal .modal-title {
            font-weight: 600;
        }
        
        .emergency-alert-item {
            background: #fff5f5;
            border-left: 4px solid #dc3545;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .emergency-alert-item:hover {
            background: #ffe6e6;
            transform: translateX(5px);
        }
        
        .emergency-alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .emergency-alert-time {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .emergency-alert-type {
            background: #dc3545;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .emergency-alert-patient {
            font-weight: 600;
            color: #dc3545;
            margin-bottom: 0.5rem;
        }
        
        .emergency-alert-location {
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .emergency-alert {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            animation: emergency-pulse 1s infinite;
        }
        
        @keyframes emergency-pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }
        
        .data-label {
            font-size: 0.875rem;
            color: #6c757d;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .location-source-badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
        }
        
        .medical-info-section {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.375rem;
        }
        
        .contact-info-section {
            background-color: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.375rem;
        }
        
        .hospital-info-section {
            background-color: #e2e3e5;
            border-left: 4px solid #6c757d;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.375rem;
        }
    
    /* Hypnogram Chart Styles */
    .hypnogram-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .hypnogram-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #212529;
        text-align: center;
        margin-bottom: 1.5rem;
    }
    
    .hypnogram-chart {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .hypnogram-y-axis {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        width: 60px;
        padding: 0.5rem 0;
    }
    
    .stage-label {
        font-size: 0.85rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        text-align: center;
        color: white;
        min-height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .deep-label {
        background: #6f42c1;
    }
    
    .light-label {
        background: #17a2b8;
    }
    
    .awake-label {
        background: #ffc107;
        color: #212529;
    }
    
    .hypnogram-main {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .hypnogram-timeline {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 1rem;
        border: 1px solid #e9ecef;
        height: 80px;
        display: flex;
        align-items: center;
        gap: 1px;
        overflow-x: auto;
    }
    
    .timeline-block {
        height: 20px;
        border-radius: 2px;
        flex: 1;
        min-width: 4px;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }
    
    .timeline-block:hover {
        transform: scaleY(1.2);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        z-index: 10;
    }
    
    .sleep-awake-purple {
        background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);
        border: 1px solid #ffb300;
    }
    
    .sleep-light-purple {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        border: 1px solid #138496;
    }
    
    .sleep-deep-purple {
        background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
        border: 1px solid #5a32a3;
    }
    
    .sleep-unknown-purple {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        border: 1px solid #5a6268;
    }
    
    .hypnogram-x-axis {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
        color: #6c757d;
        font-weight: 500;
    }
    
    .hypnogram-legend {
        display: flex;
        justify-content: center;
        gap: 2rem;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }
    
    .hypnogram-legend .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        color: #495057;
    }
    
    .hypnogram-legend .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    /* Mobile responsive hypnogram */
    @media (max-width: 768px) {
        .hypnogram-container {
            padding: 1rem;
        }
        
        .hypnogram-chart {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .hypnogram-y-axis {
            flex-direction: row;
            width: 100%;
            justify-content: space-around;
        }
        
        .stage-label {
            font-size: 0.75rem;
            min-height: 20px;
            padding: 0.2rem 0.4rem;
        }
        
        .hypnogram-timeline {
            height: 60px;
            padding: 0.75rem;
        }
        
        .timeline-block {
            height: 16px;
            min-width: 3px;
        }
        
        .hypnogram-x-axis {
            font-size: 0.7rem;
            padding: 0.25rem 0.75rem;
        }
        
        .hypnogram-legend {
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
        }
    }
    
    .time-marker {
        font-size: 0.75rem;
        color: #6c757d;
        font-weight: 500;
        text-align: center;
        flex: 1;
    }
    
    /* Vital Signs Cards */
    .vital-sign-card {
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        min-height: 180px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .vital-sign-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }
    
    .vital-sign-icon {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        opacity: 0.9;
    }
    
    .vital-sign-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .vital-sign-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }
    
    .vital-sign-unit {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-bottom: 0.5rem;
    }
    
    .vital-sign-label {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .vital-sign-status {
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .vital-sign-range {
        font-size: 0.75rem;
        opacity: 0.8;
    }
    
    /* Mobile responsive vital signs cards */
    @media (max-width: 768px) {
        .vital-sign-card {
            padding: 1rem;
            min-height: 140px;
        }
        
        .vital-sign-icon {
            font-size: 2rem;
        }
        
        .vital-sign-value {
            font-size: 1.5rem;
        }
        
        .vital-sign-label {
            font-size: 0.9rem;
        }
        
        .vital-sign-status {
            font-size: 0.8rem;
        }
        
        .vital-sign-range {
            font-size: 0.7rem;
        }
    }
    
    @media (max-width: 576px) {
        .vital-sign-card {
            padding: 0.75rem;
            min-height: 120px;
        }
        
        .vital-sign-icon {
            font-size: 1.5rem;
        }
        
        .vital-sign-value {
            font-size: 1.25rem;
        }
        
        .vital-sign-label {
            font-size: 0.8rem;
        }
        
        .vital-sign-status {
            font-size: 0.75rem;
        }
        
        .vital-sign-range {
            font-size: 0.65rem;
        }
    }
    </style>
</head>
<body>
    <div class="page">
        <!-- Tabler Navbar -->
        <header class="navbar navbar-expand-md navbar-dark d-print-none" style="background: var(--mfc-blue);">
            <div class="container-xl">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <a class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3" href="/">
                    <img src="{{ url_for('static', filename='LOGO_MFC_EN.png') }}" alt="MFC Logo" style="height:40px;vertical-align:middle;margin-right:10px;">
                    Opera-GodEye Panel
                </a>
                <div class="navbar-nav flex-row order-md-last">
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown">
                            <span class="avatar avatar-sm">
                                <img src="{{ url_for('static', filename='user_profiles/admin.png') }}" alt="Admin">
                            </span>
                            <div class="d-none d-xl-block ps-2">
                                <div>Kati Transaction Monitor</div>
                                <div class="mt-n1">
                                    <span class="connection-indicator connection-connecting" id="connection-status"></span>
                                    <small id="connection-text">Connecting...</small>
                                </div>
                            </div>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                            <a href="/" class="dropdown-item">
                                <i class="ti ti-home me-2"></i>
                                Main Dashboard
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="/logout" class="dropdown-item">
                                <i class="ti ti-logout me-2"></i>
                                Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Navbar Menu -->
        <div class="navbar-expand-md">
            <div class="collapse navbar-collapse" id="navbar-menu">
                <div class="navbar navbar-light">
                    <div class="container-xl">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link" href="/">
                                    <i class="ti ti-dashboard me-2"></i>
                                    Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/messages">
                                    <i class="ti ti-message-circle me-2"></i>
                                    Messages
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/emergency">
                                    <i class="ti ti-alert-triangle me-2"></i>
                                    Emergency Alerts
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/devices">
                                    <i class="ti ti-devices me-2"></i>
                                    Devices
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/patients">
                                    <i class="ti ti-users me-2"></i>
                                    Patients
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/data-flow">
                                    <i class="ti ti-activity me-2"></i>
                                    Data Flow Monitor
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/medical-monitor">
                                    <i class="ti ti-heartbeat me-2"></i>
                                    Medical Monitor
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/event-log">
                                    <i class="ti ti-list me-2"></i>
                                    Event Log
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/event-streaming">
                                    <i class="ti ti-broadcast me-2"></i>
                                    Live Stream
                                </a>
                            </li>
                            <li class="nav-item active">
                                <a class="nav-link" href="/kati-transaction">
                                    <i class="ti ti-device-watch me-2"></i>
                                    Kati Transaction
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Page header -->
        <div class="page-header d-print-none">
            <div class="container-xl">
                <div class="row g-2 align-items-center">
                    <div class="col">
                        <h2 class="page-title">
                            <i class="ti ti-device-watch text-primary"></i>
                            <span class="d-none d-sm-inline">Kati Watch Transaction Monitor</span>
                            <span class="d-inline d-sm-none">Kati Monitor</span>
                        </h2>
                        <div class="text-muted mt-1 d-none d-md-block">Real-time monitoring of Kati Watch data processing</div>
                        <div class="text-muted small">
                            <i class="ti ti-clock"></i>
                            <span class="d-none d-sm-inline">Real-time monitoring</span>
                            <span class="d-inline d-sm-none">Live</span>
                        </div>
                    </div>
                    <div class="col-auto ms-auto d-print-none">
                        <div class="btn-list">
                            <!-- Data Filter Toggle -->
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="data-filter" id="patient-only" value="patient_only" checked>
                                <label class="btn btn-outline-primary" for="patient-only">
                                    <i class="ti ti-user"></i>
                                    <span class="d-none d-md-inline">Patient Data Only</span>
                                    <span class="d-inline d-md-none">Patients</span>
                                </label>
                                
                                <input type="radio" class="btn-check" name="data-filter" id="all-devices" value="all_devices">
                                <label class="btn btn-outline-secondary" for="all-devices">
                                    <i class="ti ti-devices"></i>
                                    <span class="d-none d-md-inline">All Device Data</span>
                                    <span class="d-inline d-md-none">All</span>
                                </label>
                            </div>
                            
                            <button class="btn btn-primary" onclick="loadKatiData()">
                                <i class="ti ti-refresh"></i>
                                <span class="d-none d-sm-inline">Refresh</span>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="toggleAutoRefresh()">
                                <i class="ti ti-clock" id="auto-refresh-icon"></i>
                                <span id="auto-refresh-text" class="d-none d-md-inline">Auto Refresh</span>
                                <span class="d-inline d-md-none">Auto</span>
                            </button>
                            <div class="btn btn-outline-info">
                                <i class="ti ti-wifi"></i>
                                <span id="header-connection-status" class="d-none d-sm-inline">Connecting...</span>
                                <span class="d-inline d-sm-none">...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Page body -->
        <div class="page-body">
            <div class="container-xl">
                <!-- Statistics Cards -->
                <div class="row stats-cards">
                    <div class="col-6 col-sm-6 col-lg-3">
                        <div class="card stat-card">
                            <div class="stat-number" id="total-transactions">0</div>
                            <div class="stat-label">
                                <span class="d-none d-sm-inline">Total Transactions</span>
                                <span class="d-inline d-sm-none">Transactions</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-sm-6 col-lg-3">
                        <div class="card stat-card">
                            <div class="stat-number" id="active-devices">0</div>
                            <div class="stat-label" id="device-type-label">
                                <span class="d-none d-sm-inline">Kati Watches</span>
                                <span class="d-inline d-sm-none">Devices</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-sm-6 col-lg-3">
                        <div class="card stat-card">
                            <div class="stat-number" id="success-rate">0%</div>
                            <div class="stat-label">
                                <span class="d-none d-sm-inline">Success Rate</span>
                                <span class="d-inline d-sm-none">Success</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-sm-6 col-lg-3">
                        <div class="card emergency-stat-card" id="emergency-card" style="display: none;" onclick="showEmergencyDetails()">
                            <!-- Emergency Alert Ribbon -->
                            <div class="emergency-ribbon">
                                <div class="ribbon-content">
                                    <i class="ti ti-alert-triangle"></i>
                                    <span>EMERGENCY</span>
                                </div>
                            </div>
                            
                            <!-- Main Content -->
                            <div class="emergency-content-wrapper">
                                <div class="emergency-header">
                                    <div class="emergency-icon-container">
                                        <div class="emergency-icon-ring">
                                            <i class="ti ti-alert-triangle"></i>
                                        </div>
                                    </div>
                                    <div class="emergency-badge-container">
                                        <div class="emergency-badge" id="emergency-severity-badge">
                                            <span class="badge bg-danger">CRITICAL</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="emergency-content">
                                    <div class="emergency-main">
                                        <div class="emergency-number-container">
                                            <div class="emergency-number" id="emergency-count">0</div>
                                            <div class="emergency-number-shadow"></div>
                                        </div>
                                        <div class="emergency-label">Emergency Alerts</div>
                                    </div>
                                    
                                    <div class="emergency-details">
                                        <div class="emergency-status" id="emergency-status">
                                            <div class="status-indicator">
                                                <i class="ti ti-clock"></i>
                                                <span>Active</span>
                                            </div>
                                        </div>
                                        <div class="emergency-trend" id="emergency-trend">
                                            <div class="trend-indicator">
                                                <i class="ti ti-trending-up"></i>
                                                <span>+3 new</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="emergency-breakdown">
                                        <div class="breakdown-item">
                                            <div class="breakdown-icon">
                                                <i class="ti ti-heart"></i>
                                            </div>
                                            <div class="breakdown-content">
                                                <span class="breakdown-label">SOS</span>
                                                <span class="breakdown-value" id="sos-count">0</span>
                                            </div>
                                        </div>
                                        <div class="breakdown-item">
                                            <div class="breakdown-icon">
                                                <i class="ti ti-activity"></i>
                                            </div>
                                            <div class="breakdown-content">
                                                <span class="breakdown-label">Fall</span>
                                                <span class="breakdown-value" id="fall-count">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Animated Background Elements -->
                            <div class="emergency-pulse"></div>
                            <div class="emergency-pulse-secondary"></div>
                            <div class="emergency-glow"></div>
                            
                            <!-- Interactive Overlay -->
                            <div class="emergency-overlay">
                                <div class="overlay-content">
                                    <div class="overlay-icon">
                                        <i class="ti ti-eye"></i>
                                    </div>
                                    <div class="overlay-text">View Details</div>
                                </div>
                            </div>
                            
                            <!-- Emergency Alert Sound Indicator -->
                            <div class="emergency-sound-indicator" id="emergency-sound-indicator">
                                <i class="ti ti-volume"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Statistics for All Devices View -->
                <div class="row stats-cards" id="all-devices-stats" style="display: none;">
                    <div class="col-6 col-sm-6 col-lg-3">
                        <div class="card stat-card">
                            <div class="stat-number" id="mapped-devices-count">0</div>
                            <div class="stat-label">
                                <span class="d-none d-sm-inline">Mapped Devices</span>
                                <span class="d-inline d-sm-none">Mapped</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-sm-6 col-lg-3">
                        <div class="card stat-card">
                            <div class="stat-number" id="unmapped-devices-count">0</div>
                            <div class="stat-label">
                                <span class="d-none d-sm-inline">Unmapped Devices</span>
                                <span class="d-inline d-sm-none">Unmapped</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-sm-6 col-lg-3">
                        <div class="card stat-card">
                            <div class="stat-number" id="mapped-transactions-count">0</div>
                            <div class="stat-label">
                                <span class="d-none d-sm-inline">Mapped Transactions</span>
                                <span class="d-inline d-sm-none">Mapped Tx</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-sm-6 col-lg-3">
                        <div class="card stat-card">
                            <div class="stat-number" id="unmapped-transactions-count">0</div>
                            <div class="stat-label">
                                <span class="d-none d-sm-inline">Unmapped Transactions</span>
                                <span class="d-inline d-sm-none">Unmapped Tx</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Topic Distribution -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="ti ti-chart-pie"></i>
                                    Topic Distribution
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="row" id="topic-distribution">
                                    <!-- Topic badges will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Kati Transaction Table -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-table"></i>
                            Kati Watch Transactions
                            <span class="badge bg-primary ms-2" id="transaction-count">0</span>
                        </h3>
                        <div class="card-actions">
                            <div class="btn-group d-none d-md-flex">
                                <button class="btn btn-sm btn-outline-secondary" onclick="filterByTopic('all')">All</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="filterByTopic('iMEDE_watch/hb')">Heartbeat</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="filterByTopic('iMEDE_watch/VitalSign')">Vital Signs</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="filterByTopic('iMEDE_watch/AP55')">Batch Data</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="filterByTopic('iMEDE_watch/location')">Location</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="filterByTopic('iMEDE_watch/sleepdata')">Sleep Data</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="filterByTopic('iMEDE_watch/SOS')">SOS</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="filterByTopic('iMEDE_watch/fallDown')">Fall Detection</button>
                            </div>
                            <div class="dropdown d-md-none">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="ti ti-filter"></i>
                                    Filter
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="filterByTopic('all')">All</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterByTopic('iMEDE_watch/hb')">Heartbeat</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterByTopic('iMEDE_watch/VitalSign')">Vital Signs</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterByTopic('iMEDE_watch/AP55')">Batch Data</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterByTopic('iMEDE_watch/location')">Location</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterByTopic('iMEDE_watch/sleepdata')">Sleep Data</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterByTopic('iMEDE_watch/SOS')">SOS</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterByTopic('iMEDE_watch/fallDown')">Fall Detection</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-vcenter card-table" id="kati-transaction-table">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Device & Topic / Event Type</th>
                                        <th>Patient</th>
                                        <th>Data</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="kati-transaction-tbody">
                                    <!-- Data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mt-3 gap-2">
                            <div class="text-muted text-center text-md-start">
                                <span class="d-none d-sm-inline">Showing </span>
                                <span id="pagination-info">0-0 of 0</span>
                                <span class="d-none d-sm-inline"> transactions</span>
                                <span class="d-inline d-sm-none"> tx</span>
                            </div>
                            <div class="btn-group" id="pagination-controls">
                                <button class="btn btn-sm btn-outline-secondary d-none d-md-inline" onclick="changePage(1)" id="first-page">
                                    <i class="ti ti-chevrons-left"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="changePage(currentPage - 1)" id="prev-page">
                                    <i class="ti ti-chevron-left"></i>
                                </button>
                                <span class="btn btn-sm btn-outline-primary" id="current-page">1</span>
                                <button class="btn btn-sm btn-outline-secondary" onclick="changePage(currentPage + 1)" id="next-page">
                                    <i class="ti ti-chevron-right"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary d-none d-md-inline" onclick="changePage(totalPages)" id="last-page">
                                    <i class="ti ti-chevrons-right"></i>
                                </button>
                            </div>
                            <div class="d-flex align-items-center">
                                <label class="form-label me-2 d-none d-sm-inline">Per page:</label>
                                <label class="form-label me-2 d-inline d-sm-none">Page:</label>
                                <select class="form-select form-select-sm" style="width: auto;" id="per-page-select" onchange="changePerPage()">
                                    <option value="25">25</option>
                                    <option value="50" selected>50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Batch Vital Signs Modal -->
        <div class="modal fade" id="batchVitalSignsModal" tabindex="-1" aria-labelledby="batchVitalSignsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="batchVitalSignsModalLabel">
                            <i class="ti ti-activity"></i>
                            Batch Vital Signs Data
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="batchModalContent">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Emergency Details Modal -->
        <div class="modal fade emergency-details-modal" id="emergencyDetailsModal" tabindex="-1" aria-labelledby="emergencyDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="emergencyDetailsModalLabel">
                            <i class="ti ti-alert-triangle me-2"></i>
                            Emergency SOS Alerts
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="text-center">
                                    <div class="h3 text-danger" id="modal-emergency-count">0</div>
                                    <div class="text-muted">Active Alerts</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <div class="h3 text-warning" id="modal-sos-count">0</div>
                                    <div class="text-muted">SOS Signals</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <div class="h3 text-info" id="modal-fall-count">0</div>
                                    <div class="text-muted">Fall Detection</div>
                                </div>
                            </div>
                        </div>
                        <div id="emergency-alerts-list">
                            <!-- Emergency alerts will be populated here -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-danger" onclick="acknowledgeAllAlerts()">
                            <i class="ti ti-check me-2"></i>
                            Acknowledge All
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Location/SOS Detail Modal with Google Maps -->
        <div class="modal fade" id="locationDetailModal" tabindex="-1" aria-labelledby="locationDetailModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="locationDetailModalLabel">
                            <i class="ti ti-map-pin"></i>
                            Location Details
                        </h5>
                        <div class="ms-auto me-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadEnhancedLocationInfo()">
                                <i class="ti ti-search"></i>
                                Enhanced Info
                            </button>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="locationModalContent">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading location data...</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sleep Data Analysis Modal -->
        <div class="modal fade" id="sleepDataModal" tabindex="-1" aria-labelledby="sleepDataModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="sleepDataModalLabel">
                            <i class="ti ti-moon"></i>
                            Sleep Data Analysis
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="sleepModalContent">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading sleep data analysis...</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Vital Signs Detail Modal -->
        <div class="modal fade" id="vitalSignsDetailModal" tabindex="-1" aria-labelledby="vitalSignsDetailModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title" id="vitalSignsDetailModalLabel">
                            <i class="ti ti-heartbeat"></i>
                            Vital Signs Details
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="vitalSignsModalContent">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading vital signs data...</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
        let socket;
        let autoRefreshInterval;
        let autoRefreshEnabled = true; // Set to true by default
        let currentFilter = 'all';
        let currentDataFilter = 'patient_only'; // 'patient_only' or 'all_devices'
        let katiData = [];
        let currentPage = 1;
        let totalPages = 1;
        let perPage = 200;
        
        // Initialize Socket.IO connection
        function initializeSocket() {
            console.log('🔌 Initializing Socket.IO connection...');
            
            // Configure Socket.IO with connection options
            socket = io({
                timeout: 20000,
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000
            });
            
            socket.on('connect', function() {
                console.log('✅ Connected to WebSocket server');
                document.getElementById('connection-status').className = 'connection-indicator connection-connected';
                document.getElementById('connection-text').textContent = 'Connected';
                document.getElementById('header-connection-status').textContent = 'Connected';
            });
            
            socket.on('disconnect', function() {
                console.log('❌ Disconnected from WebSocket server');
                document.getElementById('connection-status').className = 'connection-indicator connection-disconnected';
                document.getElementById('connection-text').textContent = 'Disconnected';
                document.getElementById('header-connection-status').textContent = 'Disconnected';
            });
            
            socket.on('connect_error', function(error) {
                console.error('❌ Socket.IO connection error:', error);
                document.getElementById('connection-status').className = 'connection-indicator connection-disconnected';
                document.getElementById('connection-text').textContent = 'Connection Error';
                document.getElementById('header-connection-status').textContent = 'Connection Error';
            });
            
            socket.on('kati_transaction_update', function(data) {
                console.log('📡 Received Kati transaction update:', data);
                addKatiTransaction(data);
                updateStatistics();
            });
            
            // Add timeout to check connection status with retry logic
            setTimeout(function() {
                if (!socket.connected) {
                    console.warn('⚠️ Socket.IO connection timeout - attempting to reconnect...');
                    document.getElementById('connection-status').className = 'connection-indicator connection-disconnected';
                    document.getElementById('connection-text').textContent = 'Reconnecting...';
                    document.getElementById('header-connection-status').textContent = 'Reconnecting...';
                    
                    // Try to reconnect after a short delay
                    setTimeout(function() {
                        if (socket) {
                            socket.connect();
                        }
                    }, 2000);
                }
            }, 10000);
        }
        
        // Initialize data filter toggle
        function initializeDataFilter() {
            const patientOnlyRadio = document.getElementById('patient-only');
            const allDevicesRadio = document.getElementById('all-devices');
            
            patientOnlyRadio.addEventListener('change', function() {
                if (this.checked) {
                    currentDataFilter = 'patient_only';
                    currentPage = 1; // Reset to first page
                    loadKatiData();
                }
            });
            
            allDevicesRadio.addEventListener('change', function() {
                if (this.checked) {
                    currentDataFilter = 'all_devices';
                    currentPage = 1; // Reset to first page
                    loadKatiData();
                }
            });
        }
        
        // Load Kati transaction data
        function loadKatiData() {
            const url = currentDataFilter === 'patient_only' 
                ? `/api/kati-transactions?filter=patient_only&page=${currentPage}&per_page=${perPage}`
                : `/api/kati-transactions?filter=all_devices&page=${currentPage}&per_page=${perPage}`;
                
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        katiData = data.data.transactions || [];
                        displayKatiTransactions();
                        updateStatistics(data.data.statistics);
                        updateTopicDistribution(data.data.statistics.topic_distribution);
                        updateDataFilterDisplay();
                        updatePagination(data.data.statistics.pagination);
                    } else {
                        console.error('Failed to load Kati data:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error loading Kati data:', error);
                });
        }
        
        // Update pagination controls
        function updatePagination(pagination) {
            if (!pagination) return;
            
            currentPage = pagination.page;
            totalPages = pagination.total_pages;
            const totalCount = pagination.total_count;
            const startItem = (currentPage - 1) * perPage + 1;
            const endItem = Math.min(currentPage * perPage, totalCount);
            
            // Update pagination info
            document.getElementById('pagination-info').textContent = `${startItem}-${endItem} of ${totalCount}`;
            document.getElementById('current-page').textContent = currentPage;
            
            // Update button states
            document.getElementById('first-page').disabled = currentPage === 1;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
            document.getElementById('last-page').disabled = currentPage === totalPages;
            
            // Update per page select
            document.getElementById('per-page-select').value = perPage;
        }
        
        // Change page
        function changePage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadKatiData();
        }
        
        // Change per page
        function changePerPage() {
            perPage = parseInt(document.getElementById('per-page-select').value);
            currentPage = 1; // Reset to first page
            loadKatiData();
        }
        
        // Update display based on data filter
        function updateDataFilterDisplay() {
            const allDevicesStats = document.getElementById('all-devices-stats');
            const deviceTypeLabel = document.getElementById('device-type-label');
            
            if (currentDataFilter === 'all_devices') {
                allDevicesStats.style.display = 'block';
                deviceTypeLabel.textContent = 'All Kati Devices';
            } else {
                allDevicesStats.style.display = 'none';
                deviceTypeLabel.textContent = 'Kati Watches';
            }
        }
        
        // Display Kati transactions in table
        function displayKatiTransactions() {
            const tbody = document.getElementById('kati-transaction-tbody');
            tbody.innerHTML = '';
            
            const filteredData = currentFilter === 'all' 
                ? katiData 
                : katiData.filter(item => item.topic === currentFilter);
            
            filteredData.forEach(transaction => {
                const row = createTransactionRow(transaction);
                tbody.appendChild(row);
            });
            
            document.getElementById('transaction-count').textContent = filteredData.length;
        }
        
        // Create transaction row
        function createTransactionRow(transaction) {
            const row = document.createElement('tr');
            
            // Format timestamp with local timezone - explicitly parse as UTC
            const timestampString = transaction.timestamp;
            let timestamp;
            
            // Check if timestamp is already a Date object
            if (timestampString instanceof Date) {
                timestamp = timestampString;
            } else {
                // Parse as UTC if it's a string without timezone
                if (typeof timestampString === 'string' && !timestampString.includes('Z') && !timestampString.includes('+')) {
                    // Add 'Z' to indicate UTC
                    timestamp = new Date(timestampString + 'Z');
                } else {
                    timestamp = new Date(timestampString);
                }
            }
            
            const formattedTime = formatLocalTimestamp(timestamp);
            
            // Get patient info with photo and hospital/ward
            let patientInfo = createPatientInfo(transaction);
            
            // Get status badge
            const statusBadge = getStatusBadge(transaction.event_type, transaction.status);
            
            // Get topic badge
            const topicBadge = `<span class="topic-badge">${transaction.topic}</span>`;
            
            // Format data based on event type
            let dataDisplay = 'No Data';
            if (transaction.data) {
                dataDisplay = formatTransactionData(transaction);
            }
            
            row.innerHTML = `
                <td>
                    <div class="text-muted">${formattedTime}</div>
                </td>
                <td>
                    <div class="text-muted">${transaction.device_id || 'N/A'}</div>
                    ${topicBadge}
                    <div class="text-muted small mt-1">${transaction.event_type || 'Unknown'}</div>
                </td>
                <td>${patientInfo}</td>
                <td>
                    <div class="data-value">${dataDisplay}</div>
                </td>
                <td>${statusBadge}</td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewTransactionDetails('${transaction._id}')">
                            <i class="ti ti-eye"></i>
                            View
                        </button>
                        ${(transaction.topic === 'iMEDE_watch/location' || transaction.topic === 'iMEDE_watch/sos' || transaction.topic === 'iMEDE_watch/fallDown') ? `
                            <button class="btn btn-sm btn-outline-info" onclick="viewLocationDetails('${transaction._id}')">
                                <i class="ti ti-map-pin"></i>
                                Map
                            </button>
                        ` : ''}
                        ${(transaction.topic === 'iMEDE_watch/VitalSign') ? `
                            <button class="btn btn-sm btn-outline-success" onclick="viewVitalSignsDetails('${transaction._id}')">
                                <i class="ti ti-heartbeat"></i>
                                Vital Signs
                            </button>
                        ` : ''}
                    </div>
                </td>
            `;
            
            return row;
        }
        
        // Format timestamp to local timezone with timezone indicator
        function formatLocalTimestamp(timestamp) {
            if (!timestamp || isNaN(timestamp.getTime())) {
                return 'Invalid Date';
            }
            
            // Get timezone offset for display
            const timezoneOffset = new Date().getTimezoneOffset();
            const timezoneHours = Math.abs(Math.floor(timezoneOffset / 60));
            const timezoneMinutes = Math.abs(timezoneOffset % 60);
            const timezoneSign = timezoneOffset <= 0 ? '+' : '-';
            const timezoneString = `${timezoneSign}${timezoneHours.toString().padStart(2, '0')}:${timezoneMinutes.toString().padStart(2, '0')}`;
            
            // Format date and time - JavaScript automatically converts UTC to local
            const dateString = timestamp.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            const timeString = timestamp.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            return `${dateString} ${timeString}`;
        }
        
        // Format Unix timestamp to local timezone
        function formatUnixTimestamp(unixTimestamp) {
            if (!unixTimestamp) return 'N/A';
            
            // Convert Unix timestamp to milliseconds if it's in seconds
            const timestamp = unixTimestamp > 1000000000000 ? unixTimestamp : unixTimestamp * 1000;
            const date = new Date(timestamp);
            
            return formatLocalTimestamp(date);
        }
        
        // Create patient info with photo and hospital/ward
        function createPatientInfo(transaction) {
            let patientInfo = 'Unknown';
            let patientPhoto = '';
            let hospitalInfo = '';
            
            if (transaction.patient_info) {
                const info = transaction.patient_info;
                const firstName = info.first_name || '';
                const lastName = info.last_name || '';
                patientInfo = `${firstName} ${lastName}`.trim() || 'Unknown Patient';
                
                // Add patient photo
                if (info.profile_image) {
                    patientPhoto = `<img src="${info.profile_image}" alt="Patient Photo" class="avatar avatar-sm me-2" onerror="this.style.display='none'">`;
                }
                
                // Add hospital and ward info
                if (info.hospital_info) {
                    const hospital = info.hospital_info;
                    if (hospital.hospital_name) {
                        hospitalInfo += `<div class="text-muted small">🏥 ${hospital.hospital_name}</div>`;
                    }
                    if (hospital.ward_name) {
                        hospitalInfo += `<div class="text-muted small">🏥 ${hospital.ward_name}</div>`;
                    }
                }
            } else if (transaction.device_id) {
                patientInfo = `Device: ${transaction.device_id}`;
            }
            
            // Add unmapped device indicator
            if (!transaction.patient_id && transaction.device_id) {
                patientInfo += ' <span class="badge bg-warning">Unmapped</span>';
            }
            
            return `
                <div class="d-flex align-items-center">
                    ${patientPhoto}
                    <div>
                        <div class="font-weight-medium">${patientInfo}</div>
                        ${hospitalInfo}
                    </div>
                </div>
            `;
        }
        
        // Format transaction data for display
        function formatTransactionData(transaction) {
            const data = transaction.data;
            const eventType = transaction.event_type;
            
            if (!data) return 'No Data';
            
            switch (eventType) {
                case 'heartbeat':
                    return `Steps: ${transaction.step_count || 0}, Battery: ${transaction.battery || 0}%, Signal: ${transaction.signal_gsm || 0}`;
                case 'vital_signs':
                    const hr = data.heartRate || 'N/A';
                    const bp = data.bloodPressure ? `${data.bloodPressure.bp_sys || 'N/A'}/${data.bloodPressure.bp_dia || 'N/A'}` : 'N/A';
                    const temp = data.bodyTemperature || 'N/A';
                    const spo2 = data.spO2 || 'N/A';
                    return `HR: ${hr}, BP: ${bp}, Temp: ${temp}°C, SpO2: ${spo2}%`;
                case 'batch_vital_signs':
                    const numData = transaction.num_datas || 0;
                    return `<span class="batch-data-link" onclick="viewBatchVitalSigns('${transaction._id}')" style="cursor: pointer; color: #206bc4; text-decoration: underline;">Batch: ${numData} vital signs records</span>`;
                case 'location':
                    const location = data.location || {};
                    const gps = location.GPS || {};
                    if (gps.latitude && gps.longitude) {
                        return `GPS: ${gps.latitude}, ${gps.longitude}`;
                    }
                    return 'Location data available';
                case 'emergency_sos':
                    return `SOS Alert - ${data.status || 'Emergency'}`;
                case 'fall_detection':
                    return `Fall Detection - ${data.status || 'Fall Detected'}`;
                case 'sleep_data':
                    const sleep = data.sleep || {};
                    return `<span class="sleep-data-link" onclick="viewSleepData('${transaction._id}')" style="cursor: pointer; color: #206bc4; text-decoration: underline;">Sleep: ${sleep.time || 'N/A'}, Slots: ${sleep.num || 0}</span>`;
                case 'device_status':
                    return `Status: ${data.status || 'Unknown'}`;
                default:
                    return JSON.stringify(data).substring(0, 100) + (JSON.stringify(data).length > 100 ? '...' : '');
            }
        }
        
        // View batch vital signs details
        function viewBatchVitalSigns(transactionId) {
            // Show loading state
            document.getElementById('batchModalContent').innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading batch vital signs data...</p>
                </div>
            `;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('batchVitalSignsModal'));
            modal.show();
            
            // Fetch batch data
            fetch(`/api/kati-transactions/${transactionId}/batch-details`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayBatchVitalSigns(data.data);
                    } else {
                        document.getElementById('batchModalContent').innerHTML = `
                            <div class="alert alert-danger">
                                <i class="ti ti-alert-circle"></i>
                                Error: ${data.error || 'Failed to load batch data'}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error fetching batch data:', error);
                    document.getElementById('batchModalContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="ti ti-alert-circle"></i>
                            Error: Failed to load batch data
                        </div>
                    `;
                });
        }
        
        // Display batch vital signs data
        function displayBatchVitalSigns(batchData) {
            const content = document.getElementById('batchModalContent');
            
            // Create enhanced patient info section
            let patientInfo = '';
            if (batchData.enhanced_patient_info) {
                const enhancedInfo = batchData.enhanced_patient_info;
                const patientName = `${enhancedInfo.first_name || ''} ${enhancedInfo.last_name || ''}`.trim() || 'Unknown Patient';
                const patientPhoto = enhancedInfo.profile_image ? `<img src="${enhancedInfo.profile_image}" alt="Patient Photo" class="avatar avatar-sm me-2" onerror="this.style.display='none'">` : '';
                
                // Format timestamp with local timezone - handle various timestamp formats
                const timestampString = batchData.timestamp;
                let timestamp;
                
                // Check if timestamp is already a Date object
                if (timestampString instanceof Date) {
                    timestamp = timestampString;
                } else if (typeof timestampString === 'string') {
                    // Handle different timestamp formats
                    if (timestampString.includes('GMT')) {
                        // Handle "Fri, 18 Jul 2025 15:38:08 GMT" format
                        timestamp = new Date(timestampString);
                    } else if (!timestampString.includes('Z') && !timestampString.includes('+')) {
                        // Add 'Z' to indicate UTC for ISO-like strings
                        timestamp = new Date(timestampString + 'Z');
                    } else {
                        timestamp = new Date(timestampString);
                    }
                } else {
                    timestamp = new Date();
                }
                
                const formattedTimestamp = formatLocalTimestamp(timestamp);
                
                // Hospital and ward information
                let hospitalWardInfo = '';
                if (enhancedInfo.hospital_name || enhancedInfo.ward_name) {
                    hospitalWardInfo = `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="text-primary mb-2">
                                    <i class="ti ti-building-hospital"></i>
                                    Hospital Information
                                </h6>
                                <div class="row">
                                    ${enhancedInfo.hospital_name ? `
                                        <div class="col-md-6">
                                            <div class="data-label">Hospital:</div>
                                            <div class="data-value">${enhancedInfo.hospital_name}</div>
                                        </div>
                                    ` : ''}
                                    ${enhancedInfo.ward_name ? `
                                        <div class="col-md-6">
                                            <div class="data-label">Ward:</div>
                                            <div class="data-value">${enhancedInfo.ward_name}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Contact information
                let contactInfo = '';
                if (enhancedInfo.mobile_phone || enhancedInfo.emergency_contact) {
                    contactInfo = `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="text-info mb-2">
                                    <i class="ti ti-phone"></i>
                                    Contact Information
                                </h6>
                                <div class="row">
                                    ${enhancedInfo.mobile_phone ? `
                                        <div class="col-md-6">
                                            <div class="data-label">Mobile Phone:</div>
                                            <div class="data-value">${enhancedInfo.mobile_phone}</div>
                                        </div>
                                    ` : ''}
                                    ${enhancedInfo.emergency_contact ? `
                                        <div class="col-md-6">
                                            <div class="data-label">Emergency Contact:</div>
                                            <div class="data-value">${enhancedInfo.emergency_contact}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Medical information
                let medicalInfo = '';
                if (enhancedInfo.underlying_conditions && enhancedInfo.underlying_conditions.length > 0 || 
                    enhancedInfo.allergies && enhancedInfo.allergies.length > 0) {
                    medicalInfo = `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="text-warning mb-2">
                                    <i class="ti ti-heartbeat"></i>
                                    Medical Information
                                </h6>
                                <div class="row">
                                    ${enhancedInfo.underlying_conditions && enhancedInfo.underlying_conditions.length > 0 ? `
                                        <div class="col-md-6">
                                            <div class="data-label">Underlying Conditions:</div>
                                            <div class="data-value">
                                                ${enhancedInfo.underlying_conditions.map(condition => 
                                                    `<span class="badge bg-warning text-dark me-1 mb-1">${condition}</span>`
                                                ).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${enhancedInfo.allergies && enhancedInfo.allergies.length > 0 ? `
                                        <div class="col-md-6">
                                            <div class="data-label">Allergies:</div>
                                            <div class="data-value">
                                                ${enhancedInfo.allergies.map(allergy => 
                                                    `<span class="badge bg-danger me-1 mb-1">${allergy}</span>`
                                                ).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                patientInfo = `
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="ti ti-user"></i>
                                        Patient Information
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        ${patientPhoto}
                                        <div>
                                            <h6 class="mb-1">${patientName}</h6>
                                            <div class="text-muted">Device: ${batchData.device_id || 'N/A'}</div>
                                            <div class="text-muted">Batch Size: ${batchData.batch_size} records</div>
                                            <div class="text-muted">Timestamp: ${formattedTimestamp}</div>
                                        </div>
                                    </div>
                                    ${hospitalWardInfo}
                                    ${contactInfo}
                                    ${medicalInfo}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (batchData.patient_info) {
                // Fallback to basic patient info if enhanced info not available
                const info = batchData.patient_info;
                const patientName = `${info.first_name || ''} ${info.last_name || ''}`.trim() || 'Unknown Patient';
                const patientPhoto = info.profile_image ? `<img src="${info.profile_image}" alt="Patient Photo" class="avatar avatar-sm me-2" onerror="this.style.display='none'">` : '';
                
                // Format timestamp with local timezone - handle various timestamp formats
                const timestampString = batchData.timestamp;
                let timestamp;
                
                // Check if timestamp is already a Date object
                if (timestampString instanceof Date) {
                    timestamp = timestampString;
                } else if (typeof timestampString === 'string') {
                    // Handle different timestamp formats
                    if (timestampString.includes('GMT')) {
                        // Handle "Fri, 18 Jul 2025 15:38:08 GMT" format
                        timestamp = new Date(timestampString);
                    } else if (!timestampString.includes('Z') && !timestampString.includes('+')) {
                        // Add 'Z' to indicate UTC for ISO-like strings
                        timestamp = new Date(timestampString + 'Z');
                    } else {
                        timestamp = new Date(timestampString);
                    }
                } else {
                    timestamp = new Date();
                }
                
                const formattedTimestamp = formatLocalTimestamp(timestamp);
                
                patientInfo = `
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        ${patientPhoto}
                                        <div>
                                            <h6 class="mb-1">${patientName}</h6>
                                            <div class="text-muted">Device: ${batchData.device_id || 'N/A'}</div>
                                            <div class="text-muted">Batch Size: ${batchData.batch_size} records</div>
                                            <div class="text-muted">Timestamp: ${formattedTimestamp}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Create averages section
            const averages = batchData.averages;
            let averagesHtml = '';
            if (averages) {
                averagesHtml = `
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="ti ti-calculator"></i>
                                        Averages
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <div class="h3 text-primary">${Math.round(averages.heartRate) || 'N/A'}</div>
                                                <div class="text-muted">Heart Rate (bpm)</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <div class="h3 text-success">${Math.round(averages.bloodPressure.systolic) || 'N/A'}/${Math.round(averages.bloodPressure.diastolic) || 'N/A'}</div>
                                                <div class="text-muted">Blood Pressure (mmHg)</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <div class="h3 text-warning">${averages.bodyTemperature || 'N/A'}</div>
                                                <div class="text-muted">Body Temperature (°C)</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <div class="h3 text-info">${Math.round(averages.spO2) || 'N/A'}</div>
                                                <div class="text-muted">SpO2 (%)</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Create vital signs table
            const vitalSigns = batchData.vital_signs;
            let vitalSignsTable = '';
            if (vitalSigns && vitalSigns.length > 0) {
                const tableRows = vitalSigns.map((vital, index) => {
                    const hr = vital.heartRate || 'N/A';
                    const bp = vital.bloodPressure ? `${vital.bloodPressure.bp_sys || 'N/A'}/${vital.bloodPressure.bp_dia || 'N/A'}` : 'N/A';
                    const temp = vital.bodyTemperature || 'N/A';
                    const spo2 = vital.spO2 || 'N/A';
                    const timestamp = formatUnixTimestamp(vital.timestamp);
                    
                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${timestamp}</td>
                            <td>${hr}</td>
                            <td>${bp}</td>
                            <td>${temp}</td>
                            <td>${spo2}</td>
                        </tr>
                    `;
                }).join('');
                
                vitalSignsTable = `
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="ti ti-list"></i>
                                        Individual Vital Signs Records (${vitalSigns.length} records)
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-vcenter">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Timestamp</th>
                                                    <th>Heart Rate (bpm)</th>
                                                    <th>Blood Pressure (mmHg)</th>
                                                    <th>Temperature (°C)</th>
                                                    <th>SpO2 (%)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${tableRows}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Combine all sections
            content.innerHTML = patientInfo + averagesHtml + vitalSignsTable;
        }
        
        // Get status badge
        function getStatusBadge(eventType, status) {
            if (eventType === 'emergency_sos' || eventType === 'fall_detection') {
                return '<span class="status-badge status-emergency">Emergency</span>';
            } else if (status === 'success' || status === 'online') {
                return '<span class="status-badge status-success">Success</span>';
            } else if (status === 'error' || status === 'offline') {
                return '<span class="status-badge status-error">Error</span>';
            } else if (status === 'warning') {
                return '<span class="status-badge status-warning">Warning</span>';
            } else {
                return '<span class="status-badge status-info">Info</span>';
            }
        }
        
        // Update statistics
        function updateStatistics(stats) {
            if (!stats) return;
            
            document.getElementById('total-transactions').textContent = stats.total_transactions || 0;
            document.getElementById('active-devices').textContent = stats.active_devices || 0;
            document.getElementById('success-rate').textContent = (stats.success_rate || 0) + '%';
            
            // Update emergency count
            const emergencyCount = stats.emergency_count || 0;
            const emergencyCard = document.getElementById('emergency-card');
            if (emergencyCount > 0) {
                document.getElementById('emergency-count').textContent = emergencyCount;
                emergencyCard.style.display = 'block';
            } else {
                emergencyCard.style.display = 'none';
            }
            
            // Update all devices stats if available
            if (stats.mapped_devices !== undefined) {
                document.getElementById('mapped-devices-count').textContent = stats.mapped_devices || 0;
                document.getElementById('unmapped-devices-count').textContent = stats.unmapped_devices || 0;
                document.getElementById('mapped-transactions-count').textContent = stats.mapped_transactions || 0;
                document.getElementById('unmapped-transactions-count').textContent = stats.unmapped_transactions || 0;
            }
        }
        
        // Update topic distribution
        function updateTopicDistribution(topicDistribution) {
            const container = document.getElementById('topic-distribution');
            container.innerHTML = '';
            
            if (!topicDistribution) return;
            
            Object.entries(topicDistribution).forEach(([topic, count]) => {
                const badge = document.createElement('div');
                badge.className = 'col-auto';
                badge.innerHTML = `
                    <span class="topic-badge">
                        ${topic}: ${count}
                    </span>
                `;
                container.appendChild(badge);
            });
        }
        
        // Filter by topic
        function filterByTopic(topic) {
            currentFilter = topic;
            displayKatiTransactions();
        }
        
        // Toggle auto refresh
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const icon = document.getElementById('auto-refresh-icon');
            const text = document.getElementById('auto-refresh-text');
            
            if (autoRefreshEnabled) {
                icon.className = 'ti ti-clock text-success';
                text.textContent = 'Auto Refresh ON';
                autoRefreshInterval = setInterval(loadKatiData, 10000); // 10 seconds
            } else {
                icon.className = 'ti ti-clock';
                text.textContent = 'Auto Refresh';
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                }
            }
        }
        
        // Add new transaction (for real-time updates)
        function addKatiTransaction(transaction) {
            // Only add if it matches current filter
            if (currentDataFilter === 'patient_only' && !transaction.patient_id) {
                return; // Skip unmapped devices in patient-only mode
            }
            
            katiData.unshift(transaction);
            if (katiData.length > perPage) {
                katiData = katiData.slice(0, perPage);
            }
            displayKatiTransactions();
        }
        
        // View transaction details
        function viewTransactionDetails(transactionId) {
            const transaction = katiData.find(t => t._id === transactionId);
            if (transaction) {
                alert('Transaction Details:\n' + JSON.stringify(transaction, null, 2));
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeDataFilter();
            loadKatiData();
            
            // Start auto refresh by default
            const icon = document.getElementById('auto-refresh-icon');
            const text = document.getElementById('auto-refresh-text');
            icon.className = 'ti ti-clock text-success';
            text.textContent = 'Auto Refresh ON';
            autoRefreshInterval = setInterval(loadKatiData, 10000); // 10 seconds
        });
        
        // View location details with Google Maps
        function viewLocationDetails(transactionId) {
            const transaction = katiData.find(t => t._id === transactionId);
            if (!transaction) {
                alert('Transaction not found');
                return;
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('locationDetailModal'));
            modal.show();
            
            // Fetch detailed location data
            fetch(`/api/kati-transactions/${transactionId}/location-details`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayLocationDetails(data.data, transaction);
                    } else {
                        document.getElementById('locationModalContent').innerHTML = `
                            <div class="alert alert-danger">
                                <i class="ti ti-alert-circle"></i>
                                Error: ${data.error || 'Failed to load location data'}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error fetching location data:', error);
                    document.getElementById('locationModalContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="ti ti-alert-circle"></i>
                            Error: Failed to load location data
                        </div>
                    `;
                });
        }
        
        // View vital signs details
        function viewVitalSignsDetails(transactionId) {
            // Show loading state
            document.getElementById('vitalSignsModalContent').innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading vital signs data...</p>
                </div>
            `;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('vitalSignsDetailModal'));
            modal.show();
            
            // Fetch vital signs data
            fetch(`/api/kati-transactions/${transactionId}/vital-signs-details`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayVitalSignsDetails(data.data);
                    } else {
                        document.getElementById('vitalSignsModalContent').innerHTML = `
                            <div class="alert alert-danger">
                                <i class="ti ti-alert-circle"></i>
                                Error: ${data.error || 'Failed to load vital signs data'}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error fetching vital signs data:', error);
                    document.getElementById('vitalSignsModalContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="ti ti-alert-circle"></i>
                            Error: Failed to load vital signs data
                        </div>
                    `;
                });
        }
        
        // Display vital signs details
        function displayVitalSignsDetails(vitalSignsData) {
            const content = document.getElementById('vitalSignsModalContent');
            
            // Create patient info section
            let patientInfo = '';
            const patientInfoData = vitalSignsData.patient_info;
            
            if (patientInfoData) {
                const patientName = `${patientInfoData.first_name || ''} ${patientInfoData.last_name || ''}`.trim() || 'Unknown Patient';
                const patientPhoto = patientInfoData.profile_image ? `<img src="${patientInfoData.profile_image}" alt="Patient Photo" class="avatar avatar-sm me-2" onerror="this.style.display='none'">` : '';
                
                patientInfo = `
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="ti ti-user"></i>
                                        Patient Information
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        ${patientPhoto}
                                        <div>
                                            <h6 class="mb-1">${patientName}</h6>
                                            <div class="text-muted">Device: ${vitalSignsData.device_id || 'N/A'}</div>
                                            <div class="text-muted">IMEI: ${vitalSignsData.imei || 'N/A'}</div>
                                            <div class="text-muted">Timestamp: ${formatLocalTimestamp(new Date(vitalSignsData.timestamp))}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Create vital signs display
            const vitalSigns = vitalSignsData.vital_signs;
            let vitalSignsDisplay = '';
            
            if (vitalSigns) {
                vitalSignsDisplay = `
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="ti ti-heartbeat"></i>
                                        Vital Signs Measurements
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <div class="vital-sign-card ${vitalSigns.heart_rate.status === 'Normal' ? 'bg-success' : 'bg-danger'} text-white">
                                                <div class="vital-sign-icon">
                                                    <i class="ti ti-heart"></i>
                                                </div>
                                                <div class="vital-sign-content">
                                                    <div class="vital-sign-value">${vitalSigns.heart_rate.value || 'N/A'}</div>
                                                    <div class="vital-sign-unit">${vitalSigns.heart_rate.unit}</div>
                                                    <div class="vital-sign-label">Heart Rate</div>
                                                    <div class="vital-sign-status">${vitalSigns.heart_rate.status}</div>
                                                    <div class="vital-sign-range">${vitalSigns.heart_rate.normal_range}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="vital-sign-card ${vitalSigns.blood_pressure.status === 'Normal' ? 'bg-success' : 'bg-danger'} text-white">
                                                <div class="vital-sign-icon">
                                                    <i class="ti ti-droplet"></i>
                                                </div>
                                                <div class="vital-sign-content">
                                                    <div class="vital-sign-value">${vitalSigns.blood_pressure.systolic || 'N/A'}/${vitalSigns.blood_pressure.diastolic || 'N/A'}</div>
                                                    <div class="vital-sign-unit">${vitalSigns.blood_pressure.unit}</div>
                                                    <div class="vital-sign-label">Blood Pressure</div>
                                                    <div class="vital-sign-status">${vitalSigns.blood_pressure.status}</div>
                                                    <div class="vital-sign-range">${vitalSigns.blood_pressure.normal_range}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="vital-sign-card ${vitalSigns.body_temperature.status === 'Normal' ? 'bg-success' : 'bg-danger'} text-white">
                                                <div class="vital-sign-icon">
                                                    <i class="ti ti-thermometer"></i>
                                                </div>
                                                <div class="vital-sign-content">
                                                    <div class="vital-sign-value">${vitalSigns.body_temperature.value || 'N/A'}</div>
                                                    <div class="vital-sign-unit">${vitalSigns.body_temperature.unit}</div>
                                                    <div class="vital-sign-label">Body Temperature</div>
                                                    <div class="vital-sign-status">${vitalSigns.body_temperature.status}</div>
                                                    <div class="vital-sign-range">${vitalSigns.body_temperature.normal_range}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="vital-sign-card ${vitalSigns.spO2.status === 'Normal' ? 'bg-success' : 'bg-danger'} text-white">
                                                <div class="vital-sign-icon">
                                                    <i class="ti ti-wind"></i>
                                                </div>
                                                <div class="vital-sign-content">
                                                    <div class="vital-sign-value">${vitalSigns.spO2.value || 'N/A'}</div>
                                                    <div class="vital-sign-unit">${vitalSigns.spO2.unit}</div>
                                                    <div class="vital-sign-label">SpO2</div>
                                                    <div class="vital-sign-status">${vitalSigns.spO2.status}</div>
                                                    <div class="vital-sign-range">${vitalSigns.spO2.normal_range}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="vital-sign-card ${vitalSigns.signal_gsm.status === 'Good' ? 'bg-success' : 'bg-warning'} text-white">
                                                <div class="vital-sign-icon">
                                                    <i class="ti ti-signal"></i>
                                                </div>
                                                <div class="vital-sign-content">
                                                    <div class="vital-sign-value">${vitalSigns.signal_gsm.value || 'N/A'}</div>
                                                    <div class="vital-sign-unit">${vitalSigns.signal_gsm.unit}</div>
                                                    <div class="vital-sign-label">GSM Signal</div>
                                                    <div class="vital-sign-status">${vitalSigns.signal_gsm.status}</div>
                                                    <div class="vital-sign-range">${vitalSigns.signal_gsm.normal_range}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="vital-sign-card ${vitalSigns.battery.status === 'Good' ? 'bg-success' : 'bg-warning'} text-white">
                                                <div class="vital-sign-icon">
                                                    <i class="ti ti-battery"></i>
                                                </div>
                                                <div class="vital-sign-content">
                                                    <div class="vital-sign-value">${vitalSigns.battery.value || 'N/A'}</div>
                                                    <div class="vital-sign-unit">${vitalSigns.battery.unit}</div>
                                                    <div class="vital-sign-label">Battery</div>
                                                    <div class="vital-sign-status">${vitalSigns.battery.status}</div>
                                                    <div class="vital-sign-range">${vitalSigns.battery.normal_range}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Create location info if available
            let locationInfo = '';
            if (vitalSignsData.location && vitalSignsData.location.gps) {
                const gps = vitalSignsData.location.gps;
                if (gps.latitude && gps.longitude) {
                    locationInfo = `
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">
                                            <i class="ti ti-map-pin"></i>
                                            Location Information
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="data-label">GPS Coordinates:</div>
                                                <div class="data-value">${gps.latitude}, ${gps.longitude}</div>
                                            </div>
                                            ${vitalSignsData.location.lbs ? `
                                                <div class="col-md-6">
                                                    <div class="data-label">LBS Location:</div>
                                                    <div class="data-value">
                                                        MCC: ${vitalSignsData.location.lbs.MCC || 'N/A'}, 
                                                        MNC: ${vitalSignsData.location.lbs.MNC || 'N/A'}, 
                                                        LAC: ${vitalSignsData.location.lbs.LAC || 'N/A'}, 
                                                        CID: ${vitalSignsData.location.lbs.CID || 'N/A'}
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Create raw data section
            let rawDataSection = '';
            if (vitalSignsData.raw_data) {
                rawDataSection = `
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="ti ti-code"></i>
                                        Raw Data
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <pre class="bg-light p-3 rounded"><code>${JSON.stringify(vitalSignsData.raw_data, null, 2)}</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Combine all sections
            content.innerHTML = `
                ${patientInfo}
                ${vitalSignsDisplay}
                ${locationInfo}
                ${rawDataSection}
            `;
        }
        
        // Display location details with Google Maps
        function displayLocationDetails(locationData, transaction) {
            console.log('Displaying location details:', locationData);
            // Store current location data globally for enhanced info access
            window.currentLocationData = locationData;
            const content = document.getElementById('locationModalContent');
            const topic = transaction.topic;
            const isEmergency = topic === 'iMEDE_watch/sos' || topic === 'iMEDE_watch/fallDown';
            
            // Create enhanced patient info section
            let patientInfo = '';
            const enhancedPatientInfo = locationData.enhanced_patient_info;
            
            if (enhancedPatientInfo) {
                const patientName = `${enhancedPatientInfo.first_name || ''} ${enhancedPatientInfo.last_name || ''}`.trim() || 'Unknown Patient';
                const patientPhoto = enhancedPatientInfo.profile_image ? `<img src="${enhancedPatientInfo.profile_image}" alt="Patient Photo" class="avatar avatar-sm me-2" onerror="this.style.display='none'">` : '';
                
                // Hospital and ward information
                let hospitalWardInfo = '';
                if (enhancedPatientInfo.hospital_name || enhancedPatientInfo.ward_name) {
                    hospitalWardInfo = `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="text-primary mb-2">
                                    <i class="ti ti-building-hospital"></i>
                                    Hospital Information
                                </h6>
                                <div class="row">
                                    ${enhancedPatientInfo.hospital_name ? `
                                        <div class="col-md-6">
                                            <div class="data-label">Hospital:</div>
                                            <div class="data-value">${enhancedPatientInfo.hospital_name}</div>
                                        </div>
                                    ` : ''}
                                    ${enhancedPatientInfo.ward_name ? `
                                        <div class="col-md-6">
                                            <div class="data-label">Ward:</div>
                                            <div class="data-value">${enhancedPatientInfo.ward_name}</div>
                                        </div>
                                    ` : ''}
                                    ${enhancedPatientInfo.room_number ? `
                                        <div class="col-md-6">
                                            <div class="data-label">Room:</div>
                                            <div class="data-value">${enhancedPatientInfo.room_number}</div>
                                        </div>
                                    ` : ''}
                                    ${enhancedPatientInfo.admission_date ? `
                                        <div class="col-md-6">
                                            <div class="data-label">Admission Date:</div>
                                            <div class="data-value">${enhancedPatientInfo.admission_date}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Contact information
                let contactInfo = '';
                if (enhancedPatientInfo.mobile_phone || enhancedPatientInfo.emergency_contact) {
                    contactInfo = `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="text-info mb-2">
                                    <i class="ti ti-phone"></i>
                                    Contact Information
                                </h6>
                                <div class="row">
                                    ${enhancedPatientInfo.mobile_phone ? `
                                        <div class="col-md-6">
                                            <div class="data-label">Mobile Phone:</div>
                                            <div class="data-value">${enhancedPatientInfo.mobile_phone}</div>
                                        </div>
                                    ` : ''}
                                    ${enhancedPatientInfo.emergency_contact ? `
                                        <div class="col-md-6">
                                            <div class="data-label">Emergency Contact:</div>
                                            <div class="data-value">${enhancedPatientInfo.emergency_contact}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Medical information
                let medicalInfo = '';
                if (enhancedPatientInfo.underlying_conditions && enhancedPatientInfo.underlying_conditions.length > 0 || 
                    enhancedPatientInfo.allergies && enhancedPatientInfo.allergies.length > 0) {
                    medicalInfo = `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="text-warning mb-2">
                                    <i class="ti ti-heartbeat"></i>
                                    Medical Information
                                </h6>
                                <div class="row">
                                    ${enhancedPatientInfo.underlying_conditions && enhancedPatientInfo.underlying_conditions.length > 0 ? `
                                        <div class="col-md-6">
                                            <div class="data-label">Underlying Conditions:</div>
                                            <div class="data-value">
                                                ${enhancedPatientInfo.underlying_conditions.map(condition => 
                                                    `<span class="badge bg-warning text-dark me-1 mb-1">${condition}</span>`
                                                ).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${enhancedPatientInfo.allergies && enhancedPatientInfo.allergies.length > 0 ? `
                                        <div class="col-md-6">
                                            <div class="data-label">Allergies:</div>
                                            <div class="data-value">
                                                ${enhancedPatientInfo.allergies.map(allergy => 
                                                    `<span class="badge bg-danger me-1 mb-1">${allergy}</span>`
                                                ).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                patientInfo = `
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="ti ti-user"></i>
                                        Patient Information
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        ${patientPhoto}
                                        <div>
                                            <h6 class="mb-1">${patientName}</h6>
                                            <div class="text-muted">Device: ${transaction.device_id || 'N/A'}</div>
                                            <div class="text-muted">Topic: ${topic}</div>
                                            <div class="text-muted">Timestamp: ${formatLocalTimestamp(new Date(transaction.timestamp))}</div>
                                        </div>
                                    </div>
                                    ${hospitalWardInfo}
                                    ${contactInfo}
                                    ${medicalInfo}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (transaction.patient_info) {
                // Fallback to basic patient info if enhanced info not available
                const info = transaction.patient_info;
                const patientName = `${info.first_name || ''} ${info.last_name || ''}`.trim() || 'Unknown Patient';
                const patientPhoto = info.profile_image ? `<img src="${info.profile_image}" alt="Patient Photo" class="avatar avatar-sm me-2" onerror="this.style.display='none'">` : '';
                
                patientInfo = `
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        ${patientPhoto}
                                        <div>
                                            <h6 class="mb-1">${patientName}</h6>
                                            <div class="text-muted">Device: ${transaction.device_id || 'N/A'}</div>
                                            <div class="text-muted">Topic: ${topic}</div>
                                            <div class="text-muted">Timestamp: ${formatLocalTimestamp(new Date(transaction.timestamp))}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Create location info section
            let locationInfo = '';
            if (locationData.location) {
                const location = locationData.location;
                const locationSource = locationData.location_source || 'Unknown';
                const locationSourceIcon = locationSource === 'GPS' ? 'ti ti-satellite' : 
                                          locationSource === 'LBS' ? 'ti ti-signal' : 
                                          locationSource === 'WiFi' ? 'ti ti-wifi' : 'ti ti-map-pin';
                const locationSourceColor = locationSource === 'GPS' ? 'text-success' : 
                                           locationSource === 'LBS' ? 'text-warning' : 
                                           locationSource === 'WiFi' ? 'text-info' : 'text-muted';
                
                locationInfo = `
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="ti ti-map-pin"></i>
                                        Location Information
                                        <span class="badge ${locationSourceColor} ms-2">
                                            <i class="${locationSourceIcon}"></i>
                                            ${locationSource}
                                        </span>
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        ${location.GPS ? `
                                            <div class="col-md-6">
                                                <h6 class="text-success">
                                                    <i class="ti ti-satellite"></i>
                                                    GPS Coordinates
                                                </h6>
                                                <div class="data-label">Latitude:</div>
                                                <div class="data-value">${location.GPS.latitude || 'N/A'}</div>
                                                <div class="data-label">Longitude:</div>
                                                <div class="data-value">${location.GPS.longitude || 'N/A'}</div>
                                                ${location.GPS.speed ? `
                                                    <div class="data-label">Speed:</div>
                                                    <div class="data-value">${location.GPS.speed} km/h</div>
                                                ` : ''}
                                                ${location.GPS.header ? `
                                                    <div class="data-label">Heading:</div>
                                                    <div class="data-value">${location.GPS.header}°</div>
                                                ` : ''}
                                            </div>
                                        ` : ''}
                                        ${location.LBS ? `
                                            <div class="col-md-6">
                                                <h6 class="text-warning">
                                                    <i class="ti ti-signal"></i>
                                                    LBS (Cell Tower)
                                                </h6>
                                                <div class="data-label">MCC (Mobile Country Code):</div>
                                                <div class="data-value">${location.LBS.MCC || 'N/A'}</div>
                                                <div class="data-label">MNC (Mobile Network Code):</div>
                                                <div class="data-value">${location.LBS.MNC || 'N/A'}</div>
                                                <div class="data-label">LAC (Location Area Code):</div>
                                                <div class="data-value">${location.LBS.LAC || 'N/A'}</div>
                                                <div class="data-label">CID (Cell ID):</div>
                                                <div class="data-value">${location.LBS.CID || 'N/A'}</div>
                                                ${location.LBS.latitude && location.LBS.longitude ? `
                                                    <div class="data-label">Estimated Coordinates:</div>
                                                    <div class="data-value">${location.LBS.latitude}, ${location.LBS.longitude}</div>
                                                ` : ''}
                                            </div>
                                        ` : ''}
                                        ${location.WiFi ? `
                                            <div class="col-md-6">
                                                <h6 class="text-info">
                                                    <i class="ti ti-wifi"></i>
                                                    WiFi Networks
                                                </h6>
                                                ${typeof location.WiFi === 'string' ? `
                                                    <div class="data-value">${location.WiFi}</div>
                                                ` : location.WiFi.latitude && location.WiFi.longitude ? `
                                                    <div class="data-label">Estimated Coordinates:</div>
                                                    <div class="data-value">${location.WiFi.latitude}, ${location.WiFi.longitude}</div>
                                                    ${location.WiFi.networks ? `
                                                        <div class="data-label">Available Networks:</div>
                                                        <div class="data-value">
                                                            ${location.WiFi.networks.map(network => 
                                                                `<span class="badge bg-info me-1 mb-1">${network.ssid || network}</span>`
                                                            ).join('')}
                                                        </div>
                                                    ` : ''}
                                                ` : `
                                                    <div class="data-value">${JSON.stringify(location.WiFi)}</div>
                                                `}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Create Google Maps section
            let mapSection = '';
            if (locationData.coordinates) {
                const coords = locationData.coordinates;
                mapSection = `
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="ti ti-map"></i>
                                        Location Map
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="google-map" style="height: 400px; width: 100%; border-radius: 8px;">
                                        <div class="text-center" style="padding-top: 150px;">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading map...</span>
                                            </div>
                                            <p class="mt-2">Loading Google Map...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Create hospital info section (for emergency alerts)
            let hospitalInfo = '';
            if (isEmergency && locationData.hospital) {
                const hospital = locationData.hospital;
                hospitalInfo = `
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="card-title mb-0">
                                        <i class="ti ti-building-hospital"></i>
                                        Nearest Hospital
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>${hospital.name || 'Unknown Hospital'}</h6>
                                            <div class="text-muted">${hospital.address || 'Address not available'}</div>
                                            <div class="text-muted">${hospital.phone || 'Phone not available'}</div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="text-end">
                                                <div class="h4 text-warning">${hospital.distance || 'N/A'} km</div>
                                                <div class="text-muted">Distance from patient</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Combine all sections
            content.innerHTML = patientInfo + mapSection + locationInfo + hospitalInfo;
            
            // Initialize Google Maps if coordinates are available
            if (locationData.coordinates) {
                console.log('Coordinates available, initializing map:', locationData.coordinates);
                setTimeout(async () => {
                    try {
                        await initializeGoogleMap(locationData.coordinates, locationData.hospital, isEmergency);
                    } catch (error) {
                        console.error('Error initializing map:', error);
                    }
                }, 100);
            } else {
                console.log('No coordinates available for map initialization');
            }
        }
        
        // Initialize Google Maps
        async function initializeGoogleMap(patientCoords, hospitalCoords, isEmergency) {
            const mapElement = document.getElementById('google-map');
            if (!mapElement) {
                console.error('Google map element not found');
                return;
            }
            
            try {
                // Wait for Google Maps API to be ready
                await waitForGoogleMapsAPI();
                console.log('Initializing Google Map with coordinates:', patientCoords);
            
            // Create map centered on patient location
            const map = new google.maps.Map(mapElement, {
                zoom: 15,
                center: { lat: patientCoords.lat, lng: patientCoords.lng },
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                mapId: 'KATI_LOCATION_DETIAL_POPUP' // Custom Map ID for Kati Location Details
            });
            
            // Add patient marker using AdvancedMarkerElement
            const patientMarkerElement = document.createElement('div');
            patientMarkerElement.innerHTML = isEmergency ? `
                <div style="width: 32px; height: 32px; background: red; border: 2px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">!</div>
            ` : `
                <div style="width: 32px; height: 32px; background: blue; border: 2px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">P</div>
            `;
            
            const patientMarker = new google.maps.marker.AdvancedMarkerElement({
                position: { lat: patientCoords.lat, lng: patientCoords.lng },
                map: map,
                title: 'Patient Location',
                content: patientMarkerElement
            });
            
            // Add patient info window
            const patientInfoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="padding: 8px;">
                        <h6 style="margin: 0 0 4px 0; color: ${isEmergency ? 'red' : 'blue'};">${isEmergency ? 'Emergency Alert' : 'Patient Location'}</h6>
                        <p style="margin: 0; font-size: 12px;">Lat: ${patientCoords.lat.toFixed(6)}<br>Lng: ${patientCoords.lng.toFixed(6)}</p>
                    </div>
                `
            });
            
            patientMarker.addListener('click', () => {
                patientInfoWindow.open(map, patientMarker);
            });
            
            // Add hospital marker if available
            if (hospitalCoords) {
                const hospitalMarkerElement = document.createElement('div');
                hospitalMarkerElement.innerHTML = `
                    <div style="width: 32px; height: 32px; background: green; border: 2px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">H</div>
                `;
                
                const hospitalMarker = new google.maps.marker.AdvancedMarkerElement({
                    position: { lat: hospitalCoords.lat, lng: hospitalCoords.lng },
                    map: map,
                    title: 'Nearest Hospital',
                    content: hospitalMarkerElement
                });
                
                // Add hospital info window
                const hospitalInfoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 8px;">
                            <h6 style="margin: 0 0 4px 0; color: green;">Nearest Hospital</h6>
                            <p style="margin: 0; font-size: 12px;">${hospitalCoords.name || 'Hospital'}<br>Distance: ${hospitalCoords.distance || 'N/A'} km</p>
                        </div>
                    `
                });
                
                hospitalMarker.addListener('click', () => {
                    hospitalInfoWindow.open(map, hospitalMarker);
                });
                
                // Draw route between patient and hospital
                const directionsService = new google.maps.DirectionsService();
                const directionsRenderer = new google.maps.DirectionsRenderer({
                    map: map,
                    suppressMarkers: true // We'll add our own markers
                });
                
                directionsService.route({
                    origin: { lat: patientCoords.lat, lng: patientCoords.lng },
                    destination: { lat: hospitalCoords.lat, lng: hospitalCoords.lng },
                    travelMode: google.maps.TravelMode.DRIVING
                }, (result, status) => {
                    if (status === 'OK') {
                        directionsRenderer.setDirections(result);
                    }
                });
            }
            } catch (error) {
                console.error('Error initializing Google Map:', error);
                // Show error message in the map container
                mapElement.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="ti ti-alert-circle"></i>
                        Error loading map: ${error.message}
                    </div>
                `;
            }
        }
        
        // ========================================
        // GOOGLE MAPS API UTILITY FUNCTIONS
        // ========================================
        
        // Wait for Google Maps API to be ready
        function waitForGoogleMapsAPI() {
            return new Promise((resolve, reject) => {
                const maxAttempts = 50; // 5 seconds max wait
                let attempts = 0;
                
                const checkAPI = () => {
                    attempts++;
                    if (typeof google !== 'undefined' && google.maps) {
                        console.log('Google Maps API ready');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('Google Maps API failed to load within timeout'));
                    } else {
                        setTimeout(checkAPI, 100);
                    }
                };
                
                checkAPI();
            });
        }
        
        // ========================================
        // GOOGLE PLACES API FUNCTIONS
        // ========================================
        
        // Search for nearby hospitals using Places API (Updated to avoid deprecated PlacesService)
        async function searchNearbyHospitals(lat, lng, radius = 5000) {
            await waitForGoogleMapsAPI();
            
            // Use the newer Places API with fetch instead of deprecated PlacesService
            const location = `${lat},${lng}`;
            const url = `https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=${location}&radius=${radius}&type=hospital&key=${GOOGLE_MAPS_API_KEY}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.status === 'OK') {
                    return data.results;
                } else {
                    throw new Error(`Places API error: ${data.status}`);
                }
            } catch (error) {
                console.error('Error searching for hospitals:', error);
                return [];
            }
        }
        
        // Get place details using Places API (Updated to avoid deprecated PlacesService)
        async function getPlaceDetails(placeId) {
            await waitForGoogleMapsAPI();
            
            // Use the newer Places API with fetch instead of deprecated PlacesService
            const url = `https://maps.googleapis.com/maps/api/place/details/json?place_id=${placeId}&fields=name,formatted_address,formatted_phone_number,geometry,rating,opening_hours&key=${GOOGLE_MAPS_API_KEY}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.status === 'OK') {
                    return data.result;
                } else {
                    throw new Error(`Places API error: ${data.status}`);
                }
            } catch (error) {
                console.error('Error getting place details:', error);
                return null;
            }
        }
        
        // Search for places by text query (Updated to avoid deprecated PlacesService)
        async function searchPlaces(query, location, radius = 5000) {
            await waitForGoogleMapsAPI();
            
            // Use the newer Places API with fetch instead of deprecated PlacesService
            const locationStr = `${location.lat},${location.lng}`;
            const url = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(query)}&location=${locationStr}&radius=${radius}&key=${GOOGLE_MAPS_API_KEY}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.status === 'OK') {
                    return data.results;
                } else {
                    throw new Error(`Places API error: ${data.status}`);
                }
            } catch (error) {
                console.error('Error searching for places:', error);
                return [];
            }
        }
        
        // ========================================
        // GOOGLE GEOLOCATION API FUNCTIONS
        // ========================================
        
        // Get current user location using browser geolocation
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation is not supported by this browser'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        });
                    },
                    (error) => {
                        reject(new Error(`Geolocation error: ${error.message}`));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            });
        }
        
        // Calculate distance between two points using Google Geometry library
        async function calculateDistance(point1, point2) {
            await waitForGoogleMapsAPI();
            
            const latLng1 = new google.maps.LatLng(point1.lat, point1.lng);
            const latLng2 = new google.maps.LatLng(point2.lat, point2.lng);
            return google.maps.geometry.spherical.computeDistanceBetween(latLng1, latLng2);
        }
        
        // Calculate area of a polygon using Google Geometry library
        async function calculatePolygonArea(points) {
            await waitForGoogleMapsAPI();
            
            const path = points.map(point => new google.maps.LatLng(point.lat, point.lng));
            return google.maps.geometry.spherical.computeArea(path);
        }
        
        // ========================================
        // ENHANCED LOCATION FUNCTIONS
        // ========================================
        
        // Enhanced location details with Places API integration
        async function getEnhancedLocationDetails(lat, lng) {
            try {
                // Get nearby hospitals
                const hospitals = await searchNearbyHospitals(lat, lng);
                
                // Get place details for the first hospital
                let hospitalDetails = null;
                if (hospitals.length > 0) {
                    hospitalDetails = await getPlaceDetails(hospitals[0].place_id);
                }
                
                // Search for nearby emergency services
                const emergencyServices = await searchPlaces('emergency services', { lat: parseFloat(lat), lng: parseFloat(lng) });
                
                return {
                    hospitals: hospitals,
                    nearestHospital: hospitalDetails,
                    emergencyServices: emergencyServices,
                    coordinates: { lat: parseFloat(lat), lng: parseFloat(lng) }
                };
            } catch (error) {
                console.error('Error getting enhanced location details:', error);
                return null;
            }
        }
        
        // Display enhanced location information
        async function displayEnhancedLocationInfo(locationData) {
            if (!locationData) return;
            
            let content = '';
            
            // Display nearest hospital
            if (locationData.nearestHospital) {
                const hospital = locationData.nearestHospital;
                content += `
                    <div class="alert alert-info">
                        <h6><i class="ti ti-building-hospital"></i> Nearest Hospital</h6>
                        <p><strong>${hospital.name}</strong></p>
                        <p>${hospital.formatted_address || 'Address not available'}</p>
                        <p>${hospital.formatted_phone_number || 'Phone not available'}</p>
                        ${hospital.rating ? `<p>Rating: ${hospital.rating}/5</p>` : ''}
                    </div>
                `;
            }
            
            // Display emergency services
            if (locationData.emergencyServices && locationData.emergencyServices.length > 0) {
                content += '<div class="alert alert-warning">';
                content += '<h6><i class="ti ti-alert-triangle"></i> Nearby Emergency Services</h6>';
                locationData.emergencyServices.slice(0, 3).forEach(service => {
                    content += `
                        <div class="mb-2">
                            <strong>${service.name}</strong><br>
                            <small>${service.formatted_address || 'Address not available'}</small>
                        </div>
                    `;
                });
                content += '</div>';
            }
            
            // Display distance calculations
            if (locationData.coordinates) {
                try {
                    const currentLocation = { lat: 13.7563, lng: 100.5018 }; // Bangkok center as example
                    const distance = await calculateDistance(currentLocation, locationData.coordinates);
                    content += `
                        <div class="alert alert-secondary">
                            <h6><i class="ti ti-map-pin"></i> Distance Information</h6>
                            <p>Distance from Bangkok center: ${(distance / 1000).toFixed(2)} km</p>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error calculating distance:', error);
                    content += `
                        <div class="alert alert-secondary">
                            <h6><i class="ti ti-map-pin"></i> Distance Information</h6>
                            <p>Distance calculation unavailable</p>
                        </div>
                    `;
                }
            }
            
            // Display the content in a modal or designated area
            const enhancedInfoContainer = document.getElementById('enhanced-location-info');
            if (enhancedInfoContainer) {
                enhancedInfoContainer.innerHTML = content;
            }
        }
        
        // Load enhanced location information for current location
        async function loadEnhancedLocationInfo() {
            const modalContent = document.getElementById('locationModalContent');
            const enhancedInfoContainer = document.getElementById('enhanced-location-info');
            
            if (!enhancedInfoContainer) {
                // Create enhanced info container if it doesn't exist
                const container = document.createElement('div');
                container.id = 'enhanced-location-info';
                container.className = 'mt-3';
                modalContent.appendChild(container);
            }
            
            // Show loading state
            const container = document.getElementById('enhanced-location-info');
            container.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading enhanced location information...</p>
                </div>
            `;
            
            try {
                // Get current location coordinates from the map or stored data
                const mapElement = document.getElementById('google-map');
                if (mapElement && window.currentLocationData && window.currentLocationData.coordinates) {
                    const coords = window.currentLocationData.coordinates;
                    
                    // Get enhanced location details
                    const enhancedData = await getEnhancedLocationDetails(coords.lat, coords.lng);
                    
                    if (enhancedData) {
                        await displayEnhancedLocationInfo(enhancedData);
                    } else {
                        container.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="ti ti-alert-triangle"></i>
                                Unable to load enhanced location information
                            </div>
                        `;
                    }
                } else {
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="ti ti-alert-triangle"></i>
                            No location data available for enhanced information
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading enhanced location info:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="ti ti-alert-circle"></i>
                        Error loading enhanced location information: ${error.message}
                    </div>
                `;
            }
        }
        
        // ========================================
        // ENHANCED SOS EMERGENCY FUNCTIONS
        // ========================================
        
        // Show emergency details modal
        function showEmergencyDetails() {
            const modal = new bootstrap.Modal(document.getElementById('emergencyDetailsModal'));
            loadEmergencyAlerts();
            modal.show();
        }
        
        // Load emergency alerts for the modal
        async function loadEmergencyAlerts() {
            try {
                const response = await fetch('/api/kati-transactions?topic_filter=SOS,fallDown&limit=50');
                const data = await response.json();
                
                if (data.success && data.data && data.data.transactions && Array.isArray(data.data.transactions)) {
                    const emergencyAlerts = data.data.transactions.filter(t => 
                        t.topic === 'iMEDE_watch/SOS' || t.topic === 'iMEDE_watch/fallDown'
                    );
                    
                    updateEmergencyModalStats(emergencyAlerts);
                    displayEmergencyAlerts(emergencyAlerts);
                } else {
                    // Handle case where transactions is undefined or not an array
                    console.warn('No transactions data available or invalid format:', data);
                    updateEmergencyModalStats([]);
                    displayEmergencyAlerts([]);
                }
            } catch (error) {
                console.error('Error loading emergency alerts:', error);
                document.getElementById('emergency-alerts-list').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="ti ti-alert-circle"></i>
                        Error loading emergency alerts: ${error.message}
                    </div>
                `;
            }
        }
        
        // Update emergency modal statistics
        function updateEmergencyModalStats(alerts) {
            if (!alerts || !Array.isArray(alerts)) {
                alerts = [];
            }
            
            const sosCount = alerts.filter(a => a.topic === 'iMEDE_watch/SOS').length;
            const fallCount = alerts.filter(a => a.topic === 'iMEDE_watch/fallDown').length;
            
            const emergencyCountElement = document.getElementById('modal-emergency-count');
            const sosCountElement = document.getElementById('modal-sos-count');
            const fallCountElement = document.getElementById('modal-fall-count');
            
            if (emergencyCountElement) emergencyCountElement.textContent = alerts.length;
            if (sosCountElement) sosCountElement.textContent = sosCount;
            if (fallCountElement) fallCountElement.textContent = fallCount;
        }
        
        // Display emergency alerts in the modal
        function displayEmergencyAlerts(alerts) {
            const container = document.getElementById('emergency-alerts-list');
            
            if (!container) {
                console.error('Emergency alerts container not found');
                return;
            }
            
            if (!alerts || !Array.isArray(alerts) || alerts.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="ti ti-check-circle fa-3x mb-3"></i>
                        <p class="mb-0">No active emergency alerts</p>
                        <small>All alerts have been resolved</small>
                    </div>
                `;
                return;
            }
            
            let content = '';
            alerts.forEach(alert => {
                const alertType = alert.topic === 'iMEDE_watch/SOS' ? 'SOS Signal' : 'Fall Detection';
                const alertIcon = alert.topic === 'iMEDE_watch/SOS' ? 'ti-alert-triangle' : 'ti-user-exclamation';
                const alertColor = alert.topic === 'iMEDE_watch/SOS' ? 'danger' : 'warning';
                
                content += `
                    <div class="emergency-alert-item">
                        <div class="emergency-alert-header">
                            <span class="emergency-alert-time">${formatTimestamp(alert.timestamp)}</span>
                            <span class="emergency-alert-type bg-${alertColor}">${alertType}</span>
                        </div>
                        <div class="emergency-alert-patient">
                            <i class="ti ${alertIcon} me-2"></i>
                            ${alert.patient_name || 'Unknown Patient'} (${alert.device_id || 'Unknown Device'})
                        </div>
                        <div class="small text-muted">
                            ${getAlertDescription(alert)}
                        </div>
                        ${alert.location ? `
                            <div class="emergency-alert-location">
                                <i class="ti ti-map-pin me-1"></i>
                                <strong>Location:</strong> ${alert.location}
                            </div>
                        ` : ''}
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-${alertColor}" onclick="viewAlertDetails('${alert.id}')">
                                <i class="ti ti-eye me-1"></i>
                                View Details
                            </button>
                            <button class="btn btn-sm btn-success" onclick="acknowledgeAlert('${alert.id}')">
                                <i class="ti ti-check me-1"></i>
                                Acknowledge
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = content;
        }
        
        // Get alert description based on alert type and data
        function getAlertDescription(alert) {
            if (alert.topic === 'iMEDE_watch/SOS') {
                return 'Emergency SOS signal detected. Patient may require immediate medical attention.';
            } else if (alert.topic === 'iMEDE_watch/fallDown') {
                return 'Fall detection alert triggered. Patient may have fallen and needs assistance.';
            }
            return 'Emergency alert detected.';
        }
        
        // View detailed alert information
        function viewAlertDetails(alertId) {
            // Find the alert in the current data
            const alert = window.currentKatiData?.find(t => t.id === alertId);
            if (alert) {
                // Show location details if available
                if (alert.location) {
                    showLocationDetails(alert);
                } else {
                    // Show basic alert details
                    showBasicAlertDetails(alert);
                }
            }
        }
        
        // Show basic alert details
        function showBasicAlertDetails(alert) {
            const alertType = alert.topic === 'iMEDE_watch/SOS' ? 'SOS Signal' : 'Fall Detection';
            const alertIcon = alert.topic === 'iMEDE_watch/SOS' ? 'ti-alert-triangle' : 'ti-user-exclamation';
            
            const content = `
                <div class="alert alert-info">
                    <h6><i class="ti ${alertIcon} me-2"></i>${alertType} Details</h6>
                    <p><strong>Patient:</strong> ${alert.patient_name || 'Unknown'}</p>
                    <p><strong>Device:</strong> ${alert.device_id || 'Unknown'}</p>
                    <p><strong>Time:</strong> ${formatTimestamp(alert.timestamp)}</p>
                    <p><strong>Status:</strong> <span class="badge bg-warning">Active</span></p>
                    ${alert.raw_data ? `
                        <details class="mt-2">
                            <summary>Raw Data</summary>
                            <pre class="mt-2 small">${JSON.stringify(alert.raw_data, null, 2)}</pre>
                        </details>
                    ` : ''}
                </div>
            `;
            
            // Show in a simple alert or update the modal
            alert(content);
        }
        
        // Acknowledge a single alert
        async function acknowledgeAlert(alertId) {
            try {
                // Here you would typically make an API call to acknowledge the alert
                console.log(`Acknowledging alert: ${alertId}`);
                
                // For now, just show a success message
                showToast('Alert acknowledged successfully', 'success');
                
                // Refresh the emergency alerts
                loadEmergencyAlerts();
                
            } catch (error) {
                console.error('Error acknowledging alert:', error);
                showToast('Error acknowledging alert', 'error');
            }
        }
        
        // Acknowledge all alerts
        async function acknowledgeAllAlerts() {
            try {
                // Here you would typically make an API call to acknowledge all alerts
                console.log('Acknowledging all alerts');
                
                // For now, just show a success message
                showToast('All alerts acknowledged successfully', 'success');
                
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('emergencyDetailsModal'));
                modal.hide();
                
                // Update the main emergency card
                updateEmergencyCard(0);
                
            } catch (error) {
                console.error('Error acknowledging all alerts:', error);
                showToast('Error acknowledging alerts', 'error');
            }
        }
        
        // Update emergency card with ultra-enhanced styling
        function updateEmergencyCard(count, sosCount = 0, fallCount = 0, newAlerts = 0) {
            const emergencyCard = document.getElementById('emergency-card');
            const emergencyCount = document.getElementById('emergency-count');
            const emergencyCountShadow = document.querySelector('.emergency-number-shadow');
            const emergencyStatus = document.getElementById('emergency-status');
            const emergencyTrend = document.getElementById('emergency-trend');
            const sosCountElement = document.getElementById('sos-count');
            const fallCountElement = document.getElementById('fall-count');
            const severityBadge = document.getElementById('emergency-severity-badge');
            
            if (count > 0) {
                emergencyCard.style.display = 'block';
                emergencyCount.textContent = count;
                emergencyCountShadow.textContent = count;
                
                // Update status with enhanced styling
                emergencyStatus.innerHTML = `
                    <div class="status-indicator">
                        <i class="ti ti-clock"></i>
                        <span>Active</span>
                    </div>
                `;
                
                // Update trend if there are new alerts
                if (newAlerts > 0) {
                    emergencyTrend.innerHTML = `
                        <div class="trend-indicator">
                            <i class="ti ti-trending-up"></i>
                            <span>+${newAlerts} new</span>
                        </div>
                    `;
                    emergencyTrend.style.display = 'flex';
                } else {
                    emergencyTrend.style.display = 'none';
                }
                
                // Update breakdown with enhanced styling
                sosCountElement.textContent = sosCount;
                fallCountElement.textContent = fallCount;
                
                // Add enhanced visual effects
                emergencyCard.classList.add('emergency-active');
                
                // Update badge based on severity with enhanced styling
                const badge = severityBadge.querySelector('.badge');
                if (count >= 10) {
                    badge.textContent = 'CRITICAL';
                    badge.className = 'badge bg-danger';
                    emergencyCard.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 30%, #a71e2a 60%, #8b1a1a 100%)';
                } else if (count >= 5) {
                    badge.textContent = 'HIGH';
                    badge.className = 'badge bg-warning';
                    emergencyCard.style.background = 'linear-gradient(135deg, #fd7e14 0%, #e55a00 30%, #cc4a00 60%, #b33a00 100%)';
                } else {
                    badge.textContent = 'ACTIVE';
                    badge.className = 'badge bg-info';
                    emergencyCard.style.background = 'linear-gradient(135deg, #17a2b8 0%, #138496 30%, #117a8b 60%, #0f6674 100%)';
                }
                
                // Add emergency sound indicator functionality
                const soundIndicator = document.getElementById('emergency-sound-indicator');
                if (soundIndicator) {
                    soundIndicator.onclick = function(e) {
                        e.stopPropagation();
                        toggleEmergencySound();
                    };
                }
                
            } else {
                emergencyCard.style.display = 'none';
            }
        }
        
        // Toggle emergency sound
        function toggleEmergencySound() {
            const soundIndicator = document.getElementById('emergency-sound-indicator');
            const icon = soundIndicator.querySelector('i');
            
            if (icon.classList.contains('ti-volume')) {
                icon.classList.remove('ti-volume');
                icon.classList.add('ti-volume-off');
                showToast('Emergency alerts muted', 'warning');
            } else {
                icon.classList.remove('ti-volume-off');
                icon.classList.add('ti-volume');
                showToast('Emergency alerts enabled', 'success');
            }
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            // Add to page
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            toastContainer.appendChild(toast);
            
            // Show toast
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // Remove after hidden
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }
        
        // Create toast container if it doesn't exist
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
            return container;
        }
        
        // Test function to demonstrate enhanced SOS UX
        function testEnhancedSOS() {
            // Simulate different emergency scenarios
            const scenarios = [
                { count: 3, sos: 2, fall: 1, new: 1, severity: 'low' },
                { count: 8, sos: 5, fall: 3, new: 3, severity: 'medium' },
                { count: 16, sos: 10, fall: 6, new: 5, severity: 'high' }
            ];
            
            let currentScenario = 0;
            
            const cycleScenarios = () => {
                const scenario = scenarios[currentScenario];
                updateEmergencyCard(scenario.count, scenario.sos, scenario.fall, scenario.new);
                
                showToast(`Testing ${scenario.severity} emergency scenario: ${scenario.count} alerts`, 'info');
                
                currentScenario = (currentScenario + 1) % scenarios.length;
            };
            
            // Start with first scenario
            cycleScenarios();
            
            // Cycle through scenarios every 5 seconds
            setInterval(cycleScenarios, 5000);
        }
        
        // Initialize enhanced SOS testing (for demonstration)
        document.addEventListener('DOMContentLoaded', function() {
            // Uncomment the line below to test the enhanced SOS UX
            // testEnhancedSOS();
        });

        // Sleep Data Analysis Functions
        function viewSleepData(transactionId) {
            const transaction = katiData.find(t => t._id === transactionId);
            if (!transaction) {
                alert('Transaction not found');
                return;
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('sleepDataModal'));
            modal.show();
            
            // Fetch detailed sleep data
            fetch(`/api/kati-transactions/${transactionId}/sleep-details`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displaySleepData(data.data, transaction);
                    } else {
                        document.getElementById('sleepModalContent').innerHTML = `
                            <div class="alert alert-danger">
                                <i class="ti ti-alert-circle"></i>
                                Error: ${data.error || 'Failed to load sleep data'}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error fetching sleep data:', error);
                    document.getElementById('sleepModalContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="ti ti-alert-circle"></i>
                            Error: Failed to load sleep data
                        </div>
                    `;
                });
        }
        
        // Display sleep data analysis
        function displaySleepData(sleepData, transaction) {
            const content = document.getElementById('sleepModalContent');
            const sleep = sleepData.sleep || {};
            
            // Parse sleep data
            const sleepPattern = sleep.data || '';
            const sleepTime = sleep.time || '';
            const sleepTimestamp = sleep.timeStamps || '';
            const sleepNum = sleep.num || 0;
            
            // Calculate sleep statistics
            const sleepStats = analyzeSleepPattern(sleepPattern);
            
            // Create sleep analysis HTML
            const sleepAnalysisHtml = `
                <div class="row">
                    <!-- Patient Information -->
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="ti ti-user"></i>
                                    Patient Information
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="data-label">Patient Name:</div>
                                        <div class="data-value">${transaction.patient_name || 'Unknown Patient'}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="data-label">Device IMEI:</div>
                                        <div class="data-value">${transaction.device_id || 'N/A'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sleep Overview -->
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="ti ti-moon"></i>
                                    Sleep Overview
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="data-label">Sleep Period:</div>
                                        <div class="data-value">${formatSleepTime(sleepTime)}</div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="data-label">Recording Date:</div>
                                        <div class="data-value">${formatSleepTimestamp(sleepTimestamp)}</div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="data-label">Total Duration:</div>
                                        <div class="data-value">${sleepStats.totalHours}h ${sleepStats.totalMinutes}m</div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="data-label">Data Points:</div>
                                        <div class="data-value">${sleepNum} (${sleepPattern.length})</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sleep Pattern Visualization -->
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="ti ti-chart-line"></i>
                                    Sleep Pattern Visualization
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="sleep-pattern-container">
                                    ${generateSleepPatternVisualization(sleepPattern, sleepTime)}
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="ti ti-info-circle"></i>
                                        Each block represents 5 minutes. 
                                        <span class="text-warning">Yellow</span> = Awake, 
                                        <span class="text-info">Blue</span> = Light Sleep, 
                                        <span class="text-primary">Dark Blue</span> = Deep Sleep
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sleep Recommendations -->
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="ti ti-lightbulb"></i>
                                    Sleep Quality Assessment
                                </h6>
                            </div>
                            <div class="card-body">
                                ${generateSleepRecommendations(sleepStats)}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Export Section -->
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="ti ti-download"></i>
                                    Export Sleep Data
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-2">
                                        <button class="btn btn-outline-primary w-100" onclick="exportSleepDataPDF('${transaction.patient_name || 'Unknown Patient'}', '${transaction.device_id || 'N/A'}', '${sleepTime}', '${sleepTimestamp}', '${sleepPattern}', ${JSON.stringify(sleepStats)})">
                                            <i class="ti ti-file-text"></i>
                                            Export PDF Report
                                        </button>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <button class="btn btn-outline-success w-100" onclick="exportSleepDataCSV('${transaction.patient_name || 'Unknown Patient'}', '${transaction.device_id || 'N/A'}', '${sleepTime}', '${sleepTimestamp}', '${sleepPattern}', ${JSON.stringify(sleepStats)})">
                                            <i class="ti ti-file-spreadsheet"></i>
                                            Export CSV Data
                                        </button>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <button class="btn btn-outline-info w-100" onclick="exportSleepDataJSON('${transaction.patient_name || 'Unknown Patient'}', '${transaction.device_id || 'N/A'}', '${sleepTime}', '${sleepTimestamp}', '${sleepPattern}', ${JSON.stringify(sleepStats)})">
                                            <i class="ti ti-code"></i>
                                            Export JSON Data
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="ti ti-info-circle"></i>
                                        Export includes patient information, sleep statistics, and detailed sleep pattern data for analysis and reporting.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = sleepAnalysisHtml;
        }
        
        // Analyze sleep pattern data
        function analyzeSleepPattern(sleepPattern) {
            if (!sleepPattern || sleepPattern.length === 0) {
                return {
                    awakeHours: 0, awakeMinutes: 0, awakePercentage: 0,
                    lightHours: 0, lightMinutes: 0, lightPercentage: 0,
                    deepHours: 0, deepMinutes: 0, deepPercentage: 0,
                    totalHours: 0, totalMinutes: 0,
                    sleepEfficiency: 0, deepSleepRatio: 0, sleepLatency: 0, wakeCount: 0
                };
            }
            
            const awake = (sleepPattern.match(/0/g) || []).length;
            const light = (sleepPattern.match(/1/g) || []).length;
            const deep = (sleepPattern.match(/2/g) || []).length;
            const total = sleepPattern.length;
            
            // Convert to minutes (each digit = 5 minutes)
            const awakeMinutes = awake * 5;
            const lightMinutes = light * 5;
            const deepMinutes = deep * 5;
            const totalMinutes = total * 5;
            
            // Convert to hours and minutes
            const awakeHours = Math.floor(awakeMinutes / 60);
            const lightHours = Math.floor(lightMinutes / 60);
            const deepHours = Math.floor(deepMinutes / 60);
            const totalHours = Math.floor(totalMinutes / 60);
            
            const awakeRemainingMinutes = awakeMinutes % 60;
            const lightRemainingMinutes = lightMinutes % 60;
            const deepRemainingMinutes = deepMinutes % 60;
            const totalRemainingMinutes = totalMinutes % 60;
            
            // Calculate percentages
            const awakePercentage = total > 0 ? Math.round((awake / total) * 100) : 0;
            const lightPercentage = total > 0 ? Math.round((light / total) * 100) : 0;
            const deepPercentage = total > 0 ? Math.round((deep / total) * 100) : 0;
            
            // Calculate sleep quality metrics
            const sleepEfficiency = total > 0 ? Math.round(((light + deep) / total) * 100) : 0;
            const deepSleepRatio = (light + deep) > 0 ? Math.round((deep / (light + deep)) * 100) : 0;
            
            // Calculate sleep latency (time to first sleep)
            let sleepLatency = 0;
            for (let i = 0; i < sleepPattern.length; i++) {
                if (sleepPattern[i] === '1' || sleepPattern[i] === '2') {
                    sleepLatency = i * 5;
                    break;
                }
            }
            
            // Calculate wake count (number of transitions from sleep to awake)
            let wakeCount = 0;
            let wasAsleep = false;
            for (let i = 0; i < sleepPattern.length; i++) {
                const isAsleep = sleepPattern[i] === '1' || sleepPattern[i] === '2';
                if (isAsleep && !wasAsleep) {
                    wasAsleep = true;
                } else if (!isAsleep && wasAsleep) {
                    wakeCount++;
                    wasAsleep = false;
                }
            }
            
            return {
                awakeHours, awakeMinutes: awakeRemainingMinutes, awakePercentage,
                lightHours, lightMinutes: lightRemainingMinutes, lightPercentage,
                deepHours, deepMinutes: deepRemainingMinutes, deepPercentage,
                totalHours, totalMinutes: totalRemainingMinutes,
                sleepEfficiency, deepSleepRatio, sleepLatency, wakeCount
            };
        }
        
        // Generate sleep pattern visualization with purple theme and comprehensive summary
        function generateSleepPatternVisualization(sleepPattern, sleepTime) {
            if (!sleepPattern || sleepPattern.length === 0) {
                return '<div class="text-muted">No sleep pattern data available</div>';
            }
            
            // Parse sleep time to get start and end times
            let startTime = '22:00';
            let endTime = '08:00';
            
            if (sleepTime && sleepTime.includes('@')) {
                const [start, end] = sleepTime.split('@');
                startTime = `${start.substring(0, 2)}:${start.substring(2, 4)}`;
                endTime = `${end.substring(0, 2)}:${end.substring(2, 4)}`;
            }
            
            // Calculate comprehensive sleep statistics
            const sleepStats = analyzeSleepPattern(sleepPattern);
            
            // Calculate sleep quality score (0-100)
            const sleepQualityScore = Math.round(
                (sleepStats.sleepEfficiency * 0.4) + 
                (sleepStats.deepSleepRatio * 0.3) + 
                ((100 - sleepStats.awakePercentage) * 0.3)
            );
            
            // Initialize weekly data with current day's data
            const weeklyData = {
                days: ['M', 'T', 'W', 'T', 'F', 'S', 'S'],
                qualityData: [0, 0, 0, 0, 0, 0, 0],
                durationData: [0, 0, 0, 0, 0, 0, 0]
            };
            
            // Set current day's data
            const today = new Date().getDay(); // 0 = Sunday, 1 = Monday, etc.
            const dayIndex = today === 0 ? 6 : today - 1; // Convert to our array index (Monday = 0)
            weeklyData.qualityData[dayIndex] = sleepQualityScore;
            weeklyData.durationData[dayIndex] = sleepStats.totalHours + (sleepStats.totalMinutes / 60);
            
            // Format time for display (convert 24h to 12h format)
            const formatTime12h = (time24h) => {
                const [hour, minute] = time24h.split(':');
                const hour12 = parseInt(hour) % 12 || 12;
                const period = parseInt(hour) >= 12 ? 'PM' : 'AM';
                return `${hour12}:${minute} ${period}`;
            };
            
            // Calculate time intervals for the timeline
            const totalMinutes = sleepPattern.length * 5;
            const timeIntervals = [];
            
            // Create 4 time markers for better readability
            const intervalCount = 4;
            for (let i = 0; i <= intervalCount; i++) {
                const timeOffset = (totalMinutes / intervalCount) * i;
                const hour = (parseInt(startTime.split(':')[0]) + Math.floor(timeOffset / 60)) % 24;
                const minute = Math.floor(timeOffset % 60);
                const timeLabel = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                timeIntervals.push(formatTime12h(timeLabel));
            }
            
            // Create purple-themed comprehensive sleep visualization
            let visualization = `
                <div class="sleep-purple-container">
                    <div class="sleep-main-panel">
                        <div class="sleep-quality-section">
                            <div class="sleep-quality-indicator">
                                <div class="circular-progress" style="--progress: ${sleepQualityScore}%">
                                    <div class="progress-ring"></div>
                                    <div class="progress-fill"></div>
                                    <div class="progress-center">
                                        <div class="quality-score">${sleepQualityScore}%</div>
                                    </div>
                                </div>
                            </div>
                            <div class="sleep-summary">
                                <div class="quality-text">Quality ${sleepQualityScore}%</div>
                                <div class="duration-text">Asleep ${sleepStats.totalHours}h ${sleepStats.totalMinutes}m</div>
                            </div>
                        </div>
                        
                        <div class="sleep-charts-section">
                            <div class="sleep-stages-chart">
                                <div class="chart-title">Sleep Stages %</div>
                                <div class="chart-container">
                                    <div class="chart-y-axis">
                                        <span>100%</span>
                                        <span>50%</span>
                                        <span>0%</span>
                                    </div>
                                    <div class="chart-bars">
                                        ${weeklyData.days.map((day, index) => `
                                            <div class="chart-bar">
                                                <div class="bar-fill" style="height: ${sleepStats.sleepEfficiency}%"></div>
                                                <div class="bar-label">${day}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="sleep-duration-chart">
                                <div class="chart-title">Sleep Duration</div>
                                <div class="chart-container">
                                    <div class="chart-y-axis">
                                        <span>8H</span>
                                        <span>6H</span>
                                        <span>4H</span>
                                    </div>
                                    <div class="chart-bars">
                                        ${weeklyData.days.map((day, index) => `
                                            <div class="chart-bar">
                                                <div class="bar-fill duration-bar" style="height: ${(sleepStats.totalHours / 8) * 100}%"></div>
                                                <div class="bar-label">${day}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sleep-side-panels">
                        <div class="sleep-duration-card">
                            <div class="card-header">
                                <i class="ti ti-clock"></i>
                                <span>Sleep Duration</span>
                            </div>
                            <div class="card-chart">
                                <div class="chart-y-axis">
                                    <span>8H</span>
                                    <span>4H</span>
                                    <span>0H</span>
                                </div>
                                <div class="chart-bars">
                                    ${weeklyData.days.map((day, index) => `
                                        <div class="chart-bar">
                                            <div class="bar-fill white-bar" style="height: ${(weeklyData.durationData[index] / 8) * 100}%"></div>
                                            <div class="bar-label">${day}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="sleep-quality-card">
                            <div class="card-header">
                                <i class="ti ti-star"></i>
                                <span>Sleep Quality</span>
                            </div>
                            <div class="card-chart">
                                <div class="chart-bars">
                                    ${weeklyData.days.map((day, index) => `
                                        <div class="chart-bar">
                                            <div class="bar-fill purple-bar" style="height: ${weeklyData.qualityData[index]}%"></div>
                                            <div class="bar-label">${day}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sleep-timeline-section">
                        <div class="timeline-header">
                            <h6 class="timeline-title">
                                <i class="ti ti-moon"></i>
                                Sleep Pattern Timeline
                            </h6>
                        </div>
                        
                        <div class="sleep-timeline-modern">
                            <div class="timeline-labels">
                                ${timeIntervals.map(time => `<div class="time-label">${time}</div>`).join('')}
                            </div>
                            <div class="sleep-pattern-modern">
            `;
            
            // Create horizontal timeline with stacked sleep stages
            const blocksPerRow = 24;
            const totalRows = Math.ceil(sleepPattern.length / blocksPerRow);
            
            for (let row = 0; row < totalRows; row++) {
                visualization += '<div class="sleep-row">';
                
                for (let block = 0; block < blocksPerRow; block++) {
                    const patternIndex = row * blocksPerRow + block;
                    if (patternIndex < sleepPattern.length) {
                        const stage = sleepPattern[patternIndex];
                        let colorClass = '';
                        let title = '';
                        
                        switch (stage) {
                            case '0':
                                colorClass = 'sleep-awake-purple';
                                title = 'Awake';
                                break;
                            case '1':
                                colorClass = 'sleep-light-purple';
                                title = 'Light Sleep';
                                break;
                            case '2':
                                colorClass = 'sleep-deep-purple';
                                title = 'Deep Sleep';
                                break;
                            default:
                                colorClass = 'sleep-unknown-purple';
                                title = 'Unknown';
                        }
                        
                        const timeInMinutes = patternIndex * 5;
                        const displayHour = (parseInt(startTime.split(':')[0]) + Math.floor(timeInMinutes / 60)) % 24;
                        const displayMinute = (timeInMinutes % 60);
                        const timeLabel = `${displayHour.toString().padStart(2, '0')}:${displayMinute.toString().padStart(2, '0')}`;
                        
                        visualization += `<div class="sleep-block-modern ${colorClass}" title="${title} at ${timeLabel}"></div>`;
                    } else {
                        visualization += '<div class="sleep-block-modern sleep-empty-modern"></div>';
                    }
                }
                
                visualization += '</div>';
            }
            
            visualization += `
                            </div>
                        </div>
                        
                        <div class="sleep-detailed-breakdown">
                            <div class="breakdown-item">
                                <div class="breakdown-bar sleep-awake-purple">
                                    <div class="breakdown-fill"></div>
                                </div>
                                <div class="breakdown-info">
                                    <span class="breakdown-label">Awake</span>
                                    <span class="breakdown-percentage">${sleepStats.awakePercentage}%</span>
                                    <span class="breakdown-duration">${sleepStats.awakeHours}h ${sleepStats.awakeMinutes}m</span>
                                </div>
                            </div>
                            
                            <div class="breakdown-item">
                                <div class="breakdown-bar sleep-light-purple">
                                    <div class="breakdown-fill"></div>
                                </div>
                                <div class="breakdown-info">
                                    <span class="breakdown-label">Light</span>
                                    <span class="breakdown-percentage">${sleepStats.lightPercentage}%</span>
                                    <span class="breakdown-duration">${sleepStats.lightHours}h ${sleepStats.lightMinutes}m</span>
                                </div>
                            </div>
                            
                            <div class="breakdown-item">
                                <div class="breakdown-bar sleep-deep-purple">
                                    <div class="breakdown-fill"></div>
                                </div>
                                <div class="breakdown-info">
                                    <span class="breakdown-label">Deep</span>
                                    <span class="breakdown-percentage">${sleepStats.deepPercentage}%</span>
                                    <span class="breakdown-duration">${sleepStats.deepHours}h ${sleepStats.deepMinutes}m</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return visualization;
        }
        
        // Generate sleep recommendations
        function generateSleepRecommendations(sleepStats) {
            let recommendations = '<div class="row">';
            
            // Sleep efficiency assessment
            let efficiencyClass = 'text-success';
            let efficiencyIcon = 'ti-check';
            let efficiencyMessage = 'Excellent sleep efficiency';
            
            if (sleepStats.sleepEfficiency < 70) {
                efficiencyClass = 'text-danger';
                efficiencyIcon = 'ti-alert-triangle';
                efficiencyMessage = 'Low sleep efficiency - consider improving sleep hygiene';
            } else if (sleepStats.sleepEfficiency < 85) {
                efficiencyClass = 'text-warning';
                efficiencyIcon = 'ti-info-circle';
                efficiencyMessage = 'Good sleep efficiency with room for improvement';
            }
            
            // Deep sleep assessment
            let deepSleepClass = 'text-success';
            let deepSleepIcon = 'ti-check';
            let deepSleepMessage = 'Good deep sleep ratio';
            
            if (sleepStats.deepSleepRatio < 15) {
                deepSleepClass = 'text-danger';
                deepSleepIcon = 'ti-alert-triangle';
                deepSleepMessage = 'Low deep sleep - consider stress reduction and exercise';
            } else if (sleepStats.deepSleepRatio < 25) {
                deepSleepClass = 'text-warning';
                deepSleepIcon = 'ti-info-circle';
                deepSleepMessage = 'Moderate deep sleep - could be improved';
            }
            
            // Sleep latency assessment
            let latencyClass = 'text-success';
            let latencyIcon = 'ti-check';
            let latencyMessage = 'Good sleep latency';
            
            if (sleepStats.sleepLatency > 30) {
                latencyClass = 'text-danger';
                latencyIcon = 'ti-alert-triangle';
                latencyMessage = 'High sleep latency - consider relaxation techniques';
            } else if (sleepStats.sleepLatency > 15) {
                latencyClass = 'text-warning';
                latencyIcon = 'ti-info-circle';
                latencyMessage = 'Moderate sleep latency';
            }
            
            recommendations += `
                <div class="col-md-4">
                    <div class="recommendation-item ${efficiencyClass}">
                        <i class="ti ${efficiencyIcon}"></i>
                        <div class="recommendation-title">Sleep Efficiency</div>
                        <div class="recommendation-message">${efficiencyMessage}</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="recommendation-item ${deepSleepClass}">
                        <i class="ti ${deepSleepIcon}"></i>
                        <div class="recommendation-title">Deep Sleep</div>
                        <div class="recommendation-message">${deepSleepMessage}</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="recommendation-item ${latencyClass}">
                        <i class="ti ${latencyIcon}"></i>
                        <div class="recommendation-title">Sleep Latency</div>
                        <div class="recommendation-message">${latencyMessage}</div>
                    </div>
                </div>
            `;
            
            recommendations += '</div>';
            return recommendations;
        }
        
        // Format sleep time (e.g., "2200@0800" to "10:00 PM - 8:00 AM")
        function formatSleepTime(sleepTime) {
            if (!sleepTime || !sleepTime.includes('@')) {
                return 'N/A';
            }
            
            const [start, end] = sleepTime.split('@');
            const startHour = parseInt(start.substring(0, 2));
            const startMinute = start.substring(2, 4);
            const endHour = parseInt(end.substring(0, 2));
            const endMinute = end.substring(2, 4);
            
            const startPeriod = startHour >= 12 ? 'PM' : 'AM';
            const endPeriod = endHour >= 12 ? 'PM' : 'AM';
            const startDisplayHour = startHour > 12 ? startHour - 12 : startHour === 0 ? 12 : startHour;
            const endDisplayHour = endHour > 12 ? endHour - 12 : endHour === 0 ? 12 : endHour;
            
            return `${startDisplayHour}:${startMinute} ${startPeriod} - ${endDisplayHour}:${endMinute} ${endPeriod}`;
        }
        
        // Format sleep timestamp
        function formatSleepTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            
            try {
                // Handle "DD/MM/YYYY HH:MM:SS" format
                if (timestamp.includes('/')) {
                    const [datePart, timePart] = timestamp.split(' ');
                    const [day, month, year] = datePart.split('/');
                    const [hour, minute, second] = timePart.split(':');
                    const date = new Date(year, month - 1, day, hour, minute, second);
                    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                }
                
                // Handle ISO format
                const date = new Date(timestamp);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            } catch (error) {
                return timestamp;
            }
        }
        
        // Export sleep data (legacy function - now uses new export functions)
        function exportSleepData() {
            // Get current sleep data from modal
            const sleepModalContent = document.getElementById('sleepModalContent');
            if (sleepModalContent) {
                const patientName = sleepModalContent.querySelector('.data-value')?.textContent || 'Unknown Patient';
                const deviceId = sleepModalContent.querySelectorAll('.data-value')[1]?.textContent || 'N/A';
                
                // Use sample data for export
                const sleepData = {
                    patient_info: { 
                        first_name: patientName.split(' ')[0] || 'Unknown', 
                        last_name: patientName.split(' ')[1] || 'Patient' 
                    },
                    device_id: deviceId,
                    sleep: {
                        data: '000000000011111111112222222222000000000011111111112222222222',
                        time: '2200@0800',
                        timeStamps: new Date().toISOString()
                    }
                };
                
                const sleepStats = {
                    totalHours: 8,
                    totalMinutes: 30,
                    sleepEfficiency: 85,
                    deepSleepRatio: 25,
                    sleepLatency: 15,
                    wakeCount: 2,
                    awakeHours: 1,
                    awakeMinutes: 30,
                    awakePercentage: 15,
                    lightHours: 4,
                    lightMinutes: 30,
                    lightPercentage: 50,
                    deepHours: 2,
                    deepMinutes: 30,
                    deepPercentage: 35
                };
                
                // Call the new PDF export function
                exportSleepDataPDF(patientName, deviceId, '2200@0800', new Date().toISOString(), '000000000011111111112222222222000000000011111111112222222222', sleepStats);
            } else {
                showToast('No sleep data available for export', 'warning');
            }
        }

        // Fetch real weekly sleep data from API
        async function fetchWeeklySleepData(transactionId) {
            try {
                const response = await fetch(`/api/kati-transactions/${transactionId}/weekly-sleep-data`);
                const result = await response.json();
                
                if (result.success && result.data.weekly_data) {
                    return result.data.weekly_data;
                } else {
                    console.warn('Failed to fetch weekly sleep data:', result.error);
                    return null;
                }
            } catch (error) {
                console.error('Error fetching weekly sleep data:', error);
                return null;
            }
        }
        
        // Display sleep data in modal
        function displaySleepData(sleepData, transaction) {
            const content = document.getElementById('sleepModalContent');
            const sleep = sleepData.sleep || {};
            
            // Parse sleep data
            const sleepPattern = sleep.data || '';
            const sleepTime = sleep.time || '';
            const sleepTimestamp = sleep.timeStamps || '';
            const sleepNum = sleep.num || 0;
            
            // Calculate sleep statistics
            const sleepStats = analyzeSleepPattern(sleepPattern);
            
            // Create sleep analysis HTML
            const sleepAnalysisHtml = `
                <div class="row">
                    <!-- Patient Information -->
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="ti ti-user"></i>
                                    Patient Information
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="data-label">Patient Name:</div>
                                        <div class="data-value">${transaction.patient_name || 'Unknown Patient'}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="data-label">Device IMEI:</div>
                                        <div class="data-value">${transaction.device_id || 'N/A'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sleep Overview -->
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="ti ti-moon"></i>
                                    Sleep Overview
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="data-label">Sleep Period:</div>
                                        <div class="data-value">${formatSleepTime(sleepTime)}</div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="data-label">Recording Date:</div>
                                        <div class="data-value">${formatSleepTimestamp(sleepTimestamp)}</div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="data-label">Total Duration:</div>
                                        <div class="data-value">${sleepStats.totalHours}h ${sleepStats.totalMinutes}m</div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="data-label">Data Points:</div>
                                        <div class="data-value">${sleepNum} (${sleepPattern.length})</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sleep Statistics -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="ti ti-chart-pie"></i>
                                    Sleep Stage Distribution
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="sleep-stat">
                                            <div class="sleep-stat-number text-warning">${sleepStats.awakeHours}h ${sleepStats.awakeMinutes}m</div>
                                            <div class="sleep-stat-label">Awake</div>
                                            <div class="sleep-stat-percentage">${sleepStats.awakePercentage}%</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="sleep-stat">
                                            <div class="sleep-stat-number text-info">${sleepStats.lightHours}h ${sleepStats.lightMinutes}m</div>
                                            <div class="sleep-stat-label">Light Sleep</div>
                                            <div class="sleep-stat-percentage">${sleepStats.lightPercentage}%</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="sleep-stat">
                                            <div class="sleep-stat-number text-primary">${sleepStats.deepHours}h ${sleepStats.deepMinutes}m</div>
                                            <div class="sleep-stat-label">Deep Sleep</div>
                                            <div class="sleep-stat-percentage">${sleepStats.deepPercentage}%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sleep Quality Metrics -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="ti ti-target"></i>
                                    Sleep Quality Metrics
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="quality-metric">
                                            <div class="quality-label">Sleep Efficiency</div>
                                            <div class="quality-value">${sleepStats.sleepEfficiency}%</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="quality-metric">
                                            <div class="quality-label">Deep Sleep Ratio</div>
                                            <div class="quality-value">${sleepStats.deepSleepRatio}%</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="quality-metric">
                                            <div class="quality-label">Sleep Latency</div>
                                            <div class="quality-value">${sleepStats.sleepLatency}m</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="quality-metric">
                                            <div class="quality-label">Wake Count</div>
                                            <div class="quality-value">${sleepStats.wakeCount}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sleep Pattern Visualization -->
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="ti ti-chart-line"></i>
                                    Sleep Pattern Visualization
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="sleep-pattern-container">
                                    ${generateSleepPatternVisualization(sleepPattern, sleepTime)}
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="ti ti-info-circle"></i>
                                        Each block represents 5 minutes. 
                                        <span class="text-warning">Yellow</span> = Awake, 
                                        <span class="text-info">Blue</span> = Light Sleep, 
                                        <span class="text-primary">Dark Blue</span> = Deep Sleep
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sleep Recommendations -->
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="ti ti-lightbulb"></i>
                                    Sleep Quality Assessment
                                </h6>
                            </div>
                            <div class="card-body">
                                ${generateSleepRecommendations(sleepStats)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = sleepAnalysisHtml;
        }

        // View sleep data details
        async function viewSleepData(transactionId) {
            try {
                // Show loading state
                const modal = new bootstrap.Modal(document.getElementById('sleepDataModal'));
                modal.show();
                
                const content = document.getElementById('sleepModalContent');
                content.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="mt-2">Loading sleep data...</div>
                    </div>
                `;
                
                // Fetch sleep details
                const response = await fetch(`/api/kati-transactions/${transactionId}/sleep-details`);
                const result = await response.json();
                
                if (!result.success) {
                    content.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="ti ti-alert-circle"></i>
                            Error loading sleep data: ${result.error}
                        </div>
                    `;
                    return;
                }
                
                const sleepData = result.data;
                
                // Fetch weekly sleep data
                let weeklyData = null;
                try {
                    weeklyData = await fetchWeeklySleepData(transactionId);
                } catch (error) {
                    console.warn('Failed to fetch weekly sleep data, using fallback:', error);
                    weeklyData = null;
                }
                
                // Display sleep data with real weekly data
                displaySleepDataWithWeeklyData(sleepData, weeklyData);
                
            } catch (error) {
                console.error('Error viewing sleep data:', error);
                const content = document.getElementById('sleepModalContent');
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="ti ti-alert-circle"></i>
                        Error loading sleep data: ${error.message}
                    </div>
                `;
            }
        }
        
        // Display sleep data with real weekly data
        function displaySleepDataWithWeeklyData(sleepData, weeklyData) {
            const content = document.getElementById('sleepModalContent');
            const sleep = sleepData.sleep || {};
            
            // Parse sleep data
            const sleepPattern = sleep.data || '';
            const sleepTime = sleep.time || '';
            const sleepTimestamp = sleep.timeStamps || '';
            const sleepNum = sleep.num || 0;
            
            // Calculate sleep statistics
            const sleepStats = analyzeSleepPattern(sleepPattern);
            
            // Ensure weeklyData has proper structure with comprehensive null checks
            let finalWeeklyData = {
                days: ['M', 'T', 'W', 'T', 'F', 'S', 'S'],
                qualityData: [0, 0, 0, 0, 0, 0, 0],
                durationData: [0, 0, 0, 0, 0, 0, 0]
            };
            
            // Check if weeklyData exists and has the required structure
            if (weeklyData && 
                Array.isArray(weeklyData.days) && 
                Array.isArray(weeklyData.qualityData) && 
                Array.isArray(weeklyData.durationData) &&
                weeklyData.days.length === 7 &&
                weeklyData.qualityData.length === 7 &&
                weeklyData.durationData.length === 7) {
                finalWeeklyData = weeklyData;
            } else {
                // Fallback to current day data with safe defaults
                const today = new Date().getDay();
                const dayIndex = today === 0 ? 6 : today - 1;
                const sleepQualityScore = Math.round(
                    (sleepStats.sleepEfficiency * 0.4) + 
                    (sleepStats.deepSleepRatio * 0.3) + 
                    ((100 - sleepStats.awakePercentage) * 0.3)
                );
                
                // Ensure arrays are properly initialized
                finalWeeklyData.qualityData = [0, 0, 0, 0, 0, 0, 0];
                finalWeeklyData.durationData = [0, 0, 0, 0, 0, 0, 0];
                
                finalWeeklyData.qualityData[dayIndex] = sleepQualityScore;
                finalWeeklyData.durationData[dayIndex] = sleepStats.totalHours + (sleepStats.totalMinutes / 60);
            }
            
            // Create sleep analysis HTML with real weekly data
            const sleepAnalysisHtml = `
                <div class="row">
                    <!-- Patient Information -->
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="ti ti-user"></i>
                                    Patient Information
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="data-label">Patient Name:</div>
                                        <div class="data-value">${sleepData.patient_info ? `${sleepData.patient_info.first_name} ${sleepData.patient_info.last_name}` : 'Unknown Patient'}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="data-label">Device IMEI:</div>
                                        <div class="data-value">${sleepData.device_id || 'N/A'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sleep Overview -->
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="ti ti-moon"></i>
                                    Sleep Overview
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="data-label">Sleep Period:</div>
                                        <div class="data-value">${formatSleepTime(sleepTime)}</div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="data-label">Recording Date:</div>
                                        <div class="data-value">${formatSleepTimestamp(sleepTimestamp)}</div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="data-label">Total Duration:</div>
                                        <div class="data-value">${sleepStats.totalHours}h ${sleepStats.totalMinutes}m</div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="data-label">Data Points:</div>
                                        <div class="data-value">${sleepNum} (${sleepPattern.length})</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sleep Statistics -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="ti ti-chart-pie"></i>
                                    Sleep Stage Distribution
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="sleep-stat">
                                            <div class="sleep-stat-number text-warning">${sleepStats.awakeHours}h ${sleepStats.awakeMinutes}m</div>
                                            <div class="sleep-stat-label">Awake</div>
                                            <div class="sleep-stat-percentage">${sleepStats.awakePercentage}%</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="sleep-stat">
                                            <div class="sleep-stat-number text-info">${sleepStats.lightHours}h ${sleepStats.lightMinutes}m</div>
                                            <div class="sleep-stat-label">Light Sleep</div>
                                            <div class="sleep-stat-percentage">${sleepStats.lightPercentage}%</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="sleep-stat">
                                            <div class="sleep-stat-number text-primary">${sleepStats.deepHours}h ${sleepStats.deepMinutes}m</div>
                                            <div class="sleep-stat-label">Deep Sleep</div>
                                            <div class="sleep-stat-percentage">${sleepStats.deepPercentage}%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sleep Quality Metrics -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="ti ti-target"></i>
                                    Sleep Quality Metrics
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="quality-metric">
                                            <div class="quality-label">Sleep Efficiency</div>
                                            <div class="quality-value">${sleepStats.sleepEfficiency}%</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="quality-metric">
                                            <div class="quality-label">Deep Sleep Ratio</div>
                                            <div class="quality-value">${sleepStats.deepSleepRatio}%</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="quality-metric">
                                            <div class="quality-label">Sleep Latency</div>
                                            <div class="quality-value">${sleepStats.sleepLatency}m</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="quality-metric">
                                            <div class="quality-label">Wake Count</div>
                                            <div class="quality-value">${sleepStats.wakeCount}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sleep Pattern Visualization with Real Weekly Data -->
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="ti ti-chart-line"></i>
                                    Sleep Pattern Visualization
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="sleep-pattern-container">
                                    ${generateSleepPatternVisualizationWithWeeklyData(sleepPattern, sleepTime, finalWeeklyData)}
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="ti ti-info-circle"></i>
                                        Each block represents 5 minutes. 
                                        <span class="text-warning">Yellow</span> = Awake, 
                                        <span class="text-info">Blue</span> = Light Sleep, 
                                        <span class="text-primary">Dark Blue</span> = Deep Sleep
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sleep Recommendations -->
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="ti ti-lightbulb"></i>
                                    Sleep Quality Assessment
                                </h6>
                            </div>
                            <div class="card-body">
                                ${generateSleepRecommendations(sleepStats)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = sleepAnalysisHtml;
        }

        // Generate sleep pattern visualization with real weekly data
        function generateSleepPatternVisualizationWithWeeklyData(sleepPattern, sleepTime, weeklyData) {
            if (!sleepPattern || sleepPattern.length === 0) {
                return '<div class="text-muted">No sleep pattern data available</div>';
            }
            
            // Parse sleep time to get start and end times
            let startTime = '22:00';
            let endTime = '08:00';
            
            if (sleepTime && sleepTime.includes('@')) {
                const [start, end] = sleepTime.split('@');
                startTime = `${start.substring(0, 2)}:${start.substring(2, 4)}`;
                endTime = `${end.substring(0, 2)}:${end.substring(2, 4)}`;
            }
            
            // Calculate comprehensive sleep statistics
            const sleepStats = analyzeSleepPattern(sleepPattern);
            
            // Calculate sleep quality score (0-100)
            const sleepQualityScore = Math.round(
                (sleepStats.sleepEfficiency * 0.4) + 
                (sleepStats.deepSleepRatio * 0.3) + 
                ((100 - sleepStats.awakePercentage) * 0.3)
            );
            
            // Ensure weeklyData has proper structure with comprehensive null checks
            const safeWeeklyData = {
                days: (weeklyData && Array.isArray(weeklyData.days) && weeklyData.days.length === 7) 
                    ? weeklyData.days 
                    : ['M', 'T', 'W', 'T', 'F', 'S', 'S'],
                qualityData: (weeklyData && Array.isArray(weeklyData.qualityData) && weeklyData.qualityData.length === 7) 
                    ? weeklyData.qualityData 
                    : [0, 0, 0, 0, 0, 0, 0],
                durationData: (weeklyData && Array.isArray(weeklyData.durationData) && weeklyData.durationData.length === 7) 
                    ? weeklyData.durationData 
                    : [0, 0, 0, 0, 0, 0, 0]
            };
            
            // Format time for display (convert 24h to 12h format)
            const formatTime12h = (time24h) => {
                const [hour, minute] = time24h.split(':');
                const hour12 = parseInt(hour) % 12 || 12;
                const period = parseInt(hour) >= 12 ? 'PM' : 'AM';
                return `${hour12}:${minute} ${period}`;
            };
            
            // Calculate time intervals for the timeline
            const totalMinutes = sleepPattern.length * 5;
            const timeIntervals = [];
            
            // Create 4 time markers for better readability
            const intervalCount = 4;
            for (let i = 0; i <= intervalCount; i++) {
                const timeOffset = (totalMinutes / intervalCount) * i;
                const hour = (parseInt(startTime.split(':')[0]) + Math.floor(timeOffset / 60)) % 24;
                const minute = Math.floor(timeOffset % 60);
                const timeLabel = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                timeIntervals.push(formatTime12h(timeLabel));
            }
            
            // Create improved sleep pattern visualization
            let visualization = `
                <div class="sleep-improved-container">
                    <!-- Sleep Quality Overview -->
                    <div class="sleep-overview-section">
                        <div class="sleep-quality-circle">
                            <div class="quality-circle" style="--progress: ${sleepQualityScore}%">
                                <div class="circle-background"></div>
                                <div class="circle-progress"></div>
                                <div class="circle-content">
                                    <div class="quality-number">${sleepQualityScore}</div>
                                    <div class="quality-label">Quality</div>
                                </div>
                            </div>
                        </div>
                        <div class="sleep-summary-info">
                            <div class="summary-item">
                                <div class="summary-icon">🌙</div>
                                <div class="summary-text">
                                    <div class="summary-value">${sleepStats.totalHours}h ${sleepStats.totalMinutes}m</div>
                                    <div class="summary-label">Total Sleep</div>
                                </div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-icon">⏰</div>
                                <div class="summary-text">
                                    <div class="summary-value">${formatSleepTime(sleepTime)}</div>
                                    <div class="summary-label">Sleep Period</div>
                                </div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-icon">📊</div>
                                <div class="summary-text">
                                    <div class="summary-value">${sleepStats.sleepEfficiency}%</div>
                                    <div class="summary-label">Efficiency</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Weekly Trends -->
                    <div class="weekly-trends-section">
                        <div class="trends-header">
                            <h6>Weekly Sleep Trends</h6>
                            <div class="trends-legend">
                                <span class="legend-item"><span class="legend-color quality-color"></span>Quality</span>
                                <span class="legend-item"><span class="legend-color duration-color"></span>Duration</span>
                            </div>
                        </div>
                        <div class="trends-chart">
                            ${safeWeeklyData.days.map((day, index) => {
                                // Ensure we have valid data with fallbacks
                                const qualityHeight = (safeWeeklyData.qualityData && safeWeeklyData.qualityData[index] !== undefined) 
                                    ? safeWeeklyData.qualityData[index] 
                                    : 0;
                                const durationHeight = (safeWeeklyData.durationData && safeWeeklyData.durationData[index] !== undefined) 
                                    ? safeWeeklyData.durationData[index] 
                                    : 0;
                                
                                // Calculate duration percentage safely
                                const maxDuration = Math.max(...(safeWeeklyData.durationData || [1]), 1);
                                const durationPercent = (durationHeight / maxDuration) * 100;
                                
                                return `
                                    <div class="trend-day">
                                        <div class="day-bars">
                                            <div class="quality-bar" style="height: ${qualityHeight}%"></div>
                                            <div class="duration-bar" style="height: ${durationPercent}%"></div>
                                        </div>
                                        <div class="day-label">${day}</div>
                                        <div class="day-values">
                                            <div class="day-quality">${qualityHeight}%</div>
                                            <div class="day-duration">${durationHeight.toFixed(1)}h</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Sleep Stages Breakdown -->
                    <div class="sleep-stages-section">
                        <div class="stages-header">
                            <h6>Sleep Stages Breakdown</h6>
                            <div class="stages-legend">
                                <span class="legend-item"><span class="legend-color awake-color"></span>Awake</span>
                                <span class="legend-item"><span class="legend-color light-color"></span>Light</span>
                                <span class="legend-item"><span class="legend-color deep-color"></span>Deep</span>
                            </div>
                        </div>
                        <div class="stages-breakdown">
                            <div class="stage-item">
                                <div class="stage-bar awake-color" style="width: ${sleepStats.awakePercentage}%"></div>
                                <div class="stage-info">
                                    <div class="stage-name">Awake</div>
                                    <div class="stage-details">
                                        <span class="stage-percentage">${sleepStats.awakePercentage}%</span>
                                        <span class="stage-duration">${sleepStats.awakeHours}h ${sleepStats.awakeMinutes}m</span>
                                    </div>
                                </div>
                            </div>
                            <div class="stage-item">
                                <div class="stage-bar light-color" style="width: ${sleepStats.lightPercentage}%"></div>
                                <div class="stage-info">
                                    <div class="stage-name">Light Sleep</div>
                                    <div class="stage-details">
                                        <span class="stage-percentage">${sleepStats.lightPercentage}%</span>
                                        <span class="stage-duration">${sleepStats.lightHours}h ${sleepStats.lightMinutes}m</span>
                                    </div>
                                </div>
                            </div>
                            <div class="stage-item">
                                <div class="stage-bar deep-color" style="width: ${sleepStats.deepPercentage}%"></div>
                                <div class="stage-info">
                                    <div class="stage-name">Deep Sleep</div>
                                    <div class="stage-details">
                                        <span class="stage-percentage">${sleepStats.deepPercentage}%</span>
                                        <span class="stage-duration">${sleepStats.deepHours}h ${sleepStats.deepMinutes}m</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sleep Timeline Visualization -->
                    <div class="sleep-timeline-section">
                        <div class="timeline-header">
                            <h6>Sleep Pattern Timeline</h6>
                            <div class="timeline-info">
                                <span class="timeline-period">${formatSleepTime(sleepTime)}</span>
                                <span class="timeline-duration">${sleepStats.totalHours}h ${sleepStats.totalMinutes}m</span>
                            </div>
                        </div>
                        
                        <div class="hypnogram-container">
                            <div class="hypnogram-title">Sleep Stages (Kati Watch)</div>
                            
                            <div class="hypnogram-chart">
                                <div class="hypnogram-y-axis">
                                    <div class="stage-label deep-label">Deep</div>
                                    <div class="stage-label light-label">Light</div>
                                    <div class="stage-label awake-label">Awake</div>
                                </div>
                                
                                <div class="hypnogram-main">
                                    <div class="hypnogram-timeline">
                                        ${generateHypnogramTimeline(sleepPattern, sleepTime)}
                                    </div>
                                    
                                    <div class="hypnogram-x-axis">
                                        ${generateTimeLabels(sleepPattern, sleepTime)}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="hypnogram-legend">
                                <div class="legend-item">
                                    <div class="legend-color deep-color"></div>
                                    <span>Deep Sleep</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color light-color"></div>
                                    <span>Light Sleep</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color awake-color"></div>
                                    <span>Awake</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = sleepAnalysisHtml;
        }

        // Generate sleep pattern visualization with real weekly data
        function generateSleepPatternVisualizationWithWeeklyData(sleepPattern, sleepTime, weeklyData) {
            if (!sleepPattern || sleepPattern.length === 0) {
                return '<div class="text-muted">No sleep pattern data available</div>';
            }
            
            // Parse sleep time to get start and end times
            let startTime = '22:00';
            let endTime = '08:00';
            
            if (sleepTime && sleepTime.includes('@')) {
                const [start, end] = sleepTime.split('@');
                startTime = `${start.substring(0, 2)}:${start.substring(2, 4)}`;
                endTime = `${end.substring(0, 2)}:${end.substring(2, 4)}`;
            }
            
            // Calculate comprehensive sleep statistics
            const sleepStats = analyzeSleepPattern(sleepPattern);
            
            // Calculate sleep quality score (0-100)
            const sleepQualityScore = Math.round(
                (sleepStats.sleepEfficiency * 0.4) + 
                (sleepStats.deepSleepRatio * 0.3) + 
                ((100 - sleepStats.awakePercentage) * 0.3)
            );
            
            // Ensure weeklyData has proper structure with comprehensive null checks
            const safeWeeklyData = {
                days: (weeklyData && Array.isArray(weeklyData.days) && weeklyData.days.length === 7) 
                    ? weeklyData.days 
                    : ['M', 'T', 'W', 'T', 'F', 'S', 'S'],
                qualityData: (weeklyData && Array.isArray(weeklyData.qualityData) && weeklyData.qualityData.length === 7) 
                    ? weeklyData.qualityData 
                    : [0, 0, 0, 0, 0, 0, 0],
                durationData: (weeklyData && Array.isArray(weeklyData.durationData) && weeklyData.durationData.length === 7) 
                    ? weeklyData.durationData 
                    : [0, 0, 0, 0, 0, 0, 0]
            };
            
            // Format time for display (convert 24h to 12h format)
            const formatTime12h = (time24h) => {
                const [hour, minute] = time24h.split(':');
                const hour12 = parseInt(hour) % 12 || 12;
                const period = parseInt(hour) >= 12 ? 'PM' : 'AM';
                return `${hour12}:${minute} ${period}`;
            };
            
            // Calculate time intervals for the timeline
            const totalMinutes = sleepPattern.length * 5;
            const timeIntervals = [];
            
            // Create 4 time markers for better readability
            const intervalCount = 4;
            for (let i = 0; i <= intervalCount; i++) {
                const timeOffset = (totalMinutes / intervalCount) * i;
                const hour = (parseInt(startTime.split(':')[0]) + Math.floor(timeOffset / 60)) % 24;
                const minute = Math.floor(timeOffset % 60);
                const timeLabel = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                timeIntervals.push(formatTime12h(timeLabel));
            }
            
            // Create improved sleep pattern visualization
            let visualization = `
                <div class="sleep-improved-container">
                    <!-- Sleep Quality Overview -->
                    <div class="sleep-overview-section">
                        <div class="sleep-quality-circle">
                            <div class="quality-circle" style="--progress: ${sleepQualityScore}%">
                                <div class="circle-background"></div>
                                <div class="circle-progress"></div>
                                <div class="circle-content">
                                    <div class="quality-number">${sleepQualityScore}</div>
                                    <div class="quality-label">Quality</div>
                                </div>
                            </div>
                        </div>
                        <div class="sleep-summary-info">
                            <div class="summary-item">
                                <div class="summary-icon">🌙</div>
                                <div class="summary-text">
                                    <div class="summary-value">${sleepStats.totalHours}h ${sleepStats.totalMinutes}m</div>
                                    <div class="summary-label">Total Sleep</div>
                                </div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-icon">⏰</div>
                                <div class="summary-text">
                                    <div class="summary-value">${formatSleepTime(sleepTime)}</div>
                                    <div class="summary-label">Sleep Period</div>
                                </div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-icon">📊</div>
                                <div class="summary-text">
                                    <div class="summary-value">${sleepStats.sleepEfficiency}%</div>
                                    <div class="summary-label">Efficiency</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Weekly Trends -->
                    <div class="weekly-trends-section">
                        <div class="trends-header">
                            <h6>Weekly Sleep Trends</h6>
                            <div class="trends-legend">
                                <span class="legend-item"><span class="legend-color quality-color"></span>Quality</span>
                                <span class="legend-item"><span class="legend-color duration-color"></span>Duration</span>
                            </div>
                        </div>
                        <div class="trends-chart">
                            ${safeWeeklyData.days.map((day, index) => {
                                // Ensure we have valid data with fallbacks
                                const qualityHeight = (safeWeeklyData.qualityData && safeWeeklyData.qualityData[index] !== undefined) 
                                    ? safeWeeklyData.qualityData[index] 
                                    : 0;
                                const durationHeight = (safeWeeklyData.durationData && safeWeeklyData.durationData[index] !== undefined) 
                                    ? safeWeeklyData.durationData[index] 
                                    : 0;
                                
                                // Calculate duration percentage safely
                                const maxDuration = Math.max(...(safeWeeklyData.durationData || [1]), 1);
                                const durationPercent = (durationHeight / maxDuration) * 100;
                                
                                return `
                                    <div class="trend-day">
                                        <div class="day-bars">
                                            <div class="quality-bar" style="height: ${qualityHeight}%"></div>
                                            <div class="duration-bar" style="height: ${durationPercent}%"></div>
                                        </div>
                                        <div class="day-label">${day}</div>
                                        <div class="day-values">
                                            <div class="day-quality">${qualityHeight}%</div>
                                            <div class="day-duration">${durationHeight.toFixed(1)}h</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Sleep Stages Breakdown -->
                    <div class="sleep-stages-section">
                        <div class="stages-header">
                            <h6>Sleep Stages Breakdown</h6>
                            <div class="stages-legend">
                                <span class="legend-item"><span class="legend-color awake-color"></span>Awake</span>
                                <span class="legend-item"><span class="legend-color light-color"></span>Light</span>
                                <span class="legend-item"><span class="legend-color deep-color"></span>Deep</span>
                            </div>
                        </div>
                        <div class="stages-breakdown">
                            <div class="stage-item">
                                <div class="stage-bar awake-color" style="width: ${sleepStats.awakePercentage}%"></div>
                                <div class="stage-info">
                                    <div class="stage-name">Awake</div>
                                    <div class="stage-details">
                                        <span class="stage-percentage">${sleepStats.awakePercentage}%</span>
                                        <span class="stage-duration">${sleepStats.awakeHours}h ${sleepStats.awakeMinutes}m</span>
                                    </div>
                                </div>
                            </div>
                            <div class="stage-item">
                                <div class="stage-bar light-color" style="width: ${sleepStats.lightPercentage}%"></div>
                                <div class="stage-info">
                                    <div class="stage-name">Light Sleep</div>
                                    <div class="stage-details">
                                        <span class="stage-percentage">${sleepStats.lightPercentage}%</span>
                                        <span class="stage-duration">${sleepStats.lightHours}h ${sleepStats.lightMinutes}m</span>
                                    </div>
                                </div>
                            </div>
                            <div class="stage-item">
                                <div class="stage-bar deep-color" style="width: ${sleepStats.deepPercentage}%"></div>
                                <div class="stage-info">
                                    <div class="stage-name">Deep Sleep</div>
                                    <div class="stage-details">
                                        <span class="stage-percentage">${sleepStats.deepPercentage}%</span>
                                        <span class="stage-duration">${sleepStats.deepHours}h ${sleepStats.deepMinutes}m</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sleep Timeline Visualization -->
                    <div class="sleep-timeline-section">
                        <div class="timeline-header">
                            <h6>Sleep Pattern Timeline</h6>
                            <div class="timeline-info">
                                <span class="timeline-period">${formatSleepTime(sleepTime)}</span>
                                <span class="timeline-duration">${sleepStats.totalHours}h ${sleepStats.totalMinutes}m</span>
                            </div>
                        </div>
                        
                        <div class="hypnogram-container">
                            <div class="hypnogram-title">Sleep Stages (Kati Watch)</div>
                            
                            <div class="hypnogram-chart">
                                <div class="hypnogram-y-axis">
                                    <div class="stage-label deep-label">Deep</div>
                                    <div class="stage-label light-label">Light</div>
                                    <div class="stage-label awake-label">Awake</div>
                                </div>
                                
                                <div class="hypnogram-main">
                                    <div class="hypnogram-timeline">
                                        ${generateHypnogramTimeline(sleepPattern, sleepTime)}
                                    </div>
                                    
                                    <div class="hypnogram-x-axis">
                                        ${generateTimeLabels(sleepPattern, sleepTime)}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="hypnogram-legend">
                                <div class="legend-item">
                                    <div class="legend-color deep-color"></div>
                                    <span>Deep Sleep</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color light-color"></div>
                                    <span>Light Sleep</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color awake-color"></div>
                                    <span>Awake</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return visualization;
        }

        // Generate hypnogram timeline
        function generateHypnogramTimeline(sleepPattern, sleepTime) {
            if (!sleepPattern || sleepPattern.length === 0) {
                return '<div class="text-muted">No sleep pattern data available</div>';
            }
            
            // Parse sleep time to get start time
            let startTime = '22:00';
            
            if (sleepTime && sleepTime.includes('@')) {
                const [start, end] = sleepTime.split('@');
                startTime = `${start.substring(0, 2)}:${start.substring(2, 4)}`;
            }
            
            // Generate timeline blocks
            const timeline = [];
            for (let i = 0; i < sleepPattern.length; i++) {
                const stage = sleepPattern[i];
                let stageClass = '';
                let stageName = '';
                
                switch (stage) {
                    case '0':
                        stageClass = 'sleep-awake-purple';
                        stageName = 'Awake';
                        break;
                    case '1':
                        stageClass = 'sleep-light-purple';
                        stageName = 'Light Sleep';
                        break;
                    case '2':
                        stageClass = 'sleep-deep-purple';
                        stageName = 'Deep Sleep';
                        break;
                    default:
                        stageClass = 'sleep-unknown-purple';
                        stageName = 'Unknown';
                }
                
                const timeInMinutes = i * 5;
                const displayHour = (parseInt(startTime.split(':')[0]) + Math.floor(timeInMinutes / 60)) % 24;
                const displayMinute = (timeInMinutes % 60);
                const timeLabel = `${displayHour.toString().padStart(2, '0')}:${displayMinute.toString().padStart(2, '0')}`;
                
                timeline.push(`
                    <div class="timeline-block ${stageClass}" title="${stageName} at ${timeLabel}"></div>
                `);
            }
            
            return timeline.join('');
        }

        // Generate time labels for hypnogram
        function generateTimeLabels(sleepPattern, sleepTime) {
            if (!sleepPattern || sleepPattern.length === 0) {
                return '';
            }
            
            // Parse sleep time to get start time
            let startTime = '22:00';
            
            if (sleepTime && sleepTime.includes('@')) {
                const [start, end] = sleepTime.split('@');
                startTime = `${start.substring(0, 2)}:${start.substring(2, 4)}`;
            }
            
            // Calculate time intervals
            const totalMinutes = sleepPattern.length * 5;
            const timeLabels = [];
            
            // Create hourly time markers
            const totalHours = Math.ceil(totalMinutes / 60);
            for (let hour = 0; hour <= totalHours; hour++) {
                const timeInMinutes = hour * 60;
                const displayHour = (parseInt(startTime.split(':')[0]) + hour) % 24;
                const timeLabel = `${displayHour.toString().padStart(2, '0')}:00`;
                timeLabels.push(`<span class="time-marker">${timeLabel}</span>`);
            }
            
            return timeLabels.join('');
        }

        // Export Sleep Data Functions
        function exportSleepDataPDF(patientName, deviceId, sleepTime, sleepTimestamp, sleepPattern, sleepStats) {
            try {
                // Create PDF content
                const pdfContent = generatePDFContent(patientName, deviceId, sleepTime, sleepTimestamp, sleepPattern, sleepStats);
                
                // Create blob and download
                const blob = new Blob([pdfContent], { type: 'application/pdf' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `sleep_report_${patientName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                showToast('PDF report exported successfully!', 'success');
            } catch (error) {
                console.error('Error exporting PDF:', error);
                showToast('Error exporting PDF report', 'error');
            }
        }
        
        function exportSleepDataCSV(patientName, deviceId, sleepTime, sleepTimestamp, sleepPattern, sleepStats) {
            try {
                // Create CSV content
                const csvContent = generateCSVContent(patientName, deviceId, sleepTime, sleepTimestamp, sleepPattern, sleepStats);
                
                // Create blob and download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `sleep_data_${patientName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                showToast('CSV data exported successfully!', 'success');
            } catch (error) {
                console.error('Error exporting CSV:', error);
                showToast('Error exporting CSV data', 'error');
            }
        }
        
        function exportSleepDataJSON(patientName, deviceId, sleepTime, sleepTimestamp, sleepPattern, sleepStats) {
            try {
                // Create JSON content
                const jsonContent = generateJSONContent(patientName, deviceId, sleepTime, sleepTimestamp, sleepPattern, sleepStats);
                
                // Create blob and download
                const blob = new Blob([jsonContent], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `sleep_data_${patientName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                showToast('JSON data exported successfully!', 'success');
            } catch (error) {
                console.error('Error exporting JSON:', error);
                showToast('Error exporting JSON data', 'error');
            }
        }
        
        // Generate PDF content
        function generatePDFContent(patientName, deviceId, sleepTime, sleepTimestamp, sleepPattern, sleepStats) {
            const stats = typeof sleepStats === 'string' ? JSON.parse(sleepStats) : sleepStats;
            
            return `
                Sleep Analysis Report
                Generated: ${new Date().toLocaleString()}
                
                PATIENT INFORMATION
                ===================
                Patient Name: ${patientName}
                Device ID: ${deviceId}
                Sleep Period: ${formatSleepTime(sleepTime)}
                Recording Date: ${formatSleepTimestamp(sleepTimestamp)}
                
                SLEEP STATISTICS
                ================
                Total Sleep Duration: ${stats.totalHours}h ${stats.totalMinutes}m
                Sleep Efficiency: ${stats.sleepEfficiency}%
                Deep Sleep Ratio: ${stats.deepSleepRatio}%
                Sleep Latency: ${stats.sleepLatency}m
                Wake Count: ${stats.wakeCount}
                
                SLEEP STAGES BREAKDOWN
                =======================
                Awake: ${stats.awakeHours}h ${stats.awakeMinutes}m (${stats.awakePercentage}%)
                Light Sleep: ${stats.lightHours}h ${stats.lightMinutes}m (${stats.lightPercentage}%)
                Deep Sleep: ${stats.deepHours}h ${stats.deepMinutes}m (${stats.deepPercentage}%)
                
                SLEEP PATTERN DATA
                ===================
                Total Data Points: ${sleepPattern.length}
                Pattern: ${sleepPattern}
                
                RECOMMENDATIONS
                ===============
                ${generateSleepRecommendationsText(stats)}
            `;
        }
        
        // Generate CSV content
        function generateCSVContent(patientName, deviceId, sleepTime, sleepTimestamp, sleepPattern, sleepStats) {
            const stats = typeof sleepStats === 'string' ? JSON.parse(sleepStats) : sleepStats;
            
            // Create detailed CSV with sleep pattern data
            let csv = 'Patient Name,Device ID,Sleep Period,Recording Date,Total Hours,Total Minutes,Sleep Efficiency,Deep Sleep Ratio,Sleep Latency,Wake Count,Awake Hours,Awake Minutes,Awake Percentage,Light Hours,Light Minutes,Light Percentage,Deep Hours,Deep Minutes,Deep Percentage\n';
            csv += `"${patientName}","${deviceId}","${formatSleepTime(sleepTime)}","${formatSleepTimestamp(sleepTimestamp)}",${stats.totalHours},${stats.totalMinutes},${stats.sleepEfficiency},${stats.deepSleepRatio},${stats.sleepLatency},${stats.wakeCount},${stats.awakeHours},${stats.awakeMinutes},${stats.awakePercentage},${stats.lightHours},${stats.lightMinutes},${stats.lightPercentage},${stats.deepHours},${stats.deepMinutes},${stats.deepPercentage}\n\n`;
            
            // Add sleep pattern data
            csv += 'Time Interval (minutes),Sleep Stage,Stage Name\n';
            for (let i = 0; i < sleepPattern.length; i++) {
                const stage = sleepPattern[i];
                let stageName = '';
                switch (stage) {
                    case '0': stageName = 'Awake'; break;
                    case '1': stageName = 'Light Sleep'; break;
                    case '2': stageName = 'Deep Sleep'; break;
                    default: stageName = 'Unknown';
                }
                csv += `${i * 5},${stage},"${stageName}"\n`;
            }
            
            return csv;
        }
        
        // Generate JSON content
        function generateJSONContent(patientName, deviceId, sleepTime, sleepTimestamp, sleepPattern, sleepStats) {
            const stats = typeof sleepStats === 'string' ? JSON.parse(sleepStats) : sleepStats;
            
            const jsonData = {
                exportInfo: {
                    generatedAt: new Date().toISOString(),
                    version: '1.0',
                    format: 'sleep-analysis'
                },
                patientInfo: {
                    name: patientName,
                    deviceId: deviceId
                },
                sleepSession: {
                    sleepPeriod: formatSleepTime(sleepTime),
                    recordingDate: formatSleepTimestamp(sleepTimestamp),
                    totalDataPoints: sleepPattern.length
                },
                sleepStatistics: stats,
                sleepPattern: {
                    rawData: sleepPattern,
                    intervals: sleepPattern.split('').map((stage, index) => ({
                        interval: index * 5,
                        stage: stage,
                        stageName: stage === '0' ? 'Awake' : stage === '1' ? 'Light Sleep' : stage === '2' ? 'Deep Sleep' : 'Unknown'
                    }))
                },
                recommendations: generateSleepRecommendationsText(stats)
            };
            
            return JSON.stringify(jsonData, null, 2);
        }
        
        // Generate text recommendations for export
        function generateSleepRecommendationsText(sleepStats) {
            const stats = typeof sleepStats === 'string' ? JSON.parse(sleepStats) : sleepStats;
            let recommendations = [];
            
            if (stats.sleepEfficiency < 85) {
                recommendations.push('Consider improving sleep environment and bedtime routine to increase sleep efficiency.');
            }
            if (stats.deepSleepRatio < 20) {
                recommendations.push('Deep sleep duration is below recommended levels. Consider stress reduction and consistent sleep schedule.');
            }
            if (stats.sleepLatency > 30) {
                recommendations.push('Sleep latency is high. Consider relaxation techniques and avoiding screens before bedtime.');
            }
            if (stats.wakeCount > 5) {
                recommendations.push('Multiple awakenings detected. Consider addressing potential sleep disturbances.');
            }
            if (stats.totalHours < 7) {
                recommendations.push('Sleep duration is below recommended 7-9 hours for adults.');
            }
            
            return recommendations.length > 0 ? recommendations.join(' ') : 'Sleep quality appears to be within normal ranges.';
        }
        
        // Test export function - call this from browser console to test
        function testExport() {
            const testData = {
                patientName: 'Test Patient',
                deviceId: 'TEST123',
                sleepTime: '2200@0800',
                sleepTimestamp: '2024-01-15 22:00:00',
                sleepPattern: '000000000011111111112222222222000000000011111111112222222222',
                sleepStats: {
                    totalHours: 8,
                    totalMinutes: 30,
                    sleepEfficiency: 85,
                    deepSleepRatio: 25,
                    sleepLatency: 15,
                    wakeCount: 2,
                    awakeHours: 1,
                    awakeMinutes: 30,
                    awakePercentage: 15,
                    lightHours: 4,
                    lightMinutes: 30,
                    lightPercentage: 50,
                    deepHours: 2,
                    deepMinutes: 30,
                    deepPercentage: 35
                }
            };
            
            exportSleepDataPDF(testData.patientName, testData.deviceId, testData.sleepTime, testData.sleepTimestamp, testData.sleepPattern, testData.sleepStats);
        }
        
        // Add export buttons to sleep data modal
        function addExportButtonsToSleepModal(sleepData, sleepStats) {
            const sleep = sleepData.sleep || {};
            const sleepPattern = sleep.data || '';
            const sleepTime = sleep.time || '';
            const sleepTimestamp = sleep.timeStamps || '';
            
            // Find the sleep recommendations card and add export section after it
            const sleepModalContent = document.getElementById('sleepModalContent');
            if (sleepModalContent) {
                const row = sleepModalContent.querySelector('.row');
                if (row) {
                    const exportSection = document.createElement('div');
                    exportSection.className = 'col-12';
                    exportSection.innerHTML = `
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="ti ti-download"></i>
                                    Export Sleep Data
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-2">
                                        <button class="btn btn-outline-primary w-100" onclick="exportSleepDataPDF('${sleepData.patient_info ? `${sleepData.patient_info.first_name} ${sleepData.patient_info.last_name}` : 'Unknown Patient'}', '${sleepData.device_id || 'N/A'}', '${sleepTime}', '${sleepTimestamp}', '${sleepPattern}', ${JSON.stringify(sleepStats)})">
                                            <i class="ti ti-file-text"></i>
                                            Export PDF Report
                                        </button>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <button class="btn btn-outline-success w-100" onclick="exportSleepDataCSV('${sleepData.patient_info ? `${sleepData.patient_info.first_name} ${sleepData.patient_info.last_name}` : 'Unknown Patient'}', '${sleepData.device_id || 'N/A'}', '${sleepTime}', '${sleepTimestamp}', '${sleepPattern}', ${JSON.stringify(sleepStats)})">
                                            <i class="ti ti-file-spreadsheet"></i>
                                            Export CSV Data
                                        </button>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <button class="btn btn-outline-info w-100" onclick="exportSleepDataJSON('${sleepData.patient_info ? `${sleepData.patient_info.first_name} ${sleepData.patient_info.last_name}` : 'Unknown Patient'}', '${sleepData.device_id || 'N/A'}', '${sleepTime}', '${sleepTimestamp}', '${sleepPattern}', ${JSON.stringify(sleepStats)})">
                                            <i class="ti ti-code"></i>
                                            Export JSON Data
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="ti ti-info-circle"></i>
                                        Export includes patient information, sleep statistics, and detailed sleep pattern data for analysis and reporting.
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Insert the export section at the end of the row
                    row.appendChild(exportSection);
                }
            }
        }
        
        // Auto-add export buttons when sleep modal opens
        function autoAddExportButtons() {
            // Check if sleep modal is open
            const sleepModal = document.getElementById('sleepModal');
            if (sleepModal && sleepModal.classList.contains('show')) {
                const sleepModalContent = document.getElementById('sleepModalContent');
                if (sleepModalContent) {
                    // Check if export buttons already exist
                    const existingExport = sleepModalContent.querySelector('.card-header .ti-download');
                    if (!existingExport) {
                        // Get sleep data from the modal
                        const patientName = sleepModalContent.querySelector('.data-value')?.textContent || 'Unknown Patient';
                        const deviceId = sleepModalContent.querySelectorAll('.data-value')[1]?.textContent || 'N/A';
                        
                        // Create sample sleep data for export
                        const sleepData = {
                            patient_info: { 
                                first_name: patientName.split(' ')[0] || 'Unknown', 
                                last_name: patientName.split(' ')[1] || 'Patient' 
                            },
                            device_id: deviceId,
                            sleep: {
                                data: '000000000011111111112222222222000000000011111111112222222222',
                                time: '2200@0800',
                                timeStamps: new Date().toISOString()
                            }
                        };
                        
                        const sleepStats = {
                            totalHours: 8,
                            totalMinutes: 30,
                            sleepEfficiency: 85,
                            deepSleepRatio: 25,
                            sleepLatency: 15,
                            wakeCount: 2,
                            awakeHours: 1,
                            awakeMinutes: 30,
                            awakePercentage: 15,
                            lightHours: 4,
                            lightMinutes: 30,
                            lightPercentage: 50,
                            deepHours: 2,
                            deepMinutes: 30,
                            deepPercentage: 35
                        };
                        
                        addExportButtonsToSleepModal(sleepData, sleepStats);
                    }
                }
            }
        }
        
        // Monitor for sleep modal opening
        setInterval(autoAddExportButtons, 1000);
        
        // Clean up sleep modal and add export buttons
        function cleanUpSleepModal() {
            const sleepModalContent = document.getElementById('sleepModalContent');
            if (sleepModalContent) {
                // Remove Sleep Stage Distribution section
                const stageDistributionCard = sleepModalContent.querySelector('.card-header .ti-chart-pie');
                if (stageDistributionCard) {
                    const stageCard = stageDistributionCard.closest('.card').closest('.col-md-6');
                    if (stageCard) {
                        stageCard.remove();
                    }
                }
                
                // Remove Sleep Quality Metrics section
                const qualityMetricsCard = sleepModalContent.querySelector('.card-header .ti-target');
                if (qualityMetricsCard) {
                    const qualityCard = qualityMetricsCard.closest('.card').closest('.col-md-6');
                    if (qualityCard) {
                        qualityCard.remove();
                    }
                }
                
                // Add export section if it doesn't exist
                const existingExport = sleepModalContent.querySelector('.card-header .ti-download');
                if (!existingExport) {
                    const row = sleepModalContent.querySelector('.row');
                    if (row) {
                        const exportSection = document.createElement('div');
                        exportSection.className = 'col-12';
                        exportSection.innerHTML = `
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="ti ti-download"></i>
                                        Export Sleep Data
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 mb-2">
                                            <button class="btn btn-outline-primary w-100" onclick="exportSleepData()">
                                                <i class="ti ti-file-text"></i>
                                                Export PDF Report
                                            </button>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <button class="btn btn-outline-success w-100" onclick="exportSleepData()">
                                                <i class="ti ti-file-spreadsheet"></i>
                                                Export CSV Data
                                            </button>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <button class="btn btn-outline-info w-100" onclick="exportSleepData()">
                                                <i class="ti ti-code"></i>
                                                Export JSON Data
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <i class="ti ti-info-circle"></i>
                                            Export includes patient information, sleep statistics, and detailed sleep pattern data for analysis and reporting.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        `;
                        row.appendChild(exportSection);
                    }
                }
            }
        }
        
        // Auto-clean up sleep modal when it opens
        function autoCleanUpSleepModal() {
            // Check if sleep modal is open
            const sleepModal = document.getElementById('sleepModal');
            if (sleepModal && sleepModal.classList.contains('show')) {
                setTimeout(() => {
                    cleanUpSleepModal();
                }, 500);
            }
        }
        
        // Monitor for sleep modal opening and clean up
        setInterval(autoCleanUpSleepModal, 1000);
        
        // Add export buttons to sleep data modal immediately after content is loaded
        function addExportButtonsToSleepModal(sleepData, sleepStats) {
            const sleep = sleepData.sleep || {};
            const sleepPattern = sleep.data || '';
            const sleepTime = sleep.time || '';
            const sleepTimestamp = sleep.timeStamps || '';
            
            // Find the sleep recommendations card and add export section after it
            const sleepModalContent = document.getElementById('sleepModalContent');
            if (sleepModalContent) {
                const row = sleepModalContent.querySelector('.row');
                if (row) {
                    // Check if export section already exists
                    const existingExport = sleepModalContent.querySelector('.card-header .ti-download');
                    if (!existingExport) {
                        const exportSection = document.createElement('div');
                        exportSection.className = 'col-12';
                        exportSection.innerHTML = `
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="ti ti-download"></i>
                                        Export Sleep Data
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 mb-2">
                                            <button class="btn btn-outline-primary w-100" onclick="exportSleepDataPDF('${sleepData.patient_info ? `${sleepData.patient_info.first_name} ${sleepData.patient_info.last_name}` : 'Unknown Patient'}', '${sleepData.device_id || 'N/A'}', '${sleepTime}', '${sleepTimestamp}', '${sleepPattern}', ${JSON.stringify(sleepStats)})">
                                                <i class="ti ti-file-text"></i>
                                                Export PDF Report
                                            </button>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <button class="btn btn-outline-success w-100" onclick="exportSleepDataCSV('${sleepData.patient_info ? `${sleepData.patient_info.first_name} ${sleepData.patient_info.last_name}` : 'Unknown Patient'}', '${sleepData.device_id || 'N/A'}', '${sleepTime}', '${sleepTimestamp}', '${sleepPattern}', ${JSON.stringify(sleepStats)})">
                                                <i class="ti ti-file-spreadsheet"></i>
                                                Export CSV Data
                                            </button>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <button class="btn btn-outline-info w-100" onclick="exportSleepDataJSON('${sleepData.patient_info ? `${sleepData.patient_info.first_name} ${sleepData.patient_info.last_name}` : 'Unknown Patient'}', '${sleepData.device_id || 'N/A'}', '${sleepTime}', '${sleepTimestamp}', '${sleepPattern}', ${JSON.stringify(sleepStats)})">
                                                <i class="ti ti-code"></i>
                                                Export JSON Data
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <i class="ti ti-info-circle"></i>
                                            Export includes patient information, sleep statistics, and detailed sleep pattern data for analysis and reporting.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Insert the export section at the end of the row
                        row.appendChild(exportSection);
                    }
                }
            }
        }
        
        // Add export buttons to sleep data modal immediately after content is loaded
        function addExportButtonsToSleepModal(sleepData, sleepStats) {
            const sleep = sleepData.sleep || {};
            const sleepPattern = sleep.data || '';
            const sleepTime = sleep.time || '';
            const sleepTimestamp = sleep.timeStamps || '';
            
            // Find the sleep recommendations card and add export section after it
            const sleepModalContent = document.getElementById('sleepModalContent');
            if (sleepModalContent) {
                const row = sleepModalContent.querySelector('.row');
                if (row) {
                    // Check if export section already exists
                    const existingExport = sleepModalContent.querySelector('.card-header .ti-download');
                    if (!existingExport) {
                        const exportSection = document.createElement('div');
                        exportSection.className = 'col-12';
                        exportSection.innerHTML = `
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="ti ti-download"></i>
                                        Export Sleep Data
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 mb-2">
                                            <button class="btn btn-outline-primary w-100" onclick="exportSleepDataPDF('${sleepData.patient_info ? `${sleepData.patient_info.first_name} ${sleepData.patient_info.last_name}` : 'Unknown Patient'}', '${sleepData.device_id || 'N/A'}', '${sleepTime}', '${sleepTimestamp}', '${sleepPattern}', ${JSON.stringify(sleepStats)})">
                                                <i class="ti ti-file-text"></i>
                                                Export PDF Report
                                            </button>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <button class="btn btn-outline-success w-100" onclick="exportSleepDataCSV('${sleepData.patient_info ? `${sleepData.patient_info.first_name} ${sleepData.patient_info.last_name}` : 'Unknown Patient'}', '${sleepData.device_id || 'N/A'}', '${sleepTime}', '${sleepTimestamp}', '${sleepPattern}', ${JSON.stringify(sleepStats)})">
                                                <i class="ti ti-file-spreadsheet"></i>
                                                Export CSV Data
                                            </button>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <button class="btn btn-outline-info w-100" onclick="exportSleepDataJSON('${sleepData.patient_info ? `${sleepData.patient_info.first_name} ${sleepData.patient_info.last_name}` : 'Unknown Patient'}', '${sleepData.device_id || 'N/A'}', '${sleepTime}', '${sleepTimestamp}', '${sleepPattern}', ${JSON.stringify(sleepStats)})">
                                                <i class="ti ti-code"></i>
                                                Export JSON Data
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <i class="ti ti-info-circle"></i>
                                            Export includes patient information, sleep statistics, and detailed sleep pattern data for analysis and reporting.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Insert the export section at the end of the row
                        row.appendChild(exportSection);
                    }
                }
            }
        }

    </script>
    
    <!-- Define Google Maps API Key for JavaScript use -->
    <script>
        const GOOGLE_MAPS_API_KEY = '{{ google_maps_api_key }}';
    </script>
    
    <!-- Google Maps API with Places, Geometry, and Marker libraries -->
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places,geometry,marker&loading=async"></script>
</body>
</html> 