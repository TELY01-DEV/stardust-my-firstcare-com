<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title>Opera-GodEye Panel - Real-time Event Streaming Dashboard</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='PRIMARY_MFC_LOGO_EN.svg') }}">
    <link rel="alternate icon" href="{{ url_for('static', filename='PRIMARY_MFC_LOGO_EN.svg') }}">
    
    <!-- CSS files -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons@2.40.0/iconfont/tabler-icons.min.css" rel="stylesheet"/>
    
    <!-- Chart.js for real-time charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Socket.IO client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <!-- D3.js for advanced visualizations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        /* MFC Theme Palette */
        :root {
            --mfc-blue: #024F96;
            --mfc-light-blue: #00A1E8;
            --mfc-accent-blue: #92E3FF;
            --mfc-red: #EC1C24;
            --mfc-dark-red: #981F15;
            --mfc-gray: #D0D2D3;
            --mfc-white: #fff;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        .connection-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .connection-connected { background-color: #28a745; }
        .connection-connecting { background-color: #ffc107; }
        .connection-disconnected { background-color: #dc3545; }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .btn {
            border-radius: 8px;
            font-weight: 600;
        }
        
        .form-select {
            border-radius: 8px;
        }
        
        /* Real-time event stream styles */
        .event-stream {
            height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #dee2e6;
        }
        
        .event-item {
            background: white;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid var(--mfc-blue);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .event-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .event-item.critical {
            border-left-color: var(--mfc-red);
            background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
        }
        
        .event-item.warning {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fffbf0 0%, #fff 100%);
        }
        
        .event-item.success {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #f0fff4 0%, #fff 100%);
        }
        
        .event-timestamp {
            font-size: 0.75rem;
            color: #6c757d;
            font-weight: 600;
        }
        
        .event-source {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 0.5rem;
        }
        
        .source-ava4 { background-color: #d4edda; color: #155724; }
        .source-kati { background-color: #d1ecf1; color: #0c5460; }
        .source-qube { background-color: #fff3cd; color: #856404; }
        .source-monitor { background-color: #f8d7da; color: #721c24; }
        
        .event-message {
            font-weight: 500;
            margin: 0.25rem 0;
        }
        
        .event-details {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }
        
        /* Chart containers */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 1rem;
        }
        
        /* Real-time metrics */
        .metric-card {
            text-align: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--mfc-blue) 0%, var(--mfc-light-blue) 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        
        .metric-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .metric-trend {
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }
        
        .trend-up { color: #90EE90; }
        .trend-down { color: #FFB6C1; }
        
        /* Event correlation timeline */
        .timeline-container {
            height: 200px;
            overflow-x: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #dee2e6;
        }
        
        .timeline-event {
            display: inline-block;
            height: 20px;
            margin: 2px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .timeline-event:hover {
            transform: scale(1.1);
        }
        
        /* Control panel */
        .control-panel {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .filter-group {
            margin-bottom: 1rem;
        }
        
        .filter-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--mfc-blue);
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .event-stream {
                height: 300px;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .metric-number {
                font-size: 2rem;
            }
        }
        
        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--mfc-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Event type indicators */
        .event-type-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        .type-vitals { background-color: #28a745; }
        .type-alert { background-color: #dc3545; }
        .type-status { background-color: #ffc107; }
        .type-data { background-color: #17a2b8; }
        .type-system { background-color: #6c757d; }
    </style>
</head>
<body>
    <div class="page">
        <!-- Tabler Navbar -->
        <header class="navbar navbar-expand-md navbar-dark d-print-none" style="background: var(--mfc-blue);">
            <div class="container-xl">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <a class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3" href="/">
                    <img src="{{ url_for('static', filename='LOGO_MFC_EN.png') }}" alt="MFC Logo" style="height:40px;vertical-align:middle;margin-right:10px;">
                    Opera-GodEye Panel
                </a>
                
                <div class="navbar-nav flex-row order-md-last">
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown">
                            <span class="avatar avatar-sm">
                                <span class="connection-indicator connection-connected" id="connectionStatus"></span>
                            </span>
                            <div class="d-none d-xl-block ps-2">
                                <div>Real-time Dashboard</div>
                                <div class="mt-1 small text-muted">Live Event Stream</div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="navbar-expand-md">
            <div class="collapse navbar-collapse" id="navbar-menu">
                <div class="navbar">
                    <div class="container-xl">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link" href="/">
                                    <i class="ti ti-dashboard me-2"></i>
                                    Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/messages">
                                    <i class="ti ti-message-circle me-2"></i>
                                    Messages
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/emergency">
                                    <i class="ti ti-alert-triangle me-2"></i>
                                    Emergency Alerts
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/devices">
                                    <i class="ti ti-devices me-2"></i>
                                    Devices
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/patients">
                                    <i class="ti ti-users me-2"></i>
                                    Patients
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/medical-monitor">
                                    <i class="ti ti-heartbeat me-2"></i>
                                    Medical Monitor
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/data-flow">
                                    <i class="ti ti-activity me-2"></i>
                                    Data Flow Monitor
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/event-log">
                                    <i class="ti ti-list me-2"></i>
                                    Event Log
                                </a>
                            </li>
                            <li class="nav-item active">
                                <a class="nav-link" href="/event-streaming">
                                    <i class="ti ti-broadcast me-2"></i>
                                    Live Stream
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/kati-transaction">
                                    <i class="ti ti-device-watch me-2"></i>
                                    Kati Transaction
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="page-wrapper">
            <div class="container-xl">
                <!-- Page header -->
                <div class="page-header d-print-none">
                    <div class="row align-items-center">
                        <div class="col">
                            <h2 class="page-title">
                                <i class="ti ti-broadcast text-primary"></i>
                                Real-time Event Streaming Dashboard
                            </h2>
                            <div class="text-muted mt-1">
                                Live monitoring of all system events with real-time analytics and correlation
                            </div>
                        </div>
                        <div class="col-auto ms-auto d-print-none">
                            <div class="btn-list">
                                <button class="btn btn-primary" onclick="toggleStreaming()">
                                    <i class="ti ti-player-pause" id="streamingIcon"></i>
                                    <span id="streamingText">Pause Stream</span>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="clearEventStream()">
                                    <i class="ti ti-trash"></i>
                                    Clear Stream
                                </button>
                                <button class="btn btn-outline-success" onclick="exportEventData()">
                                    <i class="ti ti-download"></i>
                                    Export Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Control Panel -->
                <div class="control-panel">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="filter-group">
                                <label class="filter-label">Event Source</label>
                                <select class="form-select" id="sourceFilter">
                                    <option value="">All Sources</option>
                                    <option value="ava4">AVA4</option>
                                    <option value="kati">Kati Watch</option>
                                    <option value="qube">Qube-Vital</option>
                                    <option value="monitor">System Monitor</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="filter-group">
                                <label class="filter-label">Event Type</label>
                                <select class="form-select" id="typeFilter">
                                    <option value="">All Types</option>
                                    <option value="vitals">Vital Signs</option>
                                    <option value="alert">Alerts</option>
                                    <option value="status">Status Updates</option>
                                    <option value="data">Data Processing</option>
                                    <option value="system">System Events</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="filter-group">
                                <label class="filter-label">Status</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">All Status</option>
                                    <option value="success">Success</option>
                                    <option value="error">Error</option>
                                    <option value="warning">Warning</option>
                                    <option value="info">Info</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="filter-group">
                                <label class="filter-label">Time Range</label>
                                <select class="form-select" id="timeRangeFilter">
                                    <option value="5">Last 5 minutes</option>
                                    <option value="15">Last 15 minutes</option>
                                    <option value="30">Last 30 minutes</option>
                                    <option value="60">Last hour</option>
                                    <option value="all">All time</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Real-time Metrics -->
                <div class="row stats-cards">
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-number" id="totalEvents">0</div>
                            <div class="metric-label">Total Events</div>
                            <div class="metric-trend trend-up" id="eventsTrend">+0/min</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-number" id="eventsPerMinute">0</div>
                            <div class="metric-label">Events/Min</div>
                            <div class="metric-trend" id="rateTrend">Stable</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-number" id="errorRate">0%</div>
                            <div class="metric-label">Error Rate</div>
                            <div class="metric-trend" id="errorTrend">Good</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-number" id="activeDevices">0</div>
                            <div class="metric-label">Active Devices</div>
                            <div class="metric-trend" id="devicesTrend">Online</div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="ti ti-chart-line"></i>
                                    Events Over Time
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="eventsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="ti ti-chart-pie"></i>
                                    Event Distribution
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="distributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Event Stream and Timeline -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="ti ti-list"></i>
                                    Live Event Stream
                                    <span class="badge bg-primary ms-2" id="streamCount">0</span>
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="event-stream" id="eventStream">
                                    <div class="text-center text-muted">
                                        <i class="ti ti-loader loading"></i>
                                        Connecting to event stream...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="ti ti-timeline"></i>
                                    Event Timeline
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="timeline-container" id="eventTimeline">
                                    <!-- Timeline events will be rendered here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Event Correlation -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="ti ti-git-branch"></i>
                                    Event Correlation
                                </h3>
                            </div>
                            <div class="card-body">
                                <div id="correlationGraph">
                                    <!-- D3.js correlation graph will be rendered here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Event Details Modal -->
    <div class="modal fade" id="eventDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Event Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="eventDetailsContent">
                        <!-- Event details will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/js/tabler.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let socket;
        let isStreaming = true;
        let eventHistory = [];
        let eventStats = {
            total: 0,
            perMinute: 0,
            errors: 0,
            sources: {},
            types: {},
            timeline: []
        };
        
        // Charts
        let eventsChart;
        let distributionChart;
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeCharts();
            initializeTimeline();
            initializeCorrelationGraph();
            loadInitialData();
            startMetricsUpdate();
        });
        
        // Load initial data from API
        async function loadInitialData() {
            try {
                // Load real database statistics first
                const statsResponse = await fetch('/api/streaming/stats');
                const statsData = await statsResponse.json();
                
                if (statsData.success) {
                    console.log('Loading real database statistics:', statsData.data);
                    updateMetricsDisplay(statsData.data);
                } else {
                    console.error('Error loading streaming stats:', statsData.error);
                }
                
                // Load real event log data for display
                const eventLogResponse = await fetch('/api/event-log?limit=50');
                const eventLogData = await eventLogResponse.json();
                
                if (eventLogData.success && eventLogData.data.events) {
                    console.log('Loading real event log data for display:', eventLogData.data.events.length, 'events');
                    
                    // Load real events into the dashboard for display only
                    eventLogData.data.events.forEach(event => {
                        addEventToStream(event);
                        updateTimeline(event);
                    });
                    
                    // Update stream counter
                    document.getElementById('streamCount').textContent = eventLogData.data.events.length;
                    
                    console.log('Real event log data loaded successfully for display');
                }
                
                console.log('Initial data loaded successfully');
                
            } catch (error) {
                console.error('Error loading initial data:', error);
                document.getElementById('eventStream').innerHTML = 
                    '<div class="text-center text-danger">Error loading initial data. Please refresh the page.</div>';
            }
        }
        
        // Socket.IO connection
        function initializeSocket() {
            socket = io({ transports: ['websocket'] });
            
            socket.on('connect', function() {
                console.log('Connected to event stream');
                updateConnectionStatus('connected');
                document.getElementById('eventStream').innerHTML = '<div class="text-center text-muted">Waiting for events...</div>';
            });
            
            socket.on('disconnect', function() {
                console.log('Disconnected from event stream');
                updateConnectionStatus('disconnected');
            });
            
            socket.on('data_flow_update', function(data) {
                if (isStreaming) {
                    console.log('Received data flow update:', data);
                    
                    // Map backend event structure to frontend expected format
                    const mappedEvent = {
                        source: data.data.device_type || 'unknown',
                        event_type: data.data.step || 'unknown',
                        status: data.data.status || 'info',
                        message: data.data.topic || 'No message available',
                        device_id: data.data.payload?.IMEI || data.data.payload?.mac || 'N/A',
                        patient_id: data.data.patient_info?.patient_id || 'N/A',
                        timestamp: data.data.timestamp || data.timestamp,
                        data: data.data.payload || {},
                        topic: data.data.topic || 'unknown'
                    };
                    
                    addEventToStream(mappedEvent);
                    updateTimeline(mappedEvent);
                    updateCorrelationGraph(mappedEvent);
                    
                    // Fetch fresh database statistics
                    fetchFreshStats();
                }
            });
            
            // Listen for step-specific events
            socket.on('1_mqtt_received', function(data) {
                if (isStreaming) {
                    console.log('Received MQTT event:', data);
                    addEventToStream(data);
                    updateTimeline(data);
                    updateCorrelationGraph(data);
                    fetchFreshStats();
                }
            });
            
            socket.on('2_payload_parsed', function(data) {
                if (isStreaming) {
                    console.log('Received payload parsed event:', data);
                    addEventToStream(data);
                    updateTimeline(data);
                    updateCorrelationGraph(data);
                    fetchFreshStats();
                }
            });
            
            socket.on('2.5_fhir_validation', function(data) {
                if (isStreaming) {
                    console.log('Received FHIR validation event:', data);
                    addEventToStream(data);
                    updateTimeline(data);
                    updateCorrelationGraph(data);
                    fetchFreshStats();
                }
            });
            
            socket.on('3_patient_lookup', function(data) {
                if (isStreaming) {
                    console.log('Received patient lookup event:', data);
                    addEventToStream(data);
                    updateTimeline(data);
                    updateCorrelationGraph(data);
                    fetchFreshStats();
                }
            });
            
            socket.on('event_stats_update', function(data) {
                updateMetricsDisplay(data);
            });
        }
        
        // Update connection status indicator
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('connectionStatus');
            indicator.className = `connection-indicator connection-${status}`;
        }
        
        // Add event to the stream
        function addEventToStream(event) {
            const streamContainer = document.getElementById('eventStream');
            const eventElement = createEventElement(event);
            
            // Add to beginning of stream
            streamContainer.insertBefore(eventElement, streamContainer.firstChild);
            
            // Limit stream to 100 events
            const events = streamContainer.querySelectorAll('.event-item');
            if (events.length > 100) {
                events[events.length - 1].remove();
            }
            
            // Update counter
            document.getElementById('streamCount').textContent = events.length;
            
            // Add to history
            eventHistory.unshift(event);
            if (eventHistory.length > 1000) {
                eventHistory.pop();
            }
        }
        
        // Create event element
        function createEventElement(event) {
            const eventDiv = document.createElement('div');
            eventDiv.className = `event-item ${getEventPriority(event)}`;
            eventDiv.onclick = () => showEventDetails(event);
            
            const timestamp = new Date(event.timestamp).toLocaleTimeString();
            const source = event.source || 'unknown';
            const sourceClass = `source-${source.toLowerCase()}`;
            const eventType = event.event_type || 'unknown';
            const typeIndicator = `<span class="event-type-indicator type-${eventType}"></span>`;
            
            // Safely get message with fallback
            const message = event.message || 'No message available';
            
            eventDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <span class="event-timestamp">${timestamp}</span>
                        <span class="event-source ${sourceClass}">${source}</span>
                    </div>
                    <span class="badge bg-${getStatusColor(event.status)}">${event.status || 'info'}</span>
                </div>
                <div class="event-message">
                    ${typeIndicator}${message}
                </div>
                <div class="event-details">
                    Device: ${event.device_id || 'N/A'} | Type: ${eventType}
                </div>
            `;
            
            return eventDiv;
        }
        
        // Get event priority class
        function getEventPriority(event) {
            if (event.status === 'error' || event.severity === 'critical') return 'critical';
            if (event.status === 'warning' || event.severity === 'warning') return 'warning';
            return 'success';
        }
        
        // Get status color
        function getStatusColor(status) {
            if (!status) return 'secondary';
            
            switch (status.toLowerCase()) {
                case 'success': return 'success';
                case 'error': return 'danger';
                case 'warning': return 'warning';
                case 'info': return 'info';
                default: return 'secondary';
            }
        }
        
        // Show event details modal
        function showEventDetails(event) {
            console.log('Event details:', event); // Debug log
            
            const modal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
            const content = document.getElementById('eventDetailsContent');
            
            // Safely get event properties with fallbacks
            const timestamp = event.timestamp ? new Date(event.timestamp).toLocaleString() : 'N/A';
            const source = event.source || 'N/A';
            const eventType = event.event_type || 'N/A';
            const status = event.status || 'N/A';
            const deviceId = event.device_id || 'N/A';
            const patientId = event.patient_id || 'N/A';
            const message = event.message || 'No message available';
            const eventData = event.data || {};
            
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Event Information</h6>
                        <table class="table table-sm">
                            <tr><td>Timestamp:</td><td>${timestamp}</td></tr>
                            <tr><td>Source:</td><td>${source}</td></tr>
                            <tr><td>Type:</td><td>${eventType}</td></tr>
                            <tr><td>Status:</td><td><span class="badge bg-${getStatusColor(status)}">${status}</span></td></tr>
                            <tr><td>Device ID:</td><td>${deviceId}</td></tr>
                            <tr><td>Patient ID:</td><td>${patientId}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Event Data</h6>
                        <div class="json-viewer">
                            <pre>${JSON.stringify(eventData, null, 2)}</pre>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Message</h6>
                        <p>${message}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Raw Event Data (Debug)</h6>
                        <div class="json-viewer">
                            <pre>${JSON.stringify(event, null, 2)}</pre>
                        </div>
                    </div>
                </div>
            `;
            
            modal.show();
        }
        
        // Initialize charts
        function initializeCharts() {
            // Events over time chart
            const eventsCtx = document.getElementById('eventsChart').getContext('2d');
            eventsChart = new Chart(eventsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Events per Minute',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute'
                            }
                        },
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            // Distribution chart
            const distributionCtx = document.getElementById('distributionChart').getContext('2d');
            distributionChart = new Chart(distributionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['AVA4', 'Kati Watch', 'Qube-Vital', 'System'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(255, 205, 86, 0.8)',
                            'rgba(54, 162, 235, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Update charts with new data
        function updateCharts() {
            console.log('Updating charts with new data. Current eventStats:', eventStats);
            // Update events over time chart
            const now = new Date();
            const labels = eventsChart.data.labels;
            const data = eventsChart.data.datasets[0].data;
            
            labels.push(now);
            data.push(eventStats.perMinute);
            
            // Keep only last 20 data points
            if (labels.length > 20) {
                labels.shift();
                data.shift();
            }
            
            eventsChart.update('none');
            
            // Update distribution chart with proper source mapping
            distributionChart.data.datasets[0].data = [
                eventStats.sources['ava4'] || 0,
                eventStats.sources['kati'] || eventStats.sources['kati watch'] || 0,
                eventStats.sources['qube'] || eventStats.sources['qube-vital'] || 0,
                eventStats.sources['monitor'] || eventStats.sources['system'] || 0
            ];
            distributionChart.update('none');
            console.log('Distribution chart updated.');
        }
        
        // Initialize timeline
        function initializeTimeline() {
            const timeline = document.getElementById('eventTimeline');
            timeline.innerHTML = '<div class="text-center text-muted">Timeline will appear here</div>';
        }
        
        // Update timeline
        function updateTimeline(event) {
            const timeline = document.getElementById('eventTimeline');
            const eventDot = document.createElement('div');
            eventDot.className = 'timeline-event';
            eventDot.style.backgroundColor = getEventColor(event);
            eventDot.style.width = '20px';
            eventDot.title = `${event.source}: ${event.event_type}`;
            eventDot.onclick = () => showEventDetails(event);
            
            timeline.appendChild(eventDot);
            
            // Limit timeline to 50 events
            const events = timeline.querySelectorAll('.timeline-event');
            if (events.length > 50) {
                events[0].remove();
            }
        }
        
        // Get event color for timeline
        function getEventColor(event) {
            const source = event.source || 'unknown';
            switch (source.toLowerCase()) {
                case 'ava4': return '#4BC0C0';
                case 'kati': return '#FF6384';
                case 'qube': return '#FFCD56';
                case 'monitor': return '#36A2EB';
                default: return '#6C757D';
            }
        }
        
        // Initialize correlation graph
        function initializeCorrelationGraph() {
            const container = document.getElementById('correlationGraph');
            container.innerHTML = '<div class="text-center text-muted">Event correlations will appear here</div>';
        }
        
        // Update correlation graph
        function updateCorrelationGraph(event) {
            // Simple correlation visualization
            const container = document.getElementById('correlationGraph');
            
            // For now, show recent event types
            const recentEvents = eventHistory.slice(0, 10);
            const eventTypes = recentEvents.map(e => e.event_type);
            const uniqueTypes = [...new Set(eventTypes)];
            
            container.innerHTML = `
                <div class="small">
                    <strong>Recent Event Types:</strong><br>
                    ${uniqueTypes.map(type => `<span class="badge bg-secondary me-1">${type}</span>`).join('')}
                </div>
            `;
        }
        
        // Update event statistics
        function updateEventStats(event) {
            eventStats.total++;
            
            // Update source counts
            const source = event.source || 'unknown';
            const sourceKey = source.toLowerCase();
            eventStats.sources[sourceKey] = (eventStats.sources[sourceKey] || 0) + 1;
            
            // Update type counts
            const type = event.event_type || 'unknown';
            eventStats.types[type] = (eventStats.types[type] || 0) + 1;
            
            // Update error count
            if (event.status === 'error') {
                eventStats.errors++;
            }
        }
        
        // Start metrics update timer
        function startMetricsUpdate() {
            // Fetch fresh database stats every 30 seconds
            setInterval(() => {
                fetchFreshStats();
            }, 30000);
        }
        
        // Update trend indicators
        function updateTrends() {
            // Simple trend calculation
            const eventsTrend = document.getElementById('eventsTrend');
            const rateTrend = document.getElementById('rateTrend');
            const errorTrend = document.getElementById('errorTrend');
            const devicesTrend = document.getElementById('devicesTrend');
            
            eventsTrend.textContent = `+${eventStats.perMinute}/min`;
            eventsTrend.className = eventStats.perMinute > 0 ? 'metric-trend trend-up' : 'metric-trend trend-down';
            
            rateTrend.textContent = eventStats.perMinute > 5 ? 'High' : eventStats.perMinute > 2 ? 'Normal' : 'Low';
            
            const errorRate = eventStats.total > 0 ? (eventStats.errors / eventStats.total) * 100 : 0;
            errorTrend.textContent = errorRate < 5 ? 'Good' : errorRate < 10 ? 'Warning' : 'Critical';
            errorTrend.className = errorRate < 5 ? 'metric-trend trend-up' : 'metric-trend trend-down';
            
            devicesTrend.textContent = Object.keys(eventStats.sources).length > 0 ? 'Online' : 'Offline';
        }
        
        // Update metrics display
        function updateMetricsDisplay(data) {
            console.log('Updating metrics display with database data:', data);
            
            // Update metrics from database
            if (data.total_events !== undefined) {
                document.getElementById('totalEvents').textContent = data.total_events;
            }
            if (data.events_per_minute !== undefined) {
                document.getElementById('eventsPerMinute').textContent = data.events_per_minute;
            }
            if (data.error_rate !== undefined) {
                document.getElementById('errorRate').textContent = data.error_rate + '%';
            }
            if (data.active_devices !== undefined) {
                document.getElementById('activeDevices').textContent = data.active_devices;
            }
            
            // Update trends based on database data
            const eventsTrend = document.getElementById('eventsTrend');
            const rateTrend = document.getElementById('rateTrend');
            const errorTrend = document.getElementById('errorTrend');
            const devicesTrend = document.getElementById('devicesTrend');
            
            if (data.events_per_minute !== undefined) {
                eventsTrend.textContent = `+${data.events_per_minute}/min`;
                eventsTrend.className = data.events_per_minute > 0 ? 'metric-trend trend-up' : 'metric-trend trend-down';
                
                rateTrend.textContent = data.events_per_minute > 5 ? 'High' : data.events_per_minute > 2 ? 'Normal' : 'Low';
            }
            
            if (data.error_rate !== undefined) {
                errorTrend.textContent = data.error_rate < 5 ? 'Good' : data.error_rate < 10 ? 'Warning' : 'Critical';
                errorTrend.className = data.error_rate < 5 ? 'metric-trend trend-up' : 'metric-trend trend-down';
            }
            
            if (data.active_devices !== undefined) {
                devicesTrend.textContent = data.active_devices > 0 ? 'Online' : 'Offline';
            }
        }
        
        // Toggle streaming
        function toggleStreaming() {
            isStreaming = !isStreaming;
            const icon = document.getElementById('streamingIcon');
            const text = document.getElementById('streamingText');
            
            if (isStreaming) {
                icon.className = 'ti ti-player-pause';
                text.textContent = 'Pause Stream';
            } else {
                icon.className = 'ti ti-player-play';
                text.textContent = 'Resume Stream';
            }
        }
        
        // Clear event stream
        function clearEventStream() {
            document.getElementById('eventStream').innerHTML = '<div class="text-center text-muted">Stream cleared</div>';
            document.getElementById('streamCount').textContent = '0';
            eventHistory = [];
            eventStats = {
                total: 0,
                perMinute: 0,
                errors: 0,
                sources: {},
                types: {},
                timeline: []
            };
            
            // Reset charts
            eventsChart.data.labels = [];
            eventsChart.data.datasets[0].data = [];
            eventsChart.update();
            
            distributionChart.data.datasets[0].data = [0, 0, 0, 0];
            distributionChart.update();
            
            // Reset timeline
            document.getElementById('eventTimeline').innerHTML = '<div class="text-center text-muted">Timeline cleared</div>';
            
            // Reset correlation graph
            document.getElementById('correlationGraph').innerHTML = '<div class="text-center text-muted">Event correlations will appear here</div>';
        }
        
        // Export event data
        function exportEventData() {
            const dataStr = JSON.stringify(eventHistory, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `event-stream-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        // Apply filters
        function applyFilters() {
            const sourceFilter = document.getElementById('sourceFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            // Filter event history
            const filteredEvents = eventHistory.filter(event => {
                const source = event.source || 'unknown';
                if (sourceFilter && source.toLowerCase() !== sourceFilter) return false;
                if (typeFilter && (event.event_type || 'unknown') !== typeFilter) return false;
                if (statusFilter && (event.status || 'info') !== statusFilter) return false;
                return true;
            });
            
            // Update stream display
            const streamContainer = document.getElementById('eventStream');
            streamContainer.innerHTML = '';
            
            filteredEvents.slice(0, 100).forEach(event => {
                const eventElement = createEventElement(event);
                streamContainer.appendChild(eventElement);
            });
            
            document.getElementById('streamCount').textContent = filteredEvents.length;
        }
        
        // Add filter event listeners
        document.getElementById('sourceFilter').addEventListener('change', applyFilters);
        document.getElementById('typeFilter').addEventListener('change', applyFilters);
        document.getElementById('statusFilter').addEventListener('change', applyFilters);
        document.getElementById('timeRangeFilter').addEventListener('change', applyFilters);

        // Recalculate eventStats from eventHistory
        function recalculateEventStats() {
            console.log('Recalculating event stats from', eventHistory.length, 'events');
            eventStats.total = 0;
            eventStats.errors = 0;
            eventStats.perMinute = 0;
            eventStats.sources = {};
            eventStats.types = {};
            const now = Date.now();
            const oneMinuteAgo = now - 60000;
            eventHistory.forEach(event => {
                eventStats.total++;
                const source = event.source ? event.source.toLowerCase() : 'unknown';
                eventStats.sources[source] = (eventStats.sources[source] || 0) + 1;
                const type = event.event_type || 'unknown';
                eventStats.types[type] = (eventStats.types[type] || 0) + 1;
                if (event.status === 'error') eventStats.errors++;
            });
            // Per minute
            eventStats.perMinute = eventHistory.filter(e => new Date(e.timestamp).getTime() > oneMinuteAgo).length;
            console.log('Recalculated eventStats:', eventStats);
        }

        // Fetch fresh database statistics
        async function fetchFreshStats() {
            try {
                const response = await fetch('/api/streaming/stats');
                const data = await response.json();
                
                if (data.success) {
                    updateMetricsDisplay(data.data);
                    updateChartsWithDatabaseData(data.data);
                }
            } catch (error) {
                console.error('Error fetching fresh stats:', error);
            }
        }
        
        // Update charts with database data
        function updateChartsWithDatabaseData(data) {
            // Update events over time chart with real database data
            const now = new Date();
            const labels = eventsChart.data.labels;
            const chartData = eventsChart.data.datasets[0].data;
            
            labels.push(now);
            chartData.push(data.events_per_minute || 0);
            
            // Keep only last 20 data points
            if (labels.length > 20) {
                labels.shift();
                chartData.shift();
            }
            
            eventsChart.update('none');
            
            // Update distribution chart with real source data
            // Backend returns sources as array of objects: [{"source": "AVA4", "count": 123}, ...]
            // Convert to simple object for chart data
            const sourceData = {};
            if (data.sources && Array.isArray(data.sources)) {
                data.sources.forEach(item => {
                    if (item.source && item.count !== undefined) {
                        sourceData[item.source.toLowerCase()] = item.count;
                    }
                });
            }
            
            // Map source names to chart data positions
            distributionChart.data.datasets[0].data = [
                sourceData['ava4'] || 0,
                sourceData['kati'] || sourceData['kati watch'] || 0,
                sourceData['qube'] || sourceData['qube-vital'] || 0,
                sourceData['monitor'] || sourceData['system'] || 0
            ];
            
            console.log('Distribution chart updated with source data:', sourceData);
            distributionChart.update('none');
        }
    </script>
</body>
</html> 